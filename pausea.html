<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="page_title">Potok ‚Äî –û—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–∞—É–∑—ã</title>
  
  <!-- Google tag (gtag.js) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–ï–†–í–´–ú -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-4834XVE45Z', {
    enhanced_measurement: true
  });

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏
  function trackPracticeFullscreenStart() {
    console.log('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å:', '–û—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–∞—É–∑—ã');
    gtag('event', 'fullscreen_practice_start', {
      event_category: 'meditation_practice',
      event_label: 'mindful_pauses_fullscreen',
      practice_type: 'meditation',
      value: 1
    });
  }

  function trackPracticeActualStart() {
    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ù–∞—á–∞—Ç—å"');
    gtag('event', 'practice_actual_start', {
      event_category: 'meditation_engagement',
      event_label: 'mindful_pauses_button_start',
      practice_type: 'meditation',
      value: 1
    });
  }

  function trackCycleCompletion(cycleNumber) {
    console.log('–≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω:', cycleNumber);
    gtag('event', 'meditation_stage_complete', {
      event_category: 'meditation_progress',
      event_label: 'stage_' + cycleNumber,
      practice_type: 'meditation',
      value: cycleNumber
    });
  }

  function trackPracticeCompletion() {
    console.log('–ú–µ–¥–∏—Ç–∞—Ü–∏—è "–û—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–∞—É–∑—ã" –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    gtag('event', 'practice_completed', {
      event_category: 'meditation_success',
      event_label: 'mindful_pauses_full_completion',
      practice_type: 'meditation',
      value: 5
    });
  }

  function trackPracticeExit(exitMethod) {
    console.log('–í—ã—Ö–æ–¥ –∏–∑ –º–µ–¥–∏—Ç–∞—Ü–∏–∏:', exitMethod);
    gtag('event', 'practice_exit', {
      event_category: 'meditation_behavior',
      event_label: exitMethod,
      practice_type: 'meditation',
      value: 1
    });
  }

  function trackAudioEvent(eventType) {
    console.log('–ê—É–¥–∏–æ —Å–æ–±—ã—Ç–∏–µ:', eventType);
    gtag('event', 'audio_' + eventType, {
      event_category: 'meditation_audio',
      event_label: 'mindful_pauses_audio_' + eventType,
      practice_type: 'meditation',
      value: 1
    });
  }

  function trackMeditationPhase(phase, cycleNumber) {
    if (phase === '–í–¥–æ—Ö' && cycleNumber <= 3) {
      console.log('–§–∞–∑–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–∏:', phase, '–≠—Ç–∞–ø:', cycleNumber);
      gtag('event', 'meditation_phase', {
        event_category: 'meditation_detail',
        event_label: phase + '_stage_' + cycleNumber,
        practice_type: 'meditation',
        value: 1
      });
    }
  }

  function trackPracticeEngagement(seconds) {
    console.log('–í—Ä–µ–º—è –≤ –º–µ–¥–∏—Ç–∞—Ü–∏–∏:', seconds, '—Å–µ–∫—É–Ω–¥');
    gtag('event', 'practice_engagement_time', {
      event_category: 'meditation_engagement',
      event_label: seconds + '_seconds',
      practice_type: 'meditation',
      value: seconds
    });
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  let practiceStartTime = Date.now();
  let engagementTracked = {
    30: false,
    60: false,
    120: false
  };
  let lastTrackedCycle = 0;
</script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    
    :root {
      --yellow: #FFD527;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--yellow);
      height: 100vh;
      overflow: hidden;
    }

    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .lang-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    .breathing-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--white);
      text-align: center;
      z-index: 10;
    }

    .cycle-counter {
      position: absolute;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      line-height: 24px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      z-index: 10;
    }

    .completion-message {
      position: absolute;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 10;
      display: none;
    }

    .completion-text {
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--white);
      margin-bottom: 4px;
    }

    .completion-praise {
      font-size: 16px;
      line-height: 24px;
      font-weight: 600;
      color: var(--white);
    }

    .back-button {
      position: fixed;
      top: 24px;
      left: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 32px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      z-index: 20;
      transition: background-color 0.2s;
      cursor: pointer;
      text-decoration: none;
      border: none;
    }

    .back-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-button:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .close-icon {
      width: 16px;
      height: 16px;
      color: var(--white);
    }

    .start-prompt, .pause-prompt, .resume-prompt {
      position: absolute;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 10;
    }

    .start-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 14px;
      line-height: 20px;
      font-weight: 600;
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }
      50% {
        transform: scale(1.05);
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }
    }

    .start-button:hover {
      background-color: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .start-button:active {
      background-color: rgba(255, 255, 255, 0.2);
      transform: scale(0.98);
    }

    .wave {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      transform-origin: center;
      transform: translate(-50%, -50%);
    }
    
    .wave-1 {
      animation: expand 15s ease-in-out infinite;
      animation-delay: 0s;
      animation-play-state: paused;
      background-color: rgba(255, 240, 179, 0.3);
    }
    
    .wave-2 {
      animation: expand 15s ease-in-out infinite;
      animation-delay: 3s;
      animation-play-state: paused;
      background-color: rgba(255, 240, 179, 0.5);
    }
    
    .wave-3 {
      animation: expand 15s ease-in-out infinite;
      animation-delay: 6s;
      animation-play-state: paused;
      background-color: rgba(255, 240, 179, 0.7);
    }
    
    .wave-4 {
      animation: expand 15s ease-in-out infinite;
      animation-delay: 9s;
      animation-play-state: paused;
      background-color: rgba(255, 245, 200, 0.9);
    }
    
    .wave-5 {
      animation: expand 15s ease-in-out infinite;
      animation-delay: 12s;
      animation-play-state: paused;
      background-color: rgba(255, 240, 179, 0.3);
    }

    .wave.started {
      animation-play-state: running;
    }
    
    .dot {
      position: absolute;
      width: 4px;
      height: 4px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
    }
    
    @keyframes expand {
      0% {
        transform: translate(-50%, -50%) scale(5);
        opacity: 0;
      }
      
      30% {
        opacity: 0.5;
      }
      
      100% {
        transform: translate(-50%, -50%) scale(0.1);
        opacity: 0.9;
      }
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∞—É–¥–∏–æ */
    .start-button.preparing {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      pointer-events: none;
      animation: none;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn" id="enBtn">EN</button>
    <button class="lang-btn active" id="ruBtn">RU</button>
  </div>

  <div class="container">
    <!-- –ê—É–¥–∏–æ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º -->
    <audio id="breathingAudio" preload="auto">
      <source id="audioSource" src="mp3/pause_ru.mp3" type="audio/mpeg">
    </audio>

    <button class="back-button" onclick="handleBackButton();" type="button">
      <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="wave wave-1"></div>
    <div class="wave wave-2"></div>
    <div class="wave wave-3"></div>
    <div class="wave wave-4"></div>
    <div class="wave wave-5"></div>
    <div id="dots-container"></div>
    
    <div class="start-prompt" id="startPrompt">
      <button class="start-button" id="startButton">–ù–∞—á–∞—Ç—å</button>
    </div>
    
    <div class="pause-prompt" id="pausePrompt" style="display: none;">
      <button class="start-button" id="pauseButton">–ü–∞—É–∑–∞</button>
    </div>
    
    <div class="resume-prompt" id="resumePrompt" style="display: none;">
      <button class="start-button" id="resumeButton">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
    
    <div class="breathing-text" id="breathingText" style="display: none;">–í–¥–æ—Ö</div>
    <div class="cycle-counter" id="cycleCounter" style="display: none;">–≠—Ç–∞–ø 1 –∏–∑ 5</div>
    <div class="completion-message" id="completionMessage">
      <div class="completion-text">–ú–µ–¥–∏—Ç–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å</div>
      <div class="completion-praise">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</div>
    </div>
  </div>

  <script>
    // Translations
    const translations = {
      ru: {
        page_title: "Potok ‚Äî –û—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–∞—É–∑—ã",
        button_start: "–ù–∞—á–∞—Ç—å",
        button_pause: "–ü–∞—É–∑–∞", 
        button_continue: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
        phase_inhale: "–í–¥–æ—Ö",
        phase_pause: "–ü–∞—É–∑–∞",
        phase_exhale: "–í—ã–¥–æ—Ö",
        stage_counter: "–≠—Ç–∞–ø {stage} –∏–∑ 5",
        meditation_finished: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å",
        great_job: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!",
        preparing: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞..."
      },
      en: {
        page_title: "Potok ‚Äî Mindful Pauses",
        button_start: "Start",
        button_pause: "Pause",
        button_continue: "Continue",
        phase_inhale: "Inhale",
        phase_pause: "Pause",
        phase_exhale: "Exhale",
        stage_counter: "Stage {stage} of 5",
        meditation_finished: "Meditation finished",
        great_job: "Great work!",
        preparing: "Preparing..."
      }
    };

    // Translator class
    class Translator {
      constructor() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞ PAUSEA.HTML...');
        
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        this.currentLang = this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'ru';
        
        console.log(`üåê –í—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: ${this.currentLang}`);
        this.init();
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          console.log(`‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('lang');
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        try {
          return localStorage.getItem('potok_language');
        } catch (error) {
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updateAudioSource();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
        document.title = this.translate('page_title');
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ EN –≤ PAUSEA.HTML');
          this.setLanguage('en');
        });
        
        document.getElementById('ruBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ RU –≤ PAUSEA.HTML');
          this.setLanguage('ru');
        });
      }

      setLanguage(lang) {
        console.log(`üîÑ –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ –Ω–∞: ${lang} –≤ PAUSEA.HTML`);
        
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
          } catch (error) {
            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage: ${error.message}`);
          }
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL: ${error.message}`);
        }
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updateAudioSource();
        document.documentElement.lang = lang;
        document.title = this.translate('page_title');
      }

      updateAudioSource() {
        const audioSource = document.getElementById('audioSource');
        const audio = document.getElementById('breathingAudio');
        
        if (audioSource && audio) {
          const newSrc = `mp3/pause_${this.currentLang}.mp3`;
          console.log(`üéµ –ú–µ–Ω—è–µ–º –∞—É–¥–∏–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞: ${newSrc}`);
          
          audio.pause();
          audio.currentTime = 0;
          audioSource.src = newSrc;
          audio.load();
          
          // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤
          window.isAudioReady = false;
          window.audioStarted = false;
        }
      }

      translate(key, variables = {}) {
        let translation = translations[this.currentLang]?.[key] || translations.ru[key] || key;
        
        Object.keys(variables).forEach(variable => {
          translation = translation.replace(`{${variable}}`, variables[variable]);
        });
        
        return translation;
      }

      updatePage() {
        this.updateDynamicElements();
      }

      updateDynamicElements() {
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const completionText = document.querySelector('.completion-text');
        const completionPraise = document.querySelector('.completion-praise');
        
        if (startButton && !startButton.classList.contains('preparing')) {
          startButton.textContent = this.translate('button_start');
        }
        if (pauseButton) {
          pauseButton.textContent = this.translate('button_pause');
        }
        if (resumeButton) {
          resumeButton.textContent = this.translate('button_continue');
        }
        if (completionText) {
          completionText.textContent = this.translate('meditation_finished');
        }
        if (completionPraise) {
          completionPraise.textContent = this.translate('great_job');
        }
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          const btnLang = btn.id === 'enBtn' ? 'en' : 'ru';
          if (btnLang === this.currentLang) {
            btn.classList.add('active');
          }
        });
      }

      updateStageCounter(stage) {
        const counterElement = document.getElementById('cycleCounter');
        if (counterElement) {
          const translation = this.translate('stage_counter', { stage: stage });
          counterElement.textContent = translation;
        }
      }

      updateBreathingText(phase) {
        const breathingTextElement = document.getElementById('breathingText');
        if (breathingTextElement) {
          const translatedPhase = this.translate(phase);
          breathingTextElement.textContent = translatedPhase;
        }
      }
    }

    // Initialize translator
    window.translator = new Translator();

    // Meditation logic variables
    let startTime = null;
    let currentCycle = 1;
    let isCompleted = false;
    let isStarted = false;
    let isPaused = false;
    let pausedTime = 0;
    let audioStarted = false;
    let isAudioReady = false;
    let userInteracted = false;
    const practicesDuration = 290000; // 4 –º–∏–Ω—É—Ç—ã 50 —Å–µ–∫—É–Ω–¥
    
    // –î–µ–ª–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞
    window.currentCycle = currentCycle;
    window.isAudioReady = isAudioReady;
    window.audioStarted = audioStarted;
    
    const audio = document.getElementById('breathingAudio');
    const startPrompt = document.getElementById('startPrompt');
    const pausePrompt = document.getElementById('pausePrompt');
    const resumePrompt = document.getElementById('resumePrompt');
    const breathingText = document.getElementById('breathingText');
    const cycleCounter = document.getElementById('cycleCounter');
    const completionMessage = document.getElementById('completionMessage');
    const startButton = document.getElementById('startButton');

    // –°–æ–∑–¥–∞–µ–º –±–µ–ª—ã–µ —Ç–æ—á–∫–∏
    const dotsContainer = document.getElementById('dots-container');
    const dotCount = 50;
    
    for (let i = 0; i < dotCount; i++) {
      const dot = document.createElement('div');
      dot.className = 'dot';
      
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      
      dot.style.left = x + 'vw';
      dot.style.top = y + 'vh';
      
      const size = Math.random() * 3 + 2;
      dot.style.width = size + 'px';
      dot.style.height = size + 'px';
      
      const opacity = Math.random() * 0.3 + 0.4;
      dot.style.opacity = opacity;
      
      dotsContainer.appendChild(dot);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
function handleBackButton() {
  const exitMethod = isStarted ? (isCompleted ? 'after_completion' : 'during_practice') : 'before_start';
  trackPracticeExit(exitMethod);
  
  if (audio) {
    audio.pause();
    audio.currentTime = 0;
  }
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º history.back() –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  if (window.history.length > 1) {
    console.log('üîô –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ history.back()');
    window.history.back();
  } else {
    // Fallback –Ω–∞ pond.html –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏
    const currentLang = window.translator ? window.translator.currentLang : 'ru';
    console.log(`üîô Fallback: –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ pond.html —Å —è–∑—ã–∫–æ–º: ${currentLang}`);
    window.location.href = `pond.html?lang=${currentLang}`;
  }
}

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
    function checkAudioReady() {
      return new Promise((resolve) => {
        if (audio.readyState >= 2) {
          console.log('–ê—É–¥–∏–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ, readyState:', audio.readyState);
          isAudioReady = true;
          window.isAudioReady = true;
          resolve(true);
          return;
        }

        let resolved = false;
        
        const onReady = (eventName) => {
          if (resolved) return;
          resolved = true;
          
          console.log('–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ:', eventName);
          isAudioReady = true;
          window.isAudioReady = true;
          
          audio.removeEventListener('canplay', onCanPlay);
          audio.removeEventListener('canplaythrough', onCanPlayThrough);
          audio.removeEventListener('loadeddata', onLoadedData);
          
          resolve(true);
        };

        const onCanPlay = () => onReady('canplay');
        const onCanPlayThrough = () => onReady('canplaythrough');
        const onLoadedData = () => onReady('loadeddata');

        audio.addEventListener('canplay', onCanPlay);
        audio.addEventListener('canplaythrough', onCanPlayThrough);
        audio.addEventListener('loadeddata', onLoadedData);
        
        try {
          audio.load();
        } catch (e) {
          console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ:', e);
        }
        
        setTimeout(() => {
          if (resolved) return;
          resolved = true;
          
          audio.removeEventListener('canplay', onCanPlay);
          audio.removeEventListener('canplaythrough', onCanPlayThrough);
          audio.removeEventListener('loadeddata', onLoadedData);
          
          console.warn('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ');
          isAudioReady = true;
          window.isAudioReady = true;
          resolve(true);
        }, 5000);
      });
    }

    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∞—É–¥–∏–æ
    audio.addEventListener('loadeddata', () => {
      console.log('–ê—É–¥–∏–æ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      trackAudioEvent('loaded');
      isAudioReady = true;
      window.isAudioReady = true;
    });

    audio.addEventListener('play', () => {
      console.log('–ê—É–¥–∏–æ –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
      audioStarted = true;
      window.audioStarted = true;
      trackAudioEvent('started');
    });

    audio.addEventListener('error', (e) => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', e);
      trackAudioEvent('error');
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏
    async function startPractice() {
  if (isStarted || !userInteracted) return;
  
  startButton.textContent = window.translator.translate('preparing');
  startButton.classList.add('preparing');
  
  try {
    await checkAudioReady();
    
    isStarted = true;
    startTime = Date.now();
    
    trackPracticeActualStart();
    
    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ó–ê–ü–ò–°–¨ –ü–†–ê–ö–¢–ò–ö–ò –ó–î–ï–°–¨
    if (window.practiceStreakManager) {
      await window.practiceStreakManager.recordPractice('pause');
      console.log('üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ "pause" –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ streak!');
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–∏–º–∞—Ü–∏—é (–ë–ï–ó —Ç–µ–∫—Å—Ç–∞ –¥—ã—Ö–∞–Ω–∏—è –∏ —Å—á–µ—Ç—á–∏–∫–∞ —ç—Ç–∞–ø–æ–≤)
    startPrompt.style.display = 'none';
    pausePrompt.style.display = 'block';
    
    // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–æ–ª–Ω
    const waves = document.querySelectorAll('.wave');
    waves.forEach(wave => {
      wave.classList.add('started');
    });
    
    // –ó–∞–ø—É—Å–∫ –∞—É–¥–∏–æ
    await tryStartAudio();
    
    console.log('–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏:', error);
    
    startButton.textContent = window.translator.translate('button_start');
    startButton.classList.remove('preparing');
  }
}

    function pausePractice() {
      if (!isStarted || isPaused) return;
      
      console.log('–°—Ç–∞–≤–∏–º –º–µ–¥–∏—Ç–∞—Ü–∏—é –Ω–∞ –ø–∞—É–∑—É');
      isPaused = true;
      pausedTime = Date.now() - startTime;
      
      pausePrompt.style.display = 'none';
      resumePrompt.style.display = 'block';
      
      const waves = document.querySelectorAll('.wave');
      waves.forEach(wave => {
        wave.style.animationPlayState = 'paused';
      });
      
      if (audio && !audio.paused) {
        audio.pause();
      }
    }

    async function resumePractice() {
      if (!isStarted || !isPaused) return;
      
      isPaused = false;
      startTime = Date.now() - pausedTime;
      
      resumePrompt.style.display = 'none';
      pausePrompt.style.display = 'block';
      
      const waves = document.querySelectorAll('.wave');
      waves.forEach(wave => {
        wave.style.animationPlayState = 'running';
      });
      
      if (audio && audio.paused) {
        try {
          await audio.play();
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ:', e);
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ
    async function tryStartAudio() {
      if (audioStarted) return;
      
      try {
        console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–¥–∏–æ, readyState:', audio.readyState);
        
        audio.currentTime = 0;
        
        if (audio.readyState < 2) {
          console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ...');
          audio.load();
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        await audio.play();
        
        audioStarted = true;
        window.audioStarted = true;
        console.log('–ê—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ:', error);
        
        setTimeout(async () => {
          try {
            await audio.play();
            audioStarted = true;
            window.audioStarted = true;
          } catch (e) {
            console.error('–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', e);
          }
        }, 1000);
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
    function trackEngagementTime() {
      if (!isStarted || isCompleted || isPaused) return;
      
      const timeSpent = Math.round((Date.now() - practiceStartTime) / 1000);
      
      Object.keys(engagementTracked).forEach(seconds => {
        if (timeSpent >= seconds && !engagementTracked[seconds]) {
          engagementTracked[seconds] = true;
          trackPracticeEngagement(parseInt(seconds));
        }
      });
    }
    
    function updateBreathingText() {
      if (!isStarted || isCompleted || isPaused) return;
      
      const cycleDuration = 16000;
      const totalElapsed = Date.now() - startTime;
      const elapsed = totalElapsed % cycleDuration;
      
      const newCycle = Math.floor(totalElapsed / cycleDuration) + 1;
      
      if (newCycle !== currentCycle && newCycle <= 5) {
        if (currentCycle > lastTrackedCycle) {
          trackCycleCompletion(currentCycle);
          lastTrackedCycle = currentCycle;
        }
        currentCycle = newCycle;
        window.currentCycle = currentCycle;
        window.translator.updateStageCounter(currentCycle);
      }
      
      if (totalElapsed >= practicesDuration) {
        if (!isCompleted) {
          isCompleted = true;
          
          if (currentCycle > lastTrackedCycle) {
            trackCycleCompletion(5);
          }
          trackPracticeCompletion();
          
          pausePrompt.style.display = 'none';
          resumePrompt.style.display = 'none';
          completionMessage.style.display = 'block';
          
          audio.pause();
          audio.currentTime = 0;
        }
        return;
      }
      
      // –£–±–∏—Ä–∞–µ–º –≤–µ—Å—å –±–ª–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥—ã—Ö–∞–Ω–∏—è - –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
      if (currentPhase === 'phase_inhale' && elapsed < 1000) {
        trackMeditationPhase(window.translator.translate('phase_inhale'), currentCycle);
      }
    }

    // –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    function handleUserInteraction(event) {
      event.preventDefault();
      event.stopPropagation();
      
      console.log('handleUserInteraction –≤—ã–∑–≤–∞–Ω, isStarted:', isStarted);
      
      if (!userInteracted) {
        userInteracted = true;
        console.log('–ü–µ—Ä–≤–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ');
      }
      
      if (!isStarted) {
        console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∞–∫—Ç–∏–∫—É');
        startPractice();
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (startButton) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º click –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏
      startButton.addEventListener('click', handleUserInteraction);
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ touchend –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
      startButton.addEventListener('touchend', handleUserInteraction);
    }

    const pauseButton = document.getElementById('pauseButton');
    if (pauseButton) {
      pauseButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        pausePractice();
      });
      pauseButton.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        pausePractice();
      });
    }

    const resumeButton = document.getElementById('resumeButton');
    if (resumeButton) {
      resumeButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        resumePractice();
      });
      resumeButton.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        resumePractice();
      });
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function gameLoop() {
      updateBreathingText();
      trackEngagementTime();
      requestAnimationFrame(gameLoop);
    }

    // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', async () => {
      console.log('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      
      if (typeof gtag !== 'undefined') {
        trackPracticeFullscreenStart();
      }
      
      gameLoop();
      completionMessage.style.display = 'none';
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ
      console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞—É–¥–∏–æ...');
      audio.load();
      
      setTimeout(async () => {
        try {
          await checkAudioReady();
          
          if (isAudioReady && startButton) {
            startButton.textContent = window.translator.translate('button_start');
            startButton.classList.remove('preparing');
          }
          
        } catch (error) {
          console.warn('–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∞—É–¥–∏–æ:', error);
        }
      }, 500);
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Ö–æ–¥–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
      if (isStarted && !isCompleted) {
        trackPracticeExit('page_unload');
      }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üîÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –≥–æ—Ç–æ–≤');
    });
  </script>
<!-- Firebase SDK v9 -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
  
  // –î–µ–ª–∞–µ–º Firebase –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
  window.firebaseApp = null;
  window.firebaseDb = null;
  window.firebaseApi = { doc, getDoc, setDoc };
  
  // Firebase Configuration –¥–ª—è spokspacebot
  const firebaseConfig = {
    apiKey: "AIzaSyDB1ePgeJVXB_Qcy0UZDIKHA8i1GpOOQAU",
    authDomain: "spokspacebot.firebaseapp.com",
    projectId: "spokspacebot",
    storageBucket: "spokspacebot.firebasestorage.app",
    messagingSenderId: "545573700538",
    appId: "1:545573700538:web:efa309ffbe902cab081383"
  };

  try {
    window.firebaseApp = initializeApp(firebaseConfig);
    window.firebaseDb = getFirestore(window.firebaseApp);
    console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ pausea');
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Firebase
    window.dispatchEvent(new CustomEvent('firebaseReady'));
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
  }
</script>

<!-- Streak Manager –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∞–∫—Ç–∏–∫–∏ -->
<script>
  // Simplified StreakManager –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∞–∫—Ç–∏–∫
  class PracticeStreakManager {
    constructor(userId, language = 'ru') {
      this.userId = userId;
      this.language = language;
      this.streak = 0;
      this.lastPracticeDate = null;
      this.startDate = null;
      this.practices = ['pond', 'pause', 'body', '478', '505', '4444', 'stars', 'place'];
      this.useFirebase = false;
      this.storageKey = `potok_streak_${this.userId}`;
      this.isFirstLaunch = true;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
      this.localStorageAvailable = this.checkLocalStorageAvailability();
      
      // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
      if (window.firebaseDb) {
        this.useFirebase = true;
      } else {
        window.addEventListener('firebaseReady', () => {
          this.useFirebase = true;
          console.log('üîÑ Firebase –≥–æ—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∞–∫—Ç–∏–∫–∏');
        });
      }
    }

    checkLocalStorageAvailability() {
      try {
        const testKey = 'test_storage_' + Date.now();
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (error) {
        return false;
      }
    }

    async loadStreak() {
      try {
        let streakData = null;
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firebase
        if (this.useFirebase && window.firebaseDb) {
          streakData = await this.loadFromFirebase();
        }
        
        // Fallback –Ω–∞ localStorage
        if (!streakData && this.localStorageAvailable) {
          streakData = this.loadFromLocalStorage();
        }
        
        if (streakData) {
          this.streak = streakData.streak || 0;
          this.lastPracticeDate = streakData.lastPracticeDate;
          this.startDate = streakData.startDate;
          this.isFirstLaunch = streakData.isFirstLaunch ?? false;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å streak
          const needsReset = this.checkIfNeedsReset();
          if (needsReset) {
            this.resetStreak();
            await this.saveStreak();
          }
        } else {
          // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
          this.isFirstLaunch = true;
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ streak –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ pausea:', error);
      }
    }

    async loadFromFirebase() {
      try {
        const { doc, getDoc } = window.firebaseApi;
        const docRef = doc(window.firebaseDb, 'telegram_users', this.userId.toString());
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          console.log('‚úÖ Streak –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ Firebase –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ pausea');
          return docSnap.data();
        }
        return null;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
        return null;
      }
    }

    loadFromLocalStorage() {
      try {
        const data = localStorage.getItem(this.storageKey);
        if (data) {
          console.log('‚úÖ Streak –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ pausea');
          return JSON.parse(data);
        }
        return null;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
        return null;
      }
    }

    checkIfNeedsReset() {
      if (!this.lastPracticeDate) return false;
      
      const today = new Date().toDateString();
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
      
      return this.lastPracticeDate !== today && this.lastPracticeDate !== yesterday;
    }

    resetStreak() {
      this.streak = 0;
      this.lastPracticeDate = null;
      this.startDate = null;
    }

    async saveStreak() {
      const streakData = {
        streak: this.streak,
        lastPracticeDate: this.lastPracticeDate,
        startDate: this.startDate,
        lastUpdate: new Date().toISOString(),
        userId: this.userId,
        isFirstLaunch: this.isFirstLaunch
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
      if (this.useFirebase && window.firebaseDb) {
        await this.saveToFirebase(streakData);
      }
      
      // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ backup
      if (this.localStorageAvailable) {
        this.saveToLocalStorage(streakData);
      }
    }

    async saveToFirebase(streakData) {
      try {
        const { doc, setDoc } = window.firebaseApi;
        const docRef = doc(window.firebaseDb, 'telegram_users', this.userId.toString());
        
        await setDoc(docRef, {
          ...streakData,
          totalPractices: (streakData.totalPractices || 0) + 1
        }, { merge: true });
        
        console.log('‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã pausea:', this.streak);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
      }
    }

    saveToLocalStorage(streakData) {
      try {
        localStorage.setItem(this.storageKey, JSON.stringify(streakData));
        console.log('‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã pausea:', this.streak);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
      }
    }

    async recordPractice(practiceType) {
      if (!this.practices.includes(practiceType)) {
        console.log('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–∞–∫—Ç–∏–∫–∏:', practiceType);
        return;
      }

      const today = new Date().toDateString();
      
      // –ï—Å–ª–∏ —É–∂–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (this.lastPracticeDate === today) {
        console.log('üí° –ü—Ä–∞–∫—Ç–∏–∫–∞ —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
      
      if (this.streak === 0 || this.lastPracticeDate === yesterday) {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º streak
        this.streak += 1;
        this.lastPracticeDate = today;
        
        if (!this.startDate) {
          this.startDate = today;
        }
      } else {
        // Streak –ø—Ä–µ—Ä–≤–∞–ª—Å—è, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
        this.streak = 1;
        this.lastPracticeDate = today;
        this.startDate = today;
      }

      // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ —ç—Ç–æ —É–∂–µ –Ω–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
      this.isFirstLaunch = false;

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 90 –¥–Ω–µ–π
      if (this.streak > 90) {
        this.streak = 90;
      }

      await this.saveStreak();
      
      console.log(`üî• –ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã pausea! Streak: ${this.streak} –¥–Ω–µ–π`);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      this.showStreakNotification(this.streak);
    }

    showStreakNotification(days) {
      // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ streak
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(52, 168, 83, 0.95);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      
      if (days === 1) {
        notification.textContent = `üî• Streak: ${days} –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥!`;
      } else if (days < 5) {
        notification.textContent = `üî• Streak: ${days} –¥–Ω—è –ø–æ–¥—Ä—è–¥!`;
      } else {
        notification.textContent = `üî• Streak: ${days} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥!`;
      }
      
      document.body.appendChild(notification);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      setTimeout(() => {
        notification.style.opacity = '1';
      }, 100);
      
      // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    getUserId() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram Web App
      const tg = window.Telegram?.WebApp;
      const user = tg?.initDataUnsafe?.user;
      
      if (user && user.id) {
        return user.id;
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      let devUserId = null;
      try {
        devUserId = localStorage.getItem('potok_dev_user_id');
        if (!devUserId) {
          devUserId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('potok_dev_user_id', devUserId);
        }
      } catch (error) {
        devUserId = 'dev_' + Date.now();
      }
      
      return devUserId;
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è streak manager –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ pausea
  document.addEventListener('DOMContentLoaded', () => {
    // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä streak manager
    const userId = new PracticeStreakManager().getUserId();
    const language = window.translator ? window.translator.currentLang : 'ru';
    
    window.practiceStreakManager = new PracticeStreakManager(userId, language);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π streak
    window.practiceStreakManager.loadStreak();
    
    console.log(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ pausea –∑–∞–≥—Ä—É–∂–µ–Ω–∞, User ID: ${userId}`);
  });
</script>
</body>
</html>
