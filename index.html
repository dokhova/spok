<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#19191B" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title data-translate="page_title">Potok ‚Äî Home</title>
  
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4834XVE45Z', {
      custom_map: {
        'custom_parameter_1': 'telegram_user_id',
        'custom_parameter_2': 'practice_type'
      }
    });
  </script>
  
  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  
  <!-- Telegram Analytics SDK -->
  <script async src="https://tganalytics.xyz/index.js" onload="initTelegramAnalytics()" type="text/javascript"></script>
  
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SDK
    window.telegramAnalyticsReady = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Analytics SDK
    function initTelegramAnalytics() {
      if (window.telegramAnalytics) {
        try {
          window.telegramAnalytics.init({
            token: 'eyJhcHBfbmFtZSI6InNwb2tzcGFjZV9taW5pYXBwIiwiYXBwX3VybCI6Imh0dHBzOi8vdC5tZS9zcG9rc3BhY2Vib3QiLCJhcHBfZG9tYWluIjoiaHR0cHM6Ly9zcG9rc3BhY2UuY29tIn0=!0dbi7xO0ICzOMI4+U3XMZslcn6F0JvCFfyoLVp4K8+0=',
            appName: 'spokspace_miniapp'
          });
          window.telegramAnalyticsReady = true;
          console.log('‚úÖ Telegram Analytics SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
          
          if (window.pendingAnalyticsEvents && window.pendingAnalyticsEvents.length > 0) {
            window.pendingAnalyticsEvents.forEach(({eventName, parameters}) => {
              trackEvent(eventName, parameters);
            });
            window.pendingAnalyticsEvents = [];
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Analytics SDK:', error);
        }
      }
    }

    window.pendingAnalyticsEvents = [];

    function trackEvent(eventName, parameters = {}) {
      if (!window.telegramAnalyticsReady) {
        window.pendingAnalyticsEvents.push({eventName, parameters});
        return;
      }

      if (window.telegramAnalytics && typeof window.telegramAnalytics.track === 'function') {
        try {
          window.telegramAnalytics.track(eventName, parameters);
          console.log('üìä Telegram Analytics event:', eventName, parameters);
        } catch (error) {
          console.error('‚ùå Telegram Analytics track error:', error);
        }
      }

      if (typeof gtag !== 'undefined') {
        gtag('event', eventName, {
          event_category: 'telegram_mini_app',
          event_label: parameters.practice_type || 'unknown',
          custom_parameter_1: parameters.user_id,
          custom_parameter_2: parameters.practice_type,
          value: 1
        });
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function trackEmotionSet(emotion, date) {
      console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —ç–º–æ—Ü–∏—è:', emotion, '–Ω–∞ –¥–∞—Ç—É:', date);
      trackEvent('emotion_set_home', {
        emotion: emotion,
        date: date,
        source: 'home_calendar'
      });
    }

    function trackEmotionRemove(emotion, date) {
      console.log('–£–¥–∞–ª–µ–Ω–∞ —ç–º–æ—Ü–∏—è:', emotion, '—Å –¥–∞—Ç—ã:', date);
      trackEvent('emotion_remove_home', {
        emotion: emotion,
        date: date,
        source: 'home_calendar'
      });
    }
  </script>
  
  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
      
      --emotion-joyful: #34A853;
      --emotion-good: #5CDE6D;
      --emotion-so-so: #FFD527;
      --emotion-anxious: #FF7DB0;
      --emotion-sad: #4285F4;
      --emotion-bad: #E74639;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    h1, h2, h3, h4, h5, h6, p {
      margin: 0;
      padding: 0;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 163.5px);
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(25, 25, 27, 0.95);
      backdrop-filter: blur(10px);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 425px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .home {
      max-width: 375px;
      margin: 0 auto;
      padding: 96px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      padding-bottom: 96px;
      box-sizing: border-box;
    }

    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .home {
        padding-bottom: calc(96px + env(safe-area-inset-bottom) + 20px);
      }
    }

    /* –•–µ–¥–µ—Ä —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º/–∞–≤–∞—Ç–∞—Ä–æ–º */
    .logo {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      background-color: var(--main);
      padding: 24px;
      box-sizing: border-box;
    }

    .logo img {
      height: 33px;
      width: auto;
      display: block;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      display: block;
      border-radius: 50%;
    }

    .avatar-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-2);
    }

    .user-name {
      font-size: 18px;
      line-height: 24px;
      font-weight: 500;
      color: var(--white);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–ª–æ–∫ */
    .header {
      max-width: 327px;
      width: 100%;
      margin: 0 auto 48px auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .text-welcome {
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
      color: var(--text-2);
    }

    .text-title {
      font-size: 24px;
      line-height: 32px;
      font-weight: 700;
      color: var(--white);
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å */
    .calendar-section {
      margin-bottom: 48px;
      position: relative;
      z-index: 1;
    }

    .compact-calendar {
      width: 100%;
      max-width: 327px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }

    .current-month {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 10px;
      font-weight: 500;
      color: var(--text-2);
      padding: 4px 0;
    }

    .calendar-days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 400;
      color: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      min-height: 32px;
    }

    .calendar-day:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }

    .calendar-day.today {
      border: 2px solid var(--green);
      border-radius: 50%;
      animation: todayPulse 2s ease-in-out infinite;
    }

    @keyframes todayPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 6px rgba(52, 168, 83, 0.1);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(52, 168, 83, 0);
      }
    }

    .calendar-day.has-emotion {
      border: 2px solid transparent;
      border-radius: 50%;
    }

    .calendar-day.has-emotion:hover {
      border-radius: 50%;
    }

    .calendar-day.future-date {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-day.future-date:hover {
      background-color: transparent;
    }

    .calendar-day.emotion-joyful { background-color: var(--emotion-joyful); }
    .calendar-day.emotion-good { background-color: var(--emotion-good); }
    .calendar-day.emotion-so-so { background-color: var(--emotion-so-so); color: var(--main); }
    .calendar-day.emotion-anxious { background-color: var(--emotion-anxious); }
    .calendar-day.emotion-sad { background-color: var(--emotion-sad); }
    .calendar-day.emotion-bad { background-color: var(--emotion-bad); }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–º–æ—Ü–∏–π */
    .emotion-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .emotion-modal.active {
      display: flex;
    }

    .emotion-picker {
      background-color: var(--main);
      border-radius: 16px;
      padding: 24px 20px 20px 20px;
      max-width: 280px;
      width: 85%;
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .emotion-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .emotion-picker-date {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .emotion-picker-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
      line-height: 1.2;
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 8px;
      margin: -8px -8px -8px 8px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 18px;
      line-height: 1;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }

    .emotions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 0;
    }

    .emotion-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 16px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      background-color: rgba(255, 255, 255, 0.03);
    }

    .emotion-option:hover {
      background-color: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .emotion-option:active {
      transform: translateY(0);
    }

    .emotion-color {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .emotion-option:hover .emotion-color {
      transform: scale(1.1);
    }

    .emotion-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--white);
      text-align: center;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .cards {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-bottom: 24px;
      position: relative;
      z-index: 1;
    }

    .card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 327px;
      height: 80px;
      margin: 0 auto;
      box-sizing: border-box;
      padding-right: 16px;
      transition: background-color 0.2s;
    }

    .card:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .card img:first-child {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px 0 0 8px;
      flex-shrink: 0;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex: 1;
      margin-left: 24px;
      gap: 0px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      color: var(--white);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-2);
      line-height: 16px;
    }

    .card .arrow {
      width: 5px;
      height: 10px;
      margin-left: 16px;
    }

    /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      padding-bottom: calc(12px + 20px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <div class="home">
    <!-- –õ–æ–≥–æ—Ç–∏–ø –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –∞–≤–∞—Ç–∞—Ä –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ JavaScript -->
    <div class="logo" id="headerLogo">
      <img src="img/logo.svg" alt="Potok logo">
    </div>

    <div class="header">
      <div class="text-welcome" data-translate="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
      <div class="text-title" data-translate="feeling_question">–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</div>
    </div>

    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div class="calendar-section">
      <div class="compact-calendar">
        <div class="calendar-header">
          <div class="current-month" id="currentMonth">–ò—é–Ω—å 2025</div>
        </div>

        <div class="calendar-weekdays">
          <div class="calendar-weekday" data-translate="monday_short">–ü–Ω</div>
          <div class="calendar-weekday" data-translate="tuesday_short">–í—Ç</div>
          <div class="calendar-weekday" data-translate="wednesday_short">–°—Ä</div>
          <div class="calendar-weekday" data-translate="thursday_short">–ß—Ç</div>
          <div class="calendar-weekday" data-translate="friday_short">–ü—Ç</div>
          <div class="calendar-weekday" data-translate="saturday_short">–°–±</div>
          <div class="calendar-weekday" data-translate="sunday_short">–í—Å</div>
        </div>

        <div class="calendar-days-grid" id="calendarDaysGrid">
          <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div class="cards">
      <a href="pause.html" class="card">
        <img src="img/mind.jpg" alt="Calm thoughts">
        <div class="card-content">
          <div class="card-title" data-translate="calm_thoughts">–£—Å–ø–æ–∫–æ–∏—Ç—å –º—ã—Å–ª–∏</div>
          <div class="card-subtitle" data-translate="meditation_duration">–ú–µ–¥–∏—Ç–∞—Ü–∏—è</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="478.html" class="card">
        <img src="img/breathing.jpg" alt="Reduce stress">
        <div class="card-content">
          <div class="card-title" data-translate="reduce_stress">–°–Ω–∏–∑–∏—Ç—å —Å—Ç—Ä–µ—Å—Å</div>
          <div class="card-subtitle" data-translate="breathing_duration">–î—ã—Ö–∞–Ω–∏–µ</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="stars.html" class="card">
        <img src="img/sleep.jpg" alt="Improve sleep">
        <div class="card-content">
          <div class="card-title" data-translate="improve_sleep">–£–ª—É—á—à–∏—Ç—å —Å–æ–Ω</div>
          <div class="card-subtitle" data-translate="sleep_duration">–°–æ–Ω</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —ç–º–æ—Ü–∏–π -->
  <div class="emotion-modal" id="emotionModal">
    <div class="emotion-picker">
      <div class="emotion-picker-header">
        <div>
          <div class="emotion-picker-date" id="selectedDateText">–í–¢–û–†–ù–ò–ö, 3 –ò–Æ–ù–Ø 2025 –ì.</div>
        </div>
        <button class="close-button" id="closeModal">‚úï</button>
      </div>
      
      <div class="emotions-grid">
        <div class="emotion-option" data-emotion="joyful">
          <div class="emotion-color" style="background-color: var(--emotion-joyful);"></div>
          <div class="emotion-name" data-translate="emotion_joyful">–†–∞–¥–æ—Å—Ç–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="good">
          <div class="emotion-color" style="background-color: var(--emotion-good);"></div>
          <div class="emotion-name" data-translate="emotion_good">–•–æ—Ä–æ—à–æ</div>
        </div>
        <div class="emotion-option" data-emotion="so-so">
          <div class="emotion-color" style="background-color: var(--emotion-so-so);"></div>
          <div class="emotion-name" data-translate="emotion_so_so">–¢–∞–∫ —Å–µ–±–µ</div>
        </div>
        <div class="emotion-option" data-emotion="anxious">
          <div class="emotion-color" style="background-color: var(--emotion-anxious);"></div>
          <div class="emotion-name" data-translate="emotion_anxious">–¢—Ä–µ–≤–æ–∂–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="sad">
          <div class="emotion-color" style="background-color: var(--emotion-sad);"></div>
          <div class="emotion-name" data-translate="emotion_sad">–ì—Ä—É—Å—Ç–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="bad">
          <div class="emotion-color" style="background-color: var(--emotion-bad);"></div>
          <div class="emotion-name" data-translate="emotion_bad">–ü–ª–æ—Ö–æ</div>
        </div>
      </div>
    </div>
  </div>

  <footer class="tab-bar">
    <a href="index.html" class="tab active">
      <img src="img/home-active.svg" alt="Today">
      <div data-translate="today">–°–µ–≥–æ–¥–Ω—è</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="practices">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>
    </a>
    <a href="journal.html" class="tab">
      <img src="img/journal.svg" alt="Journal">
      <div data-translate="journal">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    </a>
  </footer>

  <script>
    // Firebase Configuration (—Ç–æ—Ç –∂–µ —á—Ç–æ –∏ –≤ journal.html)
    const firebaseConfig = {
      apiKey: "AIzaSyBtmTRKNwiOUoqqzzgsWGwNhoRK4a38hls",
      authDomain: "spokspace-calendar.firebaseapp.com",
      projectId: "spokspace-calendar",
      storageBucket: "spokspace-calendar.firebasestorage.app",
      messagingSenderId: "285027675276",
      appId: "1:285027675276:web:9bf7ff69a74b9eecca5fa9",
      measurementId: "G-QS4304BN1X"
    };

    // –ü–µ—Ä–µ–≤–æ–¥—ã —Å –ù–û–í–´–ú–ò –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    const translations = {
      en: {
        page_title: "Potok ‚Äî Home",
        welcome: "Welcome!",
        feeling_question: "How are you feeling?",
        calm_thoughts: "Calm thoughts",
        reduce_stress: "Reduce stress", 
        improve_sleep: "Improve sleep",
        meditation_duration: "Meditation",
        breathing_duration: "Breathing",
        sleep_duration: "Sleep",
        today: "Today",
        practices: "Practices",
        journal: "Calendar",
        how_feeling: "How are you feeling?",
        emotion_joyful: "Joyful",
        emotion_good: "Good",
        emotion_so_so: "So-so",
        emotion_anxious: "Anxious", 
        emotion_sad: "Sad",
        emotion_bad: "Bad",
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ
        monday_short: "Mon",
        tuesday_short: "Tue",
        wednesday_short: "Wed",
        thursday_short: "Thu",
        friday_short: "Fri",
        saturday_short: "Sat",
        sunday_short: "Sun",
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –¥–∞—Ç—ã
        sunday_full: "SUNDAY",
        monday_full: "MONDAY",
        tuesday_full: "TUESDAY", 
        wednesday_full: "WEDNESDAY",
        thursday_full: "THURSDAY",
        friday_full: "FRIDAY",
        saturday_full: "SATURDAY",
        // –ú–µ—Å—è—Ü—ã
        january: "January",
        february: "February",
        march: "March",
        april: "April",
        may: "May",
        june: "June",
        july: "July",
        august: "August",
        september: "September",
        october: "October",
        november: "November",
        december: "December"
      },
      ru: {
        page_title: "–ü–æ—Ç–æk ‚Äî –ì–ª–∞–≤–Ω–∞—è",
        welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        feeling_question: "–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?",
        calm_thoughts: "–£—Å–ø–æ–∫–æ–∏—Ç—å –º—ã—Å–ª–∏",
        reduce_stress: "–°–Ω–∏–∑–∏—Ç—å —Å—Ç—Ä–µ—Å—Å",
        improve_sleep: "–£–ª—É—á—à–∏—Ç—å —Å–æ–Ω", 
        meditation_duration: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è",
        breathing_duration: "–î—ã—Ö–∞–Ω–∏–µ",
        sleep_duration: "–°–æ–Ω",
        today: "–°–µ–≥–æ–¥–Ω—è",
        practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏", 
        journal: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å",
        how_feeling: "–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?",
        emotion_joyful: "–†–∞–¥–æ—Å—Ç–Ω–æ",
        emotion_good: "–•–æ—Ä–æ—à–æ", 
        emotion_so_so: "–¢–∞–∫ —Å–µ–±–µ",
        emotion_anxious: "–¢—Ä–µ–≤–æ–∂–Ω–æ",
        emotion_sad: "–ì—Ä—É—Å—Ç–Ω–æ",
        emotion_bad: "–ü–ª–æ—Ö–æ",
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ
        monday_short: "–ü–Ω",
        tuesday_short: "–í—Ç",
        wednesday_short: "–°—Ä",
        thursday_short: "–ß—Ç",
        friday_short: "–ü—Ç",
        saturday_short: "–°–±",
        sunday_short: "–í—Å",
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –¥–∞—Ç—ã
        sunday_full: "–í–û–°–ö–†–ï–°–ï–ù–¨–ï",
        monday_full: "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", 
        tuesday_full: "–í–¢–û–†–ù–ò–ö",
        wednesday_full: "–°–†–ï–î–ê",
        thursday_full: "–ß–ï–¢–í–ï–†–ì",
        friday_full: "–ü–Ø–¢–ù–ò–¶–ê",
        saturday_full: "–°–£–ë–ë–û–¢–ê",
        // –ú–µ—Å—è—Ü—ã
        january: "–Ø–Ω–≤–∞—Ä—å",
        february: "–§–µ–≤—Ä–∞–ª—å",
        march: "–ú–∞—Ä—Ç",
        april: "–ê–ø—Ä–µ–ª—å",
        may: "–ú–∞–π",
        june: "–ò—é–Ω—å",
        july: "–ò—é–ª—å",
        august: "–ê–≤–≥—É—Å—Ç",
        september: "–°–µ–Ω—Ç—è–±—Ä—å",
        october: "–û–∫—Ç—è–±—Ä—å",
        november: "–ù–æ—è–±—Ä—å",
        december: "–î–µ–∫–∞–±—Ä—å"
      }
    };

    // DateUtils –∫–ª–∞—Å—Å –∏–∑ journal.html
    class DateUtils {
      static getUserTimezone() {
        try {
          return Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:', error);
          return 'UTC';
        }
      }

      static getCurrentDateInUserTimezone() {
        const timezone = this.getUserTimezone();
        console.log(`üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${timezone}`);
        
        try {
          const now = new Date();
          const userDate = new Date(now.toLocaleString("en-US", {timeZone: timezone}));
          console.log(`üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userDate.toDateString()}`);
          return userDate;
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è:', error);
          return new Date();
        }
      }

      static isTodayInUserTimezone(date) {
        const today = this.getCurrentDateInUserTimezone();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
      }
    }

    // Firebase Service –∏–∑ journal.html (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
    class FirebaseService {
      constructor() {
        this.app = null;
        this.db = null;
        this.auth = null;
        this.isOnline = false;
        this.userId = null;
        this.isInitialized = false;
        this.isFirebaseReady = false;
        
        this.STORAGE_KEYS = {
          USER_ID: 'potok_stable_user_id',
          EMOTIONS: 'potok_emotions_data',
          LAST_SYNC: 'potok_last_sync'
        };
        
        this.userId = this.generateStableUserId();
        this.isInitialized = true;
        this.initFirebaseInBackground();
      }

      generateStableUserId() {
        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp?.initDataUnsafe?.user?.id) {
          const telegramId = `tg_${window.Telegram.WebApp.initDataUnsafe.user.id}`;
          console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID:', telegramId);
          return telegramId;
        }

        try {
          const savedId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          if (savedId) {
            console.log('üíæ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID:', savedId);
            return savedId;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', error);
        }

        const newId = `stable_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        try {
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, newId);
          console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID:', newId);
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –≤ localStorage');
        }
        
        return newId;
      }

      async initFirebaseInBackground() {
        try {
          console.log('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –≤ —Ñ–æ–Ω–µ...');
          
          this.app = firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          
          try {
            await this.db.enablePersistence({ synchronizeTabs: true });
            console.log('üíæ Offline persistence –≤–∫–ª—é—á–µ–Ω');
          } catch (err) {
            console.log('‚ö†Ô∏è Persistence error:', err.code);
          }
          
          await this.signInAnonymously();
          this.setupConnectionListener();
          
          this.isOnline = true;
          this.isFirebaseReady = true;
          console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ–Ω–µ');
          
          if (window.compactCalendar) {
            await window.compactCalendar.syncWithFirebase();
          }
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
          this.isOnline = false;
          this.isFirebaseReady = false;
        }
      }

      async signInAnonymously() {
        try {
          const userCredential = await this.auth.signInAnonymously();
          console.log('üë§ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', userCredential.user.uid);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
        }
      }

      setupConnectionListener() {
        this.auth.onAuthStateChanged((user) => {
          this.isOnline = !!user;
          console.log(user ? 'üü¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : 'üî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
        });

        window.addEventListener('online', () => {
          console.log('üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω');
          this.isOnline = true;
        });

        window.addEventListener('offline', () => {
          console.log('üìµ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω');
          this.isOnline = false;
        });
      }

      loadEmotionsInstantly() {
        console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage...');
        let emotions = {};
        
        try {
          const localData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          if (localData) {
            emotions = JSON.parse(localData);
            const count = Object.keys(emotions).length;
            console.log(`üíæ –≠–º–æ—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage: ${count}`);
          } else {
            console.log('üíæ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ localStorage');
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
        }

        return emotions;
      }

      async syncWithFirebase() {
        if (!this.isFirebaseReady || !this.isOnline || !this.db) {
          console.log('üö´ Firebase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
          return {};
        }

        console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase...');
        
        try {
          const snapshot = await this.db.collection('emotions')
            .where('userId', '==', this.userId)
            .get();
          
          let firebaseEmotions = {};
          
          if (!snapshot.empty) {
            snapshot.forEach(doc => {
              const data = doc.data();
              firebaseEmotions[data.date] = data.emotion;
            });
            
            console.log('üî• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', snapshot.size);
            this.saveAllToLocalStorage(firebaseEmotions);
            
            try {
              localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
            } catch (e) {}
            
            return firebaseEmotions;
          } else {
            console.log('üî• –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Firebase –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', this.userId);
            return {};
          }
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Firebase:', error);
          return {};
        }
      }

      async saveEmotion(dateKey, emotion) {
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏: ${emotion} –¥–ª—è –¥–∞—Ç—ã: ${dateKey}`);
        
        const emotionData = {
          emotion: emotion,
          date: dateKey,
          timestamp: new Date(),
          userId: this.userId
        };

        this.saveToLocalStorage(dateKey, emotion);
        console.log('‚úÖ –≠–º–æ—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');

        if (this.isOnline && this.db && this.isFirebaseReady) {
          try {
            const docRef = this.db.collection('emotions').doc(`${this.userId}_${dateKey}`);
            await docRef.set(emotionData);
            console.log('‚úÖ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Firebase:', dateKey, emotion);
            
            try {
              localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
            } catch (e) {}
            
            return true;
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
            return false;
          }
        } else {
          console.log('üíæ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ localStorage (–æ—Ñ–ª–∞–π–Ω):', dateKey, emotion);
          return true;
        }
      }

      async deleteEmotion(dateKey) {
        console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏ –¥–ª—è –¥–∞—Ç—ã: ${dateKey}`);
        
        this.removeFromLocalStorage(dateKey);
        console.log('‚úÖ –≠–º–æ—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ localStorage');

        if (this.isOnline && this.db && this.isFirebaseReady) {
          try {
            const docRef = this.db.collection('emotions').doc(`${this.userId}_${dateKey}`);
            await docRef.delete();
            console.log('‚úÖ –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ Firebase:', dateKey);
            return true;
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:', error);
            return false;
          }
        } else {
          console.log('üíæ –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ localStorage (–æ—Ñ–ª–∞–π–Ω):', dateKey);
          return true;
        }
      }

      saveToLocalStorage(dateKey, emotion) {
        try {
          const currentData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          const emotions = currentData ? JSON.parse(currentData) : {};
          emotions[dateKey] = emotion;
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üíæ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
        }
      }

      removeFromLocalStorage(dateKey) {
        try {
          const currentData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          const emotions = currentData ? JSON.parse(currentData) : {};
          delete emotions[dateKey];
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üóëÔ∏è –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ localStorage');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ localStorage:', error);
        }
      }

      saveAllToLocalStorage(emotions) {
        try {
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üíæ –í—Å–µ —ç–º–æ—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage:', Object.keys(emotions).length);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —ç–º–æ—Ü–∏–π –≤ localStorage:', error);
        }
      }
    }

    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏)
    class CompactCalendar {
      constructor() {
        this.emotions = {};
        this.selectedDate = null;
        this.isLoading = false;
        this.firebaseService = new FirebaseService();
        
        this.initializeElements();
        this.setupEventListeners();
        
        // –ú–ì–ù–û–í–ï–ù–ù–û –∑–∞–≥—Ä—É–∂–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        this.loadEmotionsInstantly();
        this.renderCalendar();
      }

      initializeElements() {
        this.calendarDaysGrid = document.getElementById('calendarDaysGrid');
        this.currentMonthElement = document.getElementById('currentMonth');
        this.emotionModal = document.getElementById('emotionModal');
      }

      setupEventListeners() {
        // Modal events
        this.emotionModal.addEventListener('click', (e) => {
          if (e.target === this.emotionModal) {
            this.closeModal();
          }
        });

        document.getElementById('closeModal').addEventListener('click', () => {
          this.closeModal();
        });

        // Emotion options
        document.querySelectorAll('.emotion-option').forEach(option => {
          option.addEventListener('click', () => {
            const emotion = option.dataset.emotion;
            this.setEmotion(emotion);
          });
        });
      }

      loadEmotionsInstantly() {
        console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ —ç–º–æ—Ü–∏–π –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ...');
        this.emotions = this.firebaseService.loadEmotionsInstantly();
        const count = Object.keys(this.emotions).length;
        console.log(`‚úÖ –≠–º–æ—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é: ${count}`);
        return this.emotions;
      }

      async syncWithFirebase() {
        console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å Firebase –≤ —Ñ–æ–Ω–µ...');
        const firebaseEmotions = await this.firebaseService.syncWithFirebase();
        
        if (firebaseEmotions && Object.keys(firebaseEmotions).length > 0) {
          const newEmotions = { ...this.emotions, ...firebaseEmotions };
          
          const hasChanges = JSON.stringify(this.emotions) !== JSON.stringify(newEmotions);
          
          if (hasChanges) {
            console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
            this.emotions = newEmotions;
            this.renderCalendar();
          } else {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
          }
        }
      }

      getLocalizedMonthNames() {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        if (currentLang === 'en') {
          return [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
          ];
        } else {
          return [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
          ];
        }
      }

      renderCalendar() {
        this.calendarDaysGrid.innerHTML = '';
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
        const today = DateUtils.getCurrentDateInUserTimezone();
        const days = [];
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –¥–Ω–µ–π + —Å–µ–≥–æ–¥–Ω—è + 1 –±—É–¥—É—â–∏–π –¥–µ–Ω—å = 14 –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏)
        for (let i = 12; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          days.push(date);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å –≤ –±—É–¥—É—â–µ–µ (29 –∏—é–Ω—è –¥–ª—è 28 –∏—é–Ω—è)
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        days.push(tomorrow);

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
        const monthNames = this.getLocalizedMonthNames();
        const currentMonth = monthNames[today.getMonth()];
        const currentYear = today.getFullYear();
        this.currentMonthElement.textContent = `${currentMonth} ${currentYear}`;

        days.forEach(date => {
          const dayElement = this.createDayElement(date);
          this.calendarDaysGrid.appendChild(dayElement);
        });
      }

      createDayElement(date) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = date.getDate();

        if (DateUtils.isTodayInUserTimezone(date)) {
          dayElement.classList.add('today');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –±—É–¥—É—â–µ–π
        const today = DateUtils.getCurrentDateInUserTimezone();
        today.setHours(23, 59, 59, 999);
        date.setHours(0, 0, 0, 0);
        
        const isFutureDate = date > today;

        if (isFutureDate) {
          dayElement.classList.add('future-date');
          return dayElement;
        }

        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        dayElement.setAttribute('data-date', dateKey);
        
        if (this.emotions[dateKey]) {
          dayElement.classList.add('has-emotion', `emotion-${this.emotions[dateKey]}`);
        }

        dayElement.addEventListener('click', () => {
          this.openModal(dateKey);
        });

        return dayElement;
      }

      openModal(dateKey) {
        this.selectedDate = dateKey;
        
        const [year, month, day] = dateKey.split('-').map(Number);
        const date = new Date(year, month, day);
        const dateText = this.formatSelectedDate(date);
        document.getElementById('selectedDateText').textContent = dateText;
        
        this.emotionModal.classList.add('active');
      }

      formatSelectedDate(date) {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        const dayNames = currentLang === 'en' ? 
          ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'] :
          ['–í–û–°–ö–†–ï–°–ï–ù–¨–ï', '–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö', '–í–¢–û–†–ù–ò–ö', '–°–†–ï–î–ê', '–ß–ï–¢–í–ï–†–ì', '–ü–Ø–¢–ù–ò–¶–ê', '–°–£–ë–ë–û–¢–ê'];
        
        const monthNames = currentLang === 'en' ? 
          ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'] :
          ['–Ø–ù–í–ê–†–Ø', '–§–ï–í–†–ê–õ–Ø', '–ú–ê–†–¢–ê', '–ê–ü–†–ï–õ–Ø', '–ú–ê–Ø', '–ò–Æ–ù–Ø', '–ò–Æ–õ–Ø', '–ê–í–ì–£–°–¢–ê', '–°–ï–ù–¢–Ø–ë–†–Ø', '–û–ö–¢–Ø–ë–†–Ø', '–ù–û–Ø–ë–†–Ø', '–î–ï–ö–ê–ë–†–Ø'];
        
        const dayName = dayNames[date.getDay()];
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        
        if (currentLang === 'en') {
          return `${dayName}, ${month} ${day}, ${year}`;
        } else {
          return `${dayName}, ${day} ${month} ${year} –ì.`;
        }
      }

      closeModal() {
        this.emotionModal.classList.remove('active');
        this.selectedDate = null;
      }

      async setEmotion(emotion) {
        if (!this.selectedDate || this.isLoading) return;
        
        this.isLoading = true;
        console.log(`üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç–º–æ—Ü–∏–∏: ${emotion} –¥–ª—è –¥–∞—Ç—ã: ${this.selectedDate}`);
        
        const isRemoving = this.emotions[this.selectedDate] === emotion;
        
        try {
          if (isRemoving) {
            delete this.emotions[this.selectedDate];
            await this.firebaseService.deleteEmotion(this.selectedDate);
            trackEmotionRemove(emotion, this.selectedDate);
            console.log(`üóëÔ∏è –≠–º–æ—Ü–∏—è ${emotion} —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è ${this.selectedDate}`);
          } else {
            this.emotions[this.selectedDate] = emotion;
            await this.firebaseService.saveEmotion(this.selectedDate, emotion);
            trackEmotionSet(emotion, this.selectedDate);
            console.log(`‚úÖ –≠–º–æ—Ü–∏—è ${emotion} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è ${this.selectedDate}`);
          }
          
          // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º UI
          this.renderCalendar();
          this.closeModal();
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —ç–º–æ—Ü–∏–∏:', error);
        } finally {
          this.isLoading = false;
        }
      }
    }

    // Translator class (—Ç–µ–ø–µ—Ä—å —Å Telegram —è–∑—ã–∫–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º)
    class Translator {
      constructor() {
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        
        this.currentLang = this.getTelegramLanguage() || 
                          this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'en';
        
        console.log('üåê –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —è–∑—ã–∫:', this.currentLang);
        this.init();
      }

      getTelegramLanguage() {
        try {
          if (window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code) {
            const telegramLang = window.Telegram.WebApp.initDataUnsafe.user.language_code;
            console.log('üì± –Ø–∑—ã–∫ –∏–∑ Telegram:', telegramLang);
            
            if (telegramLang === 'ru' || telegramLang.startsWith('ru')) {
              return 'ru';
            }
            return 'en';
          }
          
          console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∞ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
          return null;
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ Telegram:', error);
          return null;
        }
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('lang');
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        try {
          return localStorage.getItem('potok_language');
        } catch (error) {
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
        document.title = this.translate('page_title');
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => {
          this.setLanguage('en');
        });
        document.getElementById('ruBtn')?.addEventListener('click', () => {
          this.setLanguage('ru');
        });
      }

      setLanguage(lang) {
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
          } catch (error) {}
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
        } catch (error) {}
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        
        if (window.potokApp && typeof window.potokApp.updateLinksWithLanguage === 'function') {
          window.potokApp.updateLinksWithLanguage(lang);
        }
        
        if (window.compactCalendar) {
          window.compactCalendar.renderCalendar();
        }
        
        document.documentElement.lang = lang;
        document.title = this.translate('page_title');
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        links.forEach(link => {
          let href = link.getAttribute('href');
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          if (href.includes('#')) {
            const parts = href.split('#');
            href = parts[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
        });
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          
          if (element.tagName === 'TITLE') {
            element.textContent = translation;
          } else {
            element.textContent = translation;
          }
        });
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
            btn.style.background = 'linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%)';
          } else {
            btn.style.background = '';
          }
        });
      }
    }

    // Telegram App class (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    class PotokTelegramApp {
      constructor() {
        this.tg = window.Telegram?.WebApp;
        this.user = null;
        this.init();
      }

      async init() {
        this.initTelegramWebApp();
        this.setupEventListeners();
        
        if (this.user && this.user.id) {
          setTimeout(() => {
            this.trackPageEntry();
          }, 1000);
        }
      }

      initTelegramWebApp() {
        if (!this.tg) {
          console.log('‚ö†Ô∏è Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞');
          return;
        }

        this.tg.ready();
        this.tg.setHeaderColor('#19191B');
        this.tg.setBackgroundColor('#19191B');
        this.tg.expand();
        this.tg.enableClosingConfirmation();
        this.tg.MainButton.hide();
        this.tg.BackButton.hide();
        
        this.user = this.tg.initDataUnsafe?.user;
        if (this.user) {
          console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', this.user.first_name, '–Ø–∑—ã–∫:', this.user.language_code);
          this.updateUserHeader();
        } else {
          console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
        }
      }

      updateUserHeader() {
        if (!this.user) return;
        
        const headerLogo = document.getElementById('headerLogo');
        headerLogo.innerHTML = `
          <div class="user-header">
            <div class="user-avatar">
              ${this.user.photo_url ? 
                `<img src="${this.user.photo_url}" alt="${this.user.first_name}" class="avatar-image">` :
                `<div class="avatar-placeholder">${this.user.first_name?.charAt(0).toUpperCase() || 'U'}</div>`
              }
            </div>
            <div class="user-name">${this.user.first_name || 'User'}</div>
          </div>
        `;

        if (window.translator && typeof window.translator.updatePageLinks === 'function') {
          setTimeout(() => {
            window.translator.updatePageLinks();
          }, 100);
        }
      }

      updateLinksWithLanguage(lang) {
        const headerLinks = document.getElementById('headerLogo')?.querySelectorAll('a[href*=".html"]');
        if (headerLinks) {
          headerLinks.forEach(link => {
            let href = link.getAttribute('href');
            if (href.includes('?lang=')) {
              href = href.split('?')[0];
            }
            link.setAttribute('href', `${href}?lang=${lang}`);
          });
        }
      }

      async trackPageEntry() {
        try {
          if (!this.user || !this.user.id) {
            console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram');
            return;
          }

          const userData = {
            user_id: this.user.id,
            first_name: this.user.first_name || '',
            last_name: this.user.last_name || '',
            username: this.user.username || '',
            language_code: this.user.language_code || '',
            entry_time: new Date().toISOString(),
            page: 'index',
            user_agent: navigator.userAgent,
            platform: this.tg?.platform || 'unknown',
            action: 'track-entry'
          };

          console.log('üìä –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);

          const params = new URLSearchParams({
            user_id: userData.user_id,
            first_name: userData.first_name,
            last_name: userData.last_name,
            username: userData.username,
            language_code: userData.language_code,
            page: userData.page,
            platform: userData.platform,
            action: 'track-entry'
          });

          const img = new Image();
          img.onload = () => console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
          img.onerror = () => console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
          img.src = `https://script.google.com/macros/s/AKfycbw7Fk8czSiLvjjONtja6GwK1jDeczv4LAnfkHG1L21GlbSahR0bVSdTfU1ZqJ8Pl4pn7A/exec?${params}`;

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥–∞:', error);
        }
      }

      setupEventListeners() {
        document.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', (e) => {
            const title = e.currentTarget.querySelector('.card-title')?.textContent;
            
            this.handlePracticeClick(title);
            this.triggerHapticFeedback('light');
          });
        });

        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.currentTarget.querySelector('div')?.textContent;
            
            trackEvent('navigation_click', {
              tab: tabName,
              user_id: this.user?.id
            });
            this.triggerHapticFeedback('selection');
          });
        });
      }

      handlePracticeClick(practiceType) {
        trackEvent('practice_started', {
          practice_type: practiceType,
          user_id: this.user?.id,
          timestamp: Date.now()
        });
      }

      triggerHapticFeedback(type = 'light') {
        if (this.tg?.HapticFeedback) {
          switch (type) {
            case 'light':
              this.tg.HapticFeedback.impactOccurred('light');
              break;
            case 'medium':
              this.tg.HapticFeedback.impactOccurred('medium');
              break;
            case 'heavy':
              this.tg.HapticFeedback.impactOccurred('heavy');
              break;
            case 'selection':
              this.tg.HapticFeedback.selectionChanged();
              break;
          }
        }
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initializeApp() {
      // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
      window.translator = new Translator();
      
      // 2. Telegram App
      window.potokApp = new PotokTelegramApp();
      
      // 3. –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
      window.compactCalendar = new CompactCalendar();
      
      // 4. –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
      setTimeout(() => {
        window.translator.updatePageLinks();
      }, 1500);
    }

    // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Telegram WebApp –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ DOMContentLoaded
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      setTimeout(initializeApp, 100);
    } else {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    }
  </script>
</body>
</html>