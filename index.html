<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#19191B" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title data-translate="page_title">Potok ‚Äî Home</title>
  
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4834XVE45Z', {
      custom_map: {
        'custom_parameter_1': 'telegram_user_id',
        'custom_parameter_2': 'practice_type'
      }
    });
  </script>
  
  <!-- Firebase SDK v9 - Simplified –≤–µ—Ä—Å–∏—è -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // –î–µ–ª–∞–µ–º Firebase –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
    window.firebaseApp = null;
    window.firebaseDb = null;
    window.firebaseApi = { doc, getDoc, setDoc };
    
    // –†–µ–∞–ª—å–Ω–∞—è Firebase Configuration –¥–ª—è spokspacebot
    const firebaseConfig = {
      apiKey: "AIzaSyDB1ePgeJVXB_Qcy0UZDIKHA8i1GpOOQAU",
      authDomain: "spokspacebot.firebaseapp.com",
      projectId: "spokspacebot",
      storageBucket: "spokspacebot.firebasestorage.app",
      messagingSenderId: "545573700538",
      appId: "1:545573700538:web:efa309ffbe902cab081383"
    };

    try {
      window.firebaseApp = initializeApp(firebaseConfig);
      window.firebaseDb = getFirestore(window.firebaseApp);
      console.log('‚úÖ Firebase v9 simplified –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ spokspacebot');
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Firebase
      window.dispatchEvent(new CustomEvent('firebaseReady'));
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
      console.log('üîÑ –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ Firebase (localStorage fallback)');
    }
  </script>
  
  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  
  <!-- Telegram Analytics SDK -->
  <script async src="https://tganalytics.xyz/index.js" onload="initTelegramAnalytics()" type="text/javascript"></script>
  
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Analytics SDK
    function initTelegramAnalytics() {
      if (window.telegramAnalytics) {
        try {
          window.telegramAnalytics.init({
            token: 'eyJhcHBfbmFtZSI6InNwb2tzcGFjZV9taW5pYXBwIiwiYXBwX3VybCI6Imh0dHBzOi8vdC5tZS9zcG9rc3BhY2Vib3QiLCJhcHBfZG9tYWluIjoiaHR0cHM6Ly9zcG9rc3BhY2UuY29tIn0=!0dbi7xO0ICzOMI4+U3XMZslcn6F0JvCFfyoLVp4K8+0=',
            appName: 'spokspace_miniapp'
          });
          console.log('‚úÖ Telegram Analytics SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Analytics SDK:', error);
        }
      }
    }

    // TelegramAnalytics wrapper
    window.TelegramAnalytics = {
      track: function(eventName, parameters) {
        if (window.telegramAnalytics && typeof window.telegramAnalytics.track === 'function') {
          try {
            window.telegramAnalytics.track(eventName, parameters);
            console.log('üìä Telegram Analytics:', eventName, parameters);
          } catch (error) {
            console.error('Telegram Analytics error:', error);
          }
        }
        
        if (window.Telegram?.WebApp?.sendData) {
          try {
            const analyticsData = {
              event: eventName,
              params: parameters,
              timestamp: Date.now(),
              user_id: window.Telegram.WebApp.initDataUnsafe?.user?.id
            };
            console.log('üìä Analytics (fallback):', eventName, parameters);
          } catch (error) {
            console.error('Analytics fallback error:', error);
          }
        }
      }
    };
  </script>
  
  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    h1, h2, h3, h4, h5, h6, p {
      margin: 0;
      padding: 0;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 163.5px);
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 425px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .home {
      max-width: 375px;
      margin: 0 auto;
      padding: 96px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      padding-bottom: 96px;
      box-sizing: border-box;
    }

    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .home {
        padding-bottom: calc(96px + env(safe-area-inset-bottom) + 20px);
      }
    }

    /* –•–µ–¥–µ—Ä —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º/–∞–≤–∞—Ç–∞—Ä–æ–º */
    .logo {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      background-color: var(--main);
      padding: 24px;
      box-sizing: border-box;
    }

    .logo img {
      height: 33px;
      width: auto;
      display: block;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      display: block;
      border-radius: 50%;
    }

    .avatar-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-2);
    }

    .user-name {
      font-size: 18px;
      line-height: 24px;
      font-weight: 500;
      color: var(--white);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ton-connect-button {
      background: #0088cc;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .ton-connect-button:hover {
      background: #0077bb;
    }

    /* Streak Counter */
    .streak-header {
      max-width: 327px;
      width: 100%;
      margin: 0 auto 48px auto;
      display: flex;
      align-items: center;
    }

    .streak-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .streak-days {
      font-size: 24px;
      line-height: 32px;
      font-weight: 600;
      color: var(--white);
    }

    .streak-message {
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
      color: var(--text-2);
    }

    .streak-loading {
      opacity: 0.6;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 0.3; }
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .cards {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-bottom: 48px;
      position: relative;
      z-index: 1;
    }

    .card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 327px;
      height: 80px;
      margin: 0 auto;
      box-sizing: border-box;
      padding-right: 16px;
      transition: background-color 0.2s;
    }

    .card:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .card img:first-child {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px 0 0 8px;
      flex-shrink: 0;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex: 1;
      margin-left: 24px;
      gap: 0px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      color: var(--white);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-2);
      line-height: 16px;
    }

    .card .arrow {
      width: 5px;
      height: 10px;
      margin-left: 16px;
    }

    /* –ë–ª–æ–∫ "–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å" */
    .no-choice-section {
      margin-bottom: 48px;
      position: relative;
      z-index: 1;
    }

    .no-choice-text {
      font-size: 16px;
      line-height: 24px;
      font-weight: 700;
      color: #FFFFFF;
      text-align: left;
      margin: 0 auto 4px auto;
      max-width: 327px;
      width: 100%;
    }

    .no-choice-subtitle {
      font-size: 12px;
      line-height: 16px;
      font-weight: 400;
      color: #B3B3B3;
      text-align: left;
      margin: 0 auto 24px auto;
      max-width: 327px;
      width: 100%;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–Ω—è */
    .preview-container {
      width: 100%;
      max-width: 327px;
      height: 120px;
      background-color: var(--green);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      margin: 0 auto;
      z-index: 1;
    }

    .preview-container:active {
      transform: scale(0.98);
    }

    .preview-animation {
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .arrow {
      width: 5px;
      height: 10px;
    }

    /* –ë–ª–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ */
    .support-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      margin-top: 0;
      padding: 0 12px;
      position: relative;
      z-index: 1;
    }

    .support-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 4px 16px;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      transition: opacity 0.2s;
      cursor: pointer;
    }

    .support-item:hover {
      opacity: 0.8;
    }

    .support-item:active {
      opacity: 0.6;
    }

    .support-item svg {
      flex-shrink: 0;
    }

    /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }

    /* TON Connect —Å–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    .ton-connect-wrapper {
      margin-left: auto;
      display: none !important;
    }

    .wallet-status {
      position: fixed;
      top: 80px;
      right: 24px;
      background: rgba(0, 136, 204, 0.1);
      border: 1px solid rgba(0, 136, 204, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 10px;
      color: #0088cc;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      display: none;
      z-index: 150;
    }

    .wallet-status.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <div class="home">
    <!-- –õ–æ–≥–æ—Ç–∏–ø –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –∞–≤–∞—Ç–∞—Ä –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ JavaScript -->
    <div class="logo" id="headerLogo">
      <img src="img/logo.svg" alt="Potok logo">
    </div>

    <!-- Streak Counter -->
    <div class="streak-header" id="streakHeader">
      <div class="streak-content">
        <div class="streak-days streak-loading" data-translate="streak_loading">0 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
        <div class="streak-message streak-loading" data-translate="streak_loading_message">–ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
      </div>
    </div>

    <div class="cards">
      <a href="pause.html" class="card" data-practice="pause">
        <img src="img/mind.jpg" alt="Calm thoughts">
        <div class="card-content">
          <div class="card-title" data-translate="calm_thoughts">Calm thoughts</div>
          <div class="card-subtitle" data-translate="meditation_duration">Meditation ‚Ä¢ 5 min</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="478.html" class="card" data-practice="478">
        <img src="img/breathing.jpg" alt="Reduce stress">
        <div class="card-content">
          <div class="card-title" data-translate="reduce_stress">Reduce stress</div>
          <div class="card-subtitle" data-translate="breathing_duration">Breathing ‚Ä¢ 1-2 min</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="stars.html" class="card" data-practice="stars">
        <img src="img/sleep.jpg" alt="Improve sleep">
        <div class="card-content">
          <div class="card-title" data-translate="improve_sleep">Improve sleep</div>
          <div class="card-subtitle" data-translate="sleep_duration">Sleep ‚Ä¢ 5 min</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
    </div>

    <div class="no-choice-section">
      <h2 class="no-choice-text" data-translate="no_choice_title">If you don't want to choose</h2>
      <p class="no-choice-subtitle" data-translate="pond_practice">Leaves in the pond ‚Ä¢ 3 min</p>

      <div class="preview-container" id="practiceOfDay" data-practice="pond">
        <svg class="preview-animation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 327 120">
          <!-- Background -->
          <rect width="327" height="120" fill="#34A853" rx="8" />
          
          <!-- Random white dots -->
          <circle cx="60" cy="25" r="1.5" fill="white" opacity="0.7">
            <animate attributeName="opacity" values="0.7;0.3;0.7" dur="2.5s" repeatCount="indefinite"/>
          </circle>
          <circle cx="270" cy="30" r="2" fill="white" opacity="0.5">
            <animate attributeName="opacity" values="0.5;0.8;0.5" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="250" cy="90" r="1" fill="white" opacity="0.6">
            <animate attributeName="opacity" values="0.6;0.2;0.6" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="80" cy="85" r="1.8" fill="white" opacity="0.4">
            <animate attributeName="opacity" values="0.4;0.7;0.4" dur="3.5s" repeatCount="indefinite"/>
          </circle>
          <circle cx="180" cy="20" r="1.2" fill="white" opacity="0.8">
            <animate attributeName="opacity" values="0.8;0.4;0.8" dur="2.2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="300" cy="70" r="1.4" fill="white" opacity="0.6">
            <animate attributeName="opacity" values="0.6;0.9;0.6" dur="2.8s" repeatCount="indefinite"/>
          </circle>
          <circle cx="40" cy="60" r="2.2" fill="white" opacity="0.3">
            <animate attributeName="opacity" values="0.3;0.6;0.3" dur="3.2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="200" cy="100" r="1.6" fill="white" opacity="0.7">
            <animate attributeName="opacity" values="0.7;0.2;0.7" dur="2.4s" repeatCount="indefinite"/>
          </circle>
          
          <!-- 5 –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –≤–æ–ª–Ω -->
          <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
            <animate attributeName="r" values="45;10" dur="8s" repeatCount="indefinite" begin="0s"/>
            <animate attributeName="opacity" values="0;0.5;0.9" dur="8s" repeatCount="indefinite" begin="0s"/>
          </circle>
          
          <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
            <animate attributeName="r" values="45;10" dur="8s" repeatCount="indefinite" begin="1.6s"/>
            <animate attributeName="opacity" values="0;0.5;0.9" dur="8s" repeatCount="indefinite" begin="1.6s"/>
          </circle>
          
          <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
            <animate attributeName="r" values="45;10" dur="8s" repeatCount="indefinite" begin="3.2s"/>
            <animate attributeName="opacity" values="0;0.5;0.9" dur="8s" repeatCount="indefinite" begin="3.2s"/>
          </circle>
          
          <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
            <animate attributeName="r" values="45;10" dur="8s" repeatCount="indefinite" begin="4.8s"/>
            <animate attributeName="opacity" values="0;0.5;0.9" dur="8s" repeatCount="indefinite" begin="4.8s"/>
          </circle>
          
          <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
            <animate attributeName="r" values="45;10" dur="8s" repeatCount="indefinite" begin="6.4s"/>
            <animate attributeName="opacity" values="0;0.5;0.9" dur="8s" repeatCount="indefinite" begin="6.4s"/>
          </circle>
          
          <!-- Play button overlay -->
          <g transform="translate(163.5, 60)">
            <!-- Button background -->
            <circle r="24" fill="rgba(255, 255, 255, 0.03)" stroke="rgba(255, 255, 255, 0.1)" stroke-width="1"/>
            <!-- Play icon -->
            <path d="M-6 -8 L-6 8 L8 0 Z" fill="white" opacity="0.9"/>
          </g>
        </svg>
      </div>
    </div>

    <!-- Support and Terms block -->
    <div class="support-block">
      <a href="https://t.me/spoksupport_bot" class="support-item">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.3666 3.84166C16.941 3.41583 16.4356 3.07803 15.8794 2.84757C15.3232 2.61711 14.7271 2.49847 14.1249 2.49847C13.5227 2.49847 12.9266 2.61711 12.3704 2.84757C11.8142 3.07803 11.3088 3.41583 10.8832 3.84166L9.99989 4.725L9.11656 3.84166C8.25686 2.98196 7.09089 2.49879 5.87489 2.49879C4.65889 2.49879 3.49292 2.98196 2.63322 3.84166C1.77352 4.70136 1.29036 5.86733 1.29036 7.08333C1.29036 8.29933 1.77352 9.4653 2.63322 10.325L3.51656 11.2083L9.99989 17.6917L16.4832 11.2083L17.3666 10.325C17.7924 9.89937 18.1302 9.39399 18.3607 8.83779C18.5911 8.28158 18.7098 7.68546 18.7098 7.08333C18.7098 6.48121 18.5911 5.88508 18.3607 5.32888C18.1302 4.77267 17.7924 4.26729 17.3666 3.84166Z" stroke="#B3B3B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span data-translate="support_text">Need help? Contact us!</span>
      </a>
      
      <a href="privacy.html" class="support-item">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4H16V16H4V4Z" stroke="#B3B3B3" stroke-width="1.5"/>
          <path d="M6 8H14" stroke="#B3B3B3" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M6 11H14" stroke="#B3B3B3" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M6 14H10" stroke="#B3B3B3" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <span data-translate="terms_of_use">Terms of Use</span>
      </a>
    </div>
  </div>

  <!-- TON Wallet Status -->
  <div class="wallet-status" id="walletStatus">
    <span data-translate="wallet_not_connected">Wallet not connected</span>
  </div>

  <footer class="tab-bar">
    <a href="index.html" class="tab active">
      <img src="img/home-active.svg" alt="Today">
      <div data-translate="today">Today</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="practices">Practices</div>
    </a>
    <a href="journal.html" class="tab">
      <img src="img/journal.svg" alt="Journal">
      <div data-translate="journal">Journal</div>
    </a>
  </footer>

  <script>
    // Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –º–æ–¥—É–ª–µ –≤—ã—à–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π spokspacebot

    // Simplified streak messages system
    const streakMessages = {
      en: {
        // 1. First launch
        start: "Start your day",
        
        // 2. Progress (default + milestones)
        progress: "Pace is holding",
        milestones: {
          7: "A week. No fuss",
          10: "Nice and round", 
          14: "Two weeks in a row",
          20: "A number with character",
          21: "Three weeks. Beautiful",
          30: "A month in a row"
        },
        
        // 3. Reset (random)
        reset: [
          "Just pace decided to catch its breath",
          "Pace took a pause", 
          "At least habit knows the way"
        ]
      },
      ru: {
        // 1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        start: "–° —á–µ–≥–æ —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å?",
        
        // 2. –ü—Ä–æ–≥—Ä–µ—Å—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é + –≤–∞–∂–Ω—ã–µ –≤–µ—Ö–∏)
        progress: "–¢–µ–º–ø –¥–µ—Ä–∂–∏—Ç—Å—è",
        milestones: {
          7: "–ù–µ–¥–µ–ª—è. –ë–µ–∑ —Å—É–µ—Ç—ã",
          10: "–ö—Ä—É–≥–ª–µ–Ω—å–∫–æ",
          14: "–î–≤–µ –Ω–µ–¥–µ–ª–∏ –ø–æ–¥—Ä—è–¥", 
          20: "–¶–∏—Ñ—Ä–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º",
          21: "–¢—Ä–∏ –Ω–µ–¥–µ–ª–∏. –ö—Ä–∞—Å–∏–≤–æ",
          30: "–ú–µ—Å—è—Ü –ø–æ–¥—Ä—è–¥"
        },
        
        // 3. –°–±—Ä–æ—Å (—Å–ª—É—á–∞–π–Ω–æ)
        reset: [
          "–ü—Ä–æ—Å—Ç–æ —Ç–µ–º–ø —Ä–µ—à–∏–ª –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥—É—Ö",
          "–¢–µ–º–ø —É—à—ë–ª –Ω–∞ –ø–∞—É–∑—É",
          "–ó–∞—Ç–æ –ø—Ä–∏–≤—ã—á–∫–∞ –∑–Ω–∞–µ—Ç –¥–æ—Ä–æ–≥—É"
        ]
      }
    };

    // Translation system
    const translations = {
      en: {
        page_title: "Potok ‚Äî Home",
        streak_loading: "0 days in a row",
        streak_loading_message: "Loading...",
        streak_days: "{days} days in a row",
        streak_day: "{days} day in a row",
        calm_thoughts: "Calm thoughts",
        reduce_stress: "Reduce stress", 
        improve_sleep: "Improve sleep",
        meditation_duration: "Meditation ‚Ä¢ 5 min",
        breathing_duration: "Breathing ‚Ä¢ 1-2 min",
        sleep_duration: "Sleep ‚Ä¢ 5 min",
        no_choice_title: "If you don't want to choose",
        pond_practice: "Leaves in the pond ‚Ä¢ 3 min",
        support_text: "Need help? Contact us!",
        terms_of_use: "Terms of Use",
        wallet_not_connected: "Wallet not connected",
        today: "Today",
        practices: "Practices",
        journal: "Journal"
      },
      ru: {
        page_title: "Potok ‚Äî –î–æ–º",
        streak_loading: "0 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥",
        streak_loading_message: "–ó–∞–≥—Ä—É–∂–∞–µ–º...",
        streak_days: "{days} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥",
        streak_day: "{days} –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥",
        calm_thoughts: "–£—Å–ø–æ–∫–æ–∏—Ç—å –º—ã—Å–ª–∏",
        reduce_stress: "–°–Ω–∏–∑–∏—Ç—å —Å—Ç—Ä–µ—Å—Å",
        improve_sleep: "–£–ª—É—á—à–∏—Ç—å —Å–æ–Ω", 
        meditation_duration: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è ‚Ä¢ 5 –º–∏–Ω",
        breathing_duration: "–î—ã—Ö–∞–Ω–∏–µ ‚Ä¢ 1-2 –º–∏–Ω",
        sleep_duration: "–°–æ–Ω ‚Ä¢ 5 –º–∏–Ω",
        no_choice_title: "–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å",
        pond_practice: "–õ–∏—Å—Ç—å—è –≤ –ø—Ä—É–¥—É ‚Ä¢ 3 –º–∏–Ω",
        support_text: "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏!",
        terms_of_use: "–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
        wallet_not_connected: "–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω",
        today: "–°–µ–≥–æ–¥–Ω—è",
        practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏", 
        journal: "–ñ—É—Ä–Ω–∞–ª"
      }
    };

    // Streak Manager
    class StreakManager {
      constructor(userId, language = 'en') {
        this.userId = userId;
        this.language = language;
        this.streak = 0;
        this.lastPracticeDate = null;
        this.startDate = null;
        this.practices = ['pond', 'pause', 'body', '478', '505', '4444', 'stars', 'place'];
        this.useFirebase = false;
        this.storageKey = `potok_streak_${this.userId}`;
        this.isFirstLaunch = true; // –§–ª–∞–≥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
        if (window.firebaseDb) {
          this.useFirebase = true;
        } else {
          window.addEventListener('firebaseReady', () => {
            this.useFirebase = true;
            console.log('üîÑ Firebase –≥–æ—Ç–æ–≤, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ');
          });
        }
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }

      async loadStreak() {
        console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º streak –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', this.userId);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        this.displayStreak(0, this.getStreakMessage(0), true);
        
        try {
          let streakData = null;
          
          // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firebase
          if (this.useFirebase && window.firebaseDb) {
            streakData = await this.loadFromFirebase();
          }
          
          // Fallback –Ω–∞ localStorage
          if (!streakData && this.localStorageAvailable) {
            streakData = this.loadFromLocalStorage();
          }
          
          if (streakData) {
            this.streak = streakData.streak || 0;
            this.lastPracticeDate = streakData.lastPracticeDate;
            this.startDate = streakData.startDate;
            this.isFirstLaunch = streakData.isFirstLaunch ?? false; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å streak
            const needsReset = this.checkIfNeedsReset();
            if (needsReset) {
              this.resetStreak();
              const resetMessage = this.getRandomResetMessage();
              this.displayStreak(0, resetMessage);
              await this.saveStreak();
            } else {
              this.displayStreak(this.streak, this.getStreakMessage(this.streak));
            }
          } else {
            // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
            this.isFirstLaunch = true;
            this.displayStreak(0, this.getStreakMessage(0));
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ streak:', error);
          this.displayStreak(0, this.getStreakMessage(0));
        }
      }

      async loadFromFirebase() {
        try {
          const { doc, getDoc } = window.firebaseApi;
          const docRef = doc(window.firebaseDb, 'telegram_users', this.userId.toString());
          const docSnap = await getDoc(docRef);
          
          if (docSnap.exists()) {
            console.log('‚úÖ Streak –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ Firebase');
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
          return null;
        }
      }

      loadFromLocalStorage() {
        try {
          const data = localStorage.getItem(this.storageKey);
          if (data) {
            console.log('‚úÖ Streak –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage');
            return JSON.parse(data);
          }
          return null;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
          return null;
        }
      }

      checkIfNeedsReset() {
        if (!this.lastPracticeDate) return false;
        
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
        
        return this.lastPracticeDate !== today && this.lastPracticeDate !== yesterday;
      }

      resetStreak() {
        this.streak = 0;
        this.lastPracticeDate = null;
        this.startDate = null;
        // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º isFirstLaunch - —ç—Ç–æ —É–∂–µ –Ω–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
      }

      async saveStreak() {
        const streakData = {
          streak: this.streak,
          lastPracticeDate: this.lastPracticeDate,
          startDate: this.startDate,
          lastUpdate: new Date().toISOString(),
          userId: this.userId,
          isFirstLaunch: this.isFirstLaunch
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if (this.useFirebase && window.firebaseDb) {
          await this.saveToFirebase(streakData);
        }
        
        // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ backup
        if (this.localStorageAvailable) {
          this.saveToLocalStorage(streakData);
        }
      }

      async saveToFirebase(streakData) {
        try {
          const { doc, setDoc } = window.firebaseApi;
          const docRef = doc(window.firebaseDb, 'telegram_users', this.userId.toString());
          
          await setDoc(docRef, {
            ...streakData,
            totalPractices: (streakData.totalPractices || 0) + 1
          }, { merge: true });
          
          console.log('‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase:', this.streak);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
        }
      }

      saveToLocalStorage(streakData) {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(streakData));
          console.log('‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage:', this.streak);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
        }
      }

      async recordPractice(practiceType) {
        if (!this.practices.includes(practiceType)) {
          console.log('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–∞–∫—Ç–∏–∫–∏:', practiceType);
          return;
        }

        const today = new Date().toDateString();
        
        // –ï—Å–ª–∏ —É–∂–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (this.lastPracticeDate === today) {
          console.log('üí° –ü—Ä–∞–∫—Ç–∏–∫–∞ —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è');
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
        
        if (this.streak === 0 || this.lastPracticeDate === yesterday) {
          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º streak
          this.streak += 1;
          this.lastPracticeDate = today;
          
          if (!this.startDate) {
            this.startDate = today;
          }
        } else {
          // Streak –ø—Ä–µ—Ä–≤–∞–ª—Å—è, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
          this.streak = 1;
          this.lastPracticeDate = today;
          this.startDate = today;
        }

        // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ —ç—Ç–æ —É–∂–µ –Ω–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        this.isFirstLaunch = false;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 90 –¥–Ω–µ–π
        if (this.streak > 90) {
          this.streak = 90;
        }

        await this.saveStreak();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.displayStreak(this.streak, this.getStreakMessage(this.streak));
        
        console.log(`üî• –ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞! Streak: ${this.streak} –¥–Ω–µ–π`);
      }

      getStreakMessage(days) {
        const messages = streakMessages[this.language] || streakMessages.en;
        
        if (days === 0) {
          // –°–æ—Å—Ç–æ—è–Ω–∏–µ 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
          if (this.isFirstLaunch) {
            return messages.start;
          }
          // –°–æ—Å—Ç–æ—è–Ω–∏–µ 3: –°–±—Ä–æ—Å (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ getRandomResetMessage)
          return messages.start; // Fallback
        }
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ 2: –ü—Ä–æ–≥—Ä–µ—Å—Å - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–∂–Ω—ã–µ –≤–µ—Ö–∏
        if (messages.milestones[days]) {
          return messages.milestones[days];
        }
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ 2: –ü—Ä–æ–≥—Ä–µ—Å—Å - –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        return messages.progress;
      }

      getRandomResetMessage() {
        const messages = streakMessages[this.language] || streakMessages.en;
        const resetMessages = messages.reset;
        return resetMessages[Math.floor(Math.random() * resetMessages.length)];
      }

      displayStreak(days, message, isLoading = false) {
        const streakDays = document.querySelector('.streak-days');
        const streakMessage = document.querySelector('.streak-message');
        
        if (streakDays && streakMessage) {
          // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
          if (isLoading) {
            streakDays.classList.add('streak-loading');
            streakMessage.classList.add('streak-loading');
          } else {
            streakDays.classList.remove('streak-loading');
            streakMessage.classList.remove('streak-loading');
          }
          
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ –¥–Ω–µ–π
          let daysText;
          if (this.language === 'ru') {
            if (days === 1) {
              daysText = `${days} –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥`;
            } else {
              daysText = `${days} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥`;
            }
          } else {
            if (days === 1) {
              daysText = `${days} day in a row`;
            } else {
              daysText = `${days} days in a row`;
            }
          }
          
          streakDays.textContent = daysText;
          streakMessage.textContent = message;
        }
      }

      setLanguage(lang) {
        this.language = lang;
        this.displayStreak(this.streak, this.getStreakMessage(this.streak));
      }
    }

    // Translation system
    class Translator {
      constructor() {
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        this.currentLang = this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'en';
        this.init();
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('lang');
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        try {
          return localStorage.getItem('potok_language');
        } catch (error) {
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => {
          this.setLanguage('en');
        });
        document.getElementById('ruBtn')?.addEventListener('click', () => {
          this.setLanguage('ru');
        });
      }

      setLanguage(lang) {
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
          } catch (error) {}
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
        } catch (error) {}
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫ –≤ streak manager
        if (window.streakManager) {
          window.streakManager.setLanguage(lang);
        }
        
        if (window.potokApp && typeof window.potokApp.updateLinksWithLanguage === 'function') {
          window.potokApp.updateLinksWithLanguage(lang);
        }
        
        document.documentElement.lang = lang;
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        links.forEach(link => {
          let href = link.getAttribute('href');
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          if (href.includes('#')) {
            const parts = href.split('#');
            href = parts[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
        });
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          
          if (element.tagName === 'TITLE') {
            element.textContent = translation;
          } else {
            element.textContent = translation;
          }
        });
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
            btn.style.background = 'linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%)';
          } else {
            btn.style.background = '';
          }
        });
      }
    }

    // PotokTelegramApp
    class PotokTelegramApp {
      constructor() {
        this.tg = window.Telegram?.WebApp;
        this.tonConnectUI = null;
        this.user = null;
        this.init();
      }

      async init() {
        this.initTelegramWebApp();
        await this.initTONConnect();
        this.initAnalytics();
        this.setupEventListeners();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º streak manager
        const userId = this.getUserId();
        const language = window.translator?.currentLang || 'en';
        window.streakManager = new StreakManager(userId, language);
        
        // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º streak
        setTimeout(async () => {
          await window.streakManager.loadStreak();
        }, 500);
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram
        if (this.user && this.user.id) {
          setTimeout(() => {
            this.trackPageEntry();
          }, 1000);
        }
      }

      getUserId() {
        // –†–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram
        if (this.user && this.user.id) {
          return this.user.id;
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let devUserId = null;
        try {
          devUserId = localStorage.getItem('potok_dev_user_id');
          if (!devUserId) {
            devUserId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('potok_dev_user_id', devUserId);
          }
        } catch (error) {
          // Fallback –µ—Å–ª–∏ localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
          devUserId = 'dev_' + Date.now();
        }
        
        console.log('üîß –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID:', devUserId);
        return devUserId;
      }

      initTelegramWebApp() {
        if (!this.tg) {
          console.log('‚ö†Ô∏è Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ');
          console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: streak –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ localStorage');
          return;
        }

        this.tg.ready();
        this.tg.setHeaderColor('#19191B');
        this.tg.setBackgroundColor('#19191B');
        
        if (this.tg.setBottomBarColor) {
          this.tg.setBottomBarColor('#19191B');
        }
        
        this.tg.expand();
        this.tg.enableClosingConfirmation();
        this.tg.MainButton.hide();
        this.tg.BackButton.hide();
        
        this.user = this.tg.initDataUnsafe?.user;
        if (this.user) {
          console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', this.user.first_name);
          this.updateUserHeader();
        } else {
          console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
        }

        if (this.tg.themeParams) {
          document.documentElement.style.setProperty('--tg-bg', this.tg.themeParams.bg_color || '#19191B');
          document.documentElement.style.setProperty('--tg-text', this.tg.themeParams.text_color || '#ffffff');
        }
      }

      async initTONConnect() {
        try {
          if (typeof TON_CONNECT_UI !== 'undefined') {
            this.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
              manifestUrl: window.location.origin + '/tonconnect-manifest.json'
            });
            this.tonConnectUI.onStatusChange((walletInfo) => {
              this.handleWalletConnection(walletInfo);
            });
          } else {
            this.createTONConnectFallback();
          }
        } catch (error) {
          this.createTONConnectFallback();
        }
      }

      createTONConnectFallback() {
        const headerLogo = document.getElementById('headerLogo');
        if (this.user) {
          headerLogo.innerHTML = `
            <div class="user-header">
              <div class="user-avatar">
                ${this.user.photo_url ? 
                  `<img src="${this.user.photo_url}" alt="${this.user.first_name}" class="avatar-image">` :
                  `<div class="avatar-placeholder">${this.user.first_name?.charAt(0).toUpperCase() || '–ü'}</div>`
                }
              </div>
              <div class="user-name">${this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
            </div>
          `;
        } else {
          headerLogo.innerHTML = `<img src="img/logo.svg" alt="Potok logo" style="height: 33px;">`;
        }

        if (window.translator && typeof window.translator.updatePageLinks === 'function') {
          setTimeout(() => {
            window.translator.updatePageLinks();
          }, 100);
        }
      }

      updateUserHeader() {
        if (!this.user) return;
        
        const headerLogo = document.getElementById('headerLogo');
        headerLogo.innerHTML = `
          <div class="user-header">
            <div class="user-avatar">
              ${this.user.photo_url ? 
                `<img src="${this.user.photo_url}" alt="${this.user.first_name}" class="avatar-image">` :
                `<div class="avatar-placeholder">${this.user.first_name?.charAt(0).toUpperCase() || '–ü'}</div>`
              }
            </div>
            <div class="user-name">${this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
          </div>
        `;

        if (window.translator && typeof window.translator.updatePageLinks === 'function') {
          setTimeout(() => {
            window.translator.updatePageLinks();
          }, 100);
        }
      }

      updateLinksWithLanguage(lang) {
        const headerLinks = document.getElementById('headerLogo')?.querySelectorAll('a[href*=".html"]');
        if (headerLinks) {
          headerLinks.forEach(link => {
            let href = link.getAttribute('href');
            if (href.includes('?lang=')) {
              href = href.split('?')[0];
            }
            link.setAttribute('href', `${href}?lang=${lang}`);
          });
        }
      }

      initAnalytics() {
        this.trackEvent('app_initialized', {
          user_id: this.user?.id,
          timestamp: Date.now(),
          platform: 'telegram_mini_app'
        });
      }

      async trackPageEntry() {
        try {
          if (!this.user || !this.user.id) {
            console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram');
            return;
          }

          const userData = {
            user_id: this.user.id,
            first_name: this.user.first_name || '',
            last_name: this.user.last_name || '',
            username: this.user.username || '',
            language_code: this.user.language_code || '',
            entry_time: new Date().toISOString(),
            page: 'index',
            user_agent: navigator.userAgent,
            platform: this.tg?.platform || 'unknown',
            action: 'track-entry'
          };

          console.log('üìä –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);

          const params = new URLSearchParams({
            user_id: userData.user_id,
            first_name: userData.first_name,
            last_name: userData.last_name,
            username: userData.username,
            language_code: userData.language_code,
            page: userData.page,
            platform: userData.platform,
            action: 'track-entry'
          });

          const img = new Image();
          img.onload = () => console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
          img.onerror = () => console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
          img.src = `https://script.google.com/macros/s/AKfycbw7Fk8czSiLvjjONtja6GwK1jDeczv4LAnfkHG1L21GlbSahR0bVSdTfU1ZqJ8Pl4pn7A/exec?${params}`;

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥–∞:', error);
        }
      }

      async trackPageView(page) {
        try {
          if (!this.user || !this.user.id) {
            return;
          }

          const pageData = {
            user_id: this.user.id,
            page: page,
            timestamp: new Date().toISOString(),
            referrer: 'index.html',
            action: 'track-page'
          };

          const params = new URLSearchParams(pageData);
          const img = new Image();
          img.src = `https://script.google.com/macros/s/AKfycbw7Fk8czSiLvjjONtja6GwK1jDeczv4LAnfkHG1L21GlbSahR0bVSdTfU1ZqJ8Pl4pn7A/exec?${params}`;

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞:', error);
        }
      }

      setupEventListeners() {
        const practiceBtn = document.getElementById('practiceOfDay');
        if (practiceBtn) {
          practiceBtn.addEventListener('click', async () => {
            const practiceType = practiceBtn.getAttribute('data-practice') || 'pond';
            this.handlePracticeClick(practiceType);
            this.triggerHapticFeedback('medium');
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∞–∫—Ç–∏–∫—É –≤ streak
            if (window.streakManager) {
              await window.streakManager.recordPractice(practiceType);
            }
            
            const currentLang = window.translator?.currentLang || 'en';
            window.location.href = `pond.html?lang=${currentLang}`;
          });
        }

        document.querySelectorAll('.card[data-practice]').forEach(card => {
          card.addEventListener('click', async (e) => {
            const practiceType = card.getAttribute('data-practice');
            const title = e.currentTarget.querySelector('.card-title')?.textContent;
            const href = e.currentTarget.getAttribute('href');
            
            this.handlePracticeClick(title);
            this.triggerHapticFeedback('light');
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∞–∫—Ç–∏–∫—É –≤ streak
            if (window.streakManager && practiceType) {
              await window.streakManager.recordPractice(practiceType);
            }
            
            if (href && !href.startsWith('http')) {
              this.trackPageView(href);
            }
          });
        });

        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.currentTarget.querySelector('div')?.textContent;
            const href = e.currentTarget.getAttribute('href');
            
            this.trackEvent('navigation_click', {
              tab: tabName,
              user_id: this.user?.id
            });
            this.triggerHapticFeedback('selection');
            
            if (href && !href.startsWith('http') && href !== 'index.html') {
              this.trackPageView(href);
            }
          });
        });

        document.querySelectorAll('a[href]').forEach(link => {
          link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('http') && href !== '#' && href !== 'index.html') {
              this.trackPageView(href);
            }
          });
        });
      }

      handleWalletConnection(walletInfo) {
        if (walletInfo) {
          this.showWalletStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
          this.trackEvent('wallet_connected', {
            wallet: walletInfo.device?.appName || 'unknown',
            user_id: this.user?.id
          });
        } else {
          this.showWalletStatus('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
          this.trackEvent('wallet_disconnected', {
            user_id: this.user?.id
          });
        }
      }

      handlePracticeClick(practiceType) {
        this.trackEvent('practice_started', {
          practice_type: practiceType,
          user_id: this.user?.id,
          timestamp: Date.now()
        });
      }

      triggerHapticFeedback(type = 'light') {
        if (this.tg?.HapticFeedback) {
          switch (type) {
            case 'light':
              this.tg.HapticFeedback.impactOccurred('light');
              break;
            case 'medium':
              this.tg.HapticFeedback.impactOccurred('medium');
              break;
            case 'heavy':
              this.tg.HapticFeedback.impactOccurred('heavy');
              break;
            case 'selection':
              this.tg.HapticFeedback.selectionChanged();
              break;
          }
        }
      }

      showWalletStatus(message) {
        const statusEl = document.getElementById('walletStatus');
        statusEl.textContent = message;
        statusEl.classList.add('show');
        setTimeout(() => {
          statusEl.classList.remove('show');
        }, 3000);
      }

      trackEvent(eventName, parameters = {}) {
        if (window.TelegramAnalytics) {
          window.TelegramAnalytics.track(eventName, parameters);
        }

        if (typeof gtag !== 'undefined') {
          gtag('event', eventName, {
            event_category: 'telegram_mini_app',
            event_label: parameters.practice_type || 'unknown',
            custom_parameter_1: parameters.user_id,
            custom_parameter_2: parameters.practice_type,
            value: 1
          });
        }
      }
    }

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', () => {
      // 1. –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
      window.translator = new Translator();
      
      // 2. –ó–∞—Ç–µ–º Telegram App (–∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç streak manager)
      window.potokApp = new PotokTelegramApp();
      
      // 3. –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
      setTimeout(() => {
        window.translator.updatePageLinks();
      }, 1500);
    });
  </script>
</body>
</html>