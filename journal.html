<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title data-translate="page_title">Potok ‚Äî Profile</title>
  
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- üîó TON Connect SDK - –î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
  <script>
    // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï URL —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
const NOTIFICATIONS_API = 'https://script.google.com/macros/s/AKfycbwm7GCmnIEgB-9KhcDZ4IYzxwhi36Kt16tnRrtBXJZBW6UrttjMQjRydqKR3uVjM2rf/exec';
const PAYMENTS_API = 'https://script.google.com/macros/s/AKfycbwpTrE1ffwXCD_xEfI5_68gtjQxXZKFSMhJWzAj8rp71V7pNTl0nYogOHYjIOjaOKmN-g/exec';

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4834XVE45Z', {
      enhanced_measurement: true
    });

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    function trackNotificationToggle(type, enabled) {
      console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', type, enabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ');
      gtag('event', 'notification_toggle', {
        event_category: 'profile',
        event_label: type,
        value: enabled ? 1 : 0
      });
    }

    function trackSupportClick() {
      console.log('–ö–ª–∏–∫ –ø–æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ');
      gtag('event', 'support_click', {
        event_category: 'profile',
        event_label: 'telegram_support',
        value: 1
      });
    }

    function trackDonationClick(amount) {
      console.log('–ö–ª–∏–∫ –ø–æ –¥–æ–Ω–∞—Ç—É:', amount, 'Stars');
      gtag('event', 'donation_click', {
        event_category: 'monetization',
        event_label: 'stars_donation',
        value: amount
      });
    }

    function trackDonationSuccess(amount) {
      console.log('–£—Å–ø–µ—à–Ω—ã–π –¥–æ–Ω–∞—Ç:', amount, 'Stars');
      gtag('event', 'donation_success', {
        event_category: 'monetization',
        event_label: 'stars_donation_completed',
        value: amount
      });
    }

    // üíé –ù–û–í–û–ï: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ TON –ø–ª–∞—Ç–µ–∂–µ–π
    function trackTONDonationClick(amount) {
      console.log('–ö–ª–∏–∫ –ø–æ TON –¥–æ–Ω–∞—Ç—É:', amount, 'TON');
      gtag('event', 'ton_donation_click', {
        event_category: 'monetization',
        event_label: 'ton_donation',
        value: amount
      });
    }

    function trackTONDonationSuccess(amount) {
      console.log('–£—Å–ø–µ—à–Ω—ã–π TON –¥–æ–Ω–∞—Ç:', amount, 'TON');
      gtag('event', 'ton_donation_success', {
        event_category: 'monetization',
        event_label: 'ton_donation_completed',
        value: amount
      });
    }

    function trackInstallPrompt() {
      console.log('–ö–ª–∏–∫ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ PWA');
      gtag('event', 'pwa_install_prompt', {
        event_category: 'profile',
        event_label: 'add_to_homescreen',
        value: 1
      });
    }

    function trackNavigation(navItem) {
      console.log('–ö–ª–∏–∫ –ø–æ —Ç–∞–±—É:', navItem);
      gtag('event', 'navigation', {
        event_category: 'tab_bar',
        event_label: navItem,
        value: 1
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Google Analytics –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ü—Ä–æ—Ñ–∏–ª—å...');
      
      if (typeof gtag !== 'undefined') {
        console.log('‚úÖ Google Analytics —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü—Ä–æ—Ñ–∏–ª–µ!');
        gtag('event', 'profile_page_loaded', {
          event_category: 'page',
          event_label: 'profile'
        });
      } else {
        console.log('‚ùå Google Analytics –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      setTimeout(() => {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(function(tab) {
          tab.addEventListener('click', function() {
            const tabName = tab.querySelector('div')?.textContent || 'Unknown';
            trackNavigation(tabName);
          });
        });
      }, 1000);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      setTimeout(function() {
        gtag('event', 'profile_time_spent', {
          event_category: 'engagement',
          event_label: 'stayed_15_seconds',
          value: 15
        });
      }, 15000);
    });
  </script>

  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
      --card-bg: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.15);
      --donation-gradient: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 163.5px);
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 425px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* Header with back button */
    .header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--main);
      padding: 24px 24px 24px 24px;
      box-sizing: border-box;
    }

    .back-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 32px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: none;
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .back-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-arrow {
      width: 16px;
      height: 16px;
      color: var(--white);
    }

    /* Main container */
    .container {
      max-width: 375px;
      margin: 0 auto;
      padding: 105px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      padding-bottom: 72px;
      box-sizing: border-box;
    }

    /* User Profile Section */
    .user-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 48px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
      transform: scale(1.1);
    }

    .user-avatar-fallback {
      font-size: 32px;
      font-weight: 600;
      color: white;
    }

    .user-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
      text-align: center;
    }

    /* Navigation Items */
    .nav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      height: 80px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .nav-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-item-content {
      display: flex;
      flex-direction: column;
      gap: 0px;
    }

    .nav-item-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      color: var(--white);
      margin: 0;
    }

    .nav-item-subtitle {
      font-size: 12px;
      color: var(--text-2);
      line-height: 16px;
      margin: 0;
    }

    .nav-arrow {
      width: 12px;
      height: 12px;
      color: var(--text-2);
      transition: transform 0.2s;
    }

    .nav-item:hover .nav-arrow {
      transform: translateX(2px);
    }

    /* Donation Section */
    .donation-section {
      background: transparent;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      text-align: center;
      color: var(--white);
      position: relative;
    }

    .donation-header {
      margin-bottom: 20px;
    }

    .donation-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 8px 0;
      letter-spacing: -0.02em;
      color: var(--white);
    }

    .donation-subtitle {
      font-size: 14px;
      font-weight: 400;
      margin: 0;
      color: var(--text-2);
      line-height: 1.4;
    }

    .donation-button {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--white);
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .donation-button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .donation-button:active {
      transform: translateY(0);
      background: rgba(255, 255, 255, 0.2);
    }

    .donation-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .star-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* üíé –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .payment-modal.active {
      display: flex;
    }

    .payment-content {
      background-color: var(--main);
      border-radius: 16px;
      padding: 24px 20px 20px 20px;
      max-width: 320px;
      width: 85%;
      border: 1px solid var(--border);
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .payment-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
    }

    .payment-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .payment-option:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .payment-option:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .payment-option-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .payment-option-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
    }

    .payment-option-subtitle {
      font-size: 12px;
      color: var(--text-2);
      margin: 0;
    }

    .payment-option-icon {
      font-size: 20px;
    }

    /* PWA Install Button */
    .pwa-install {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
      border: none;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 12px;
      display: none;
    }

    .pwa-install:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
    }

    .pwa-install:active {
      transform: translateY(0);
    }

    .pwa-install.show {
      display: block;
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      padding-bottom: calc(12px + 20px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }

    /* Loading state */
    .loading {
      text-align: center;
      color: var(--text-2);
      font-size: 14px;
      margin: 24px 0;
      display: none;
    }

    /* Modal for notifications */
    .notifications-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .notifications-modal.active {
      display: flex;
    }

    .notifications-content {
      background-color: var(--main);
      border-radius: 16px;
      padding: 24px 20px 20px 20px;
      max-width: 320px;
      width: 85%;
      border: 1px solid var(--border);
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .notifications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .notifications-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 8px;
      margin: -8px -8px -8px 8px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 18px;
      line-height: 1;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }

    .notification-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-label {
      font-size: 14px;
      color: var(--white);
      font-weight: 500;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .toggle-switch.active {
      background: var(--green);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--white);
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Bottom spacer */
    .bottom-spacer {
      height: 32px;
    }

    /* Status messages */
    .status-message {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--green);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .status-message.show {
      opacity: 1;
    }

    .status-message.error {
      background: #EA4335;
    }

    .status-message.warning {
      background: #FF9500;
    }

    /* Success Payment Notification */
    .success-payment-notification {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .success-payment-notification.show {
      opacity: 1;
      visibility: visible;
    }

    .success-notification-content {
      background: linear-gradient(135deg, #19191B 0%, #2a2a2d 100%);
      border-radius: 20px;
      padding: 32px 24px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }

    .success-payment-notification.show .success-notification-content {
      transform: scale(1);
    }

    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .success-title {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .success-subtitle {
      font-size: 16px;
      font-weight: 600;
      color: #FFD527;
      margin-bottom: 16px;
    }

    .success-description {
      font-size: 14px;
      color: #b3b3b3;
      line-height: 1.4;
      margin-bottom: 0;
    }

    .success-close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #b3b3b3;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      line-height: 1;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .success-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <!-- Header with back button -->
  <div class="header">
    <button class="back-button" onclick="window.location.href='index.html'">
      <svg class="back-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div></div>
  </div>

  <!-- Status message -->
  <div class="status-message" id="statusMessage"></div>

  <div class="container">
    <!-- User Profile Section -->
    <div class="user-profile">
      <div class="user-avatar" id="userAvatar">
        <div class="user-avatar-fallback" id="userAvatarFallback">U</div>
      </div>
      <h1 class="user-name" id="userName" data-translate="guest_user">Guest User</h1>
    </div>

    <!-- Support Section -->
    <div class="nav-item" onclick="openSupport()">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
        <p class="nav-item-subtitle" data-translate="contact_support">–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <!-- Notifications Section -->
    <div class="nav-item" onclick="openNotificationsModal()">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="notifications">–û–ø–æ–≤–µ—â–µ–Ω–∏—è</h3>
        <p class="nav-item-subtitle" data-translate="notification_settings">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <!-- PWA Install Button -->
    <button class="pwa-install" id="pwaInstall" data-translate="add_to_homescreen">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>

    <!-- Terms of Use Section -->
    <div class="nav-item" onclick="window.location.href='privacy.html'">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="terms_of_use">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
        <p class="nav-item-subtitle" data-translate="read_terms">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <!-- Donation Section - –í–ò–ó–£–ê–õ–¨–ù–û –ò–î–ï–ù–¢–ò–ß–ù–û, –Ω–æ —Å –≥–∏–±—Ä–∏–¥–Ω–æ–π –ª–æ–≥–∏–∫–æ–π -->
    <div class="donation-section">
      <div class="donation-header">
        <h3 class="donation-title" data-translate="donation_title">Keep the flame alive</h3>
        <p class="donation-subtitle" data-translate="donation_subtitle">Sometimes we need a little fuel to keep moving</p>
      </div>
      <button class="donation-button" id="donationButton" onclick="openDonationOptions()">
        <svg class="star-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L14.09 8.26L22 8.27L15.95 12.74L18.18 19.02L12 14.77L5.82 19.02L8.05 12.74L2 8.27L9.91 8.26L12 2Z" fill="currentColor"/>
        </svg>
        <span data-translate="donation_button">Support</span>
      </button>
    </div>

    <div class="bottom-spacer"></div>
  </div>

  <!-- üíé –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ TON –∫–æ—à–µ–ª—å–∫–∞) -->
  <div class="payment-modal" id="paymentModal">
    <div class="payment-content">
      <div class="payment-header">
        <h3 class="payment-title" data-translate="choose_payment">Choose payment method</h3>
        <button class="close-button" id="closePaymentModal">‚úï</button>
      </div>
      
      <!-- Telegram Stars - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± -->
      <div class="payment-option" onclick="payWithStars()">
        <div class="payment-option-content">
          <div class="payment-option-title" data-translate="telegram_stars">Telegram Stars</div>
          <div class="payment-option-subtitle" data-translate="stars_description">50 Stars ‚Ä¢ Fast & Easy</div>
        </div>
        <div class="payment-option-icon">‚≠ê</div>
      </div>
      
      <!-- TON Connect - –ø—Ä–µ–º–∏—É–º —Å–ø–æ—Å–æ–± -->
      <div class="payment-option" onclick="payWithTON()" id="tonPaymentOption">
        <div class="payment-option-content">
          <div class="payment-option-title" data-translate="ton_crypto">TON Cryptocurrency</div>
          <div class="payment-option-subtitle" data-translate="ton_description">0.1 TON ‚Ä¢ Premium Support</div>
        </div>
        <div class="payment-option-icon">üíé</div>
      </div>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div class="notifications-modal" id="notificationsModal">
    <div class="notifications-content">
      <div class="notifications-header">
        <h3 class="notifications-title" data-translate="notifications">–û–ø–æ–≤–µ—â–µ–Ω–∏—è</h3>
        <button class="close-button" id="closeNotifications">‚úï</button>
      </div>
      
      <div class="notification-item">
        <div class="notification-label" data-translate="emotion_calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —ç–º–æ—Ü–∏–π</div>
        <div class="toggle-switch" id="emotionToggle"></div>
      </div>
    </div>
  </div>

  <!-- Tab bar -->
  <footer class="tab-bar">
    <a href="index.html" class="tab">
      <img src="img/home.svg" alt="Today">
      <div data-translate="tab_today">Today</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="tab_practices">Practices</div>
    </a>
    <a href="journal.html" class="tab active">
      <img src="img/journal-active.svg" alt="Profile">
      <div data-translate="tab_profile">Profile</div>
    </a>
  </footer>

  <script>
    // –ê–ù–¢–ò-–°–ü–ê–ú –ó–ê–©–ò–¢–ê - –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    let DONATION_IN_PROGRESS = false;
    let LAST_PAYMENT_TIMESTAMP = 0;
    const PAYMENT_COOLDOWN = 5000; // 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–ª–∞—Ç–µ–∂–∞–º–∏

    // üîó TON Connect –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
    let tonConnectUI = null;
    let isTONWalletConnected = false;

    // üîó –ù–û–í–´–ô: –°–µ—Ä–≤–∏—Å TON Connect –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Telegram
    class TONConnectService {
      constructor() {
        this.tonConnectUI = null;
        this.isConnected = false;
        this.walletAddress = null;
        this.initTONConnect();
      }

      async initTONConnect() {
        try {
          console.log('üîó –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect SDK...');
          
          // –°–æ–∑–¥–∞–µ–º manifest –¥–ª—è TON Connect
          const manifestUrl = this.createTONManifest();
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TON Connect UI
          this.tonConnectUI = new TONConnectUI({
            manifestUrl: manifestUrl,
            buttonRootId: null // –ú—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É
          });

          // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          this.tonConnectUI.onStatusChange((wallet) => {
            if (wallet) {
              console.log('‚úÖ TON –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω:', wallet.account.address);
              this.isConnected = true;
              this.walletAddress = wallet.account.address;
              isTONWalletConnected = true;
            } else {
              console.log('‚ùå TON –∫–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
              this.isConnected = false;
              this.walletAddress = null;
              isTONWalletConnected = false;
            }
          });

          console.log('‚úÖ TON Connect SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TON Connect:', error);
        }
      }

      createTONManifest() {
        // –°–æ–∑–¥–∞–µ–º manifest –¥–ª—è TON Connect –≤ –ø–∞–º—è—Ç–∏
        const manifest = {
          url: 'https://spokspace.com',
          name: 'Spokspace',
          iconUrl: 'https://spokspace.com/img/logo.png',
          termsOfUseUrl: 'https://spokspace.com/privacy.html',
          privacyPolicyUrl: 'https://spokspace.com/privacy.html'
        };

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º URL –¥–ª—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        return `data:application/json,${encodeURIComponent(JSON.stringify(manifest))}`;
      }

      async connectWallet() {
        try {
          console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TON –∫–æ—à–µ–ª—å–∫–∞...');
          await this.tonConnectUI.connectWallet();
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
          throw error;
        }
      }

      async sendTONPayment(amount = 0.1) {
        if (!this.isConnected) {
          throw new Error('TON –∫–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }

        try {
          console.log(`üíé –û—Ç–ø—Ä–∞–≤–∫–∞ ${amount} TON...`);
          
          const transaction = {
            validUntil: Date.now() + 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
            messages: [
              {
                address: "EQC_1YoM8RBixN95lz7odcF3Vrkc_N8Ne7gQi7Abtlet_Efi", // –ê–¥—Ä–µ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è TON
                amount: (amount * 1000000000).toString(), // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ nanoTON
                payload: "te6cckEBAQEADAAMABQAAAAASGVsbG8hCaTc/g==" // "Hello!" –≤ base64
              }
            ]
          };

          const result = await this.tonConnectUI.sendTransaction(transaction);
          console.log('‚úÖ TON –ø–ª–∞—Ç–µ–∂ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', result);
          return result;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ TON –ø–ª–∞—Ç–µ–∂–∞:', error);
          throw error;
        }
      }

      async disconnectWallet() {
        if (this.tonConnectUI) {
          await this.tonConnectUI.disconnect();
        }
      }
    }

    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
    class ApiService {
      constructor() {
        this.userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        this.retryCount = 2;
        this.retryDelay = 1000;
        console.log('üåç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ:', this.userTimezone);
      }

      async makeRequest(apiUrl, action, params = {}) {
        console.log('üì§ GET –∑–∞–ø—Ä–æ—Å:', action, params);
        
        for (let attempt = 1; attempt <= this.retryCount; attempt++) {
          try {
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/${this.retryCount} –¥–ª—è: ${action}`);
            
            const url = new URL(apiUrl);
            url.searchParams.append('action', action);
            
            Object.keys(params).forEach(key => {
              if (params[key] !== null && params[key] !== undefined) {
                url.searchParams.append(key, String(params[key]));
              }
            });

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫:', url.toString().substring(0, 100) + '...');
            
            const response = await fetch(url.toString(), {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache',
              headers: {
                'Accept': 'application/json,text/plain,*/*'
              }
            });

            console.log('üì° –°—Ç–∞—Ç—É—Å:', response.status, response.statusText);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const responseText = await response.text();
            console.log('üìÑ –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞:', responseText.length, '—Å–∏–º–≤–æ–ª–æ–≤');

            let data;
            try {
              data = JSON.parse(responseText);
            } catch (parseError) {
              console.log('‚ö†Ô∏è –û—Ç–≤–µ—Ç –Ω–µ JSON, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...');
              
              if (responseText.includes('SUCCESS') || 
                  responseText.includes('success') || 
                  responseText.includes('"ok":true') ||
                  responseText.includes('"result":')) {
                console.log('‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ (–ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É)');
                data = { success: true, message: 'Operation completed successfully' };
              } else {
                console.error('‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:', responseText.substring(0, 200));
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
              }
            }

            console.log('üì• –û—Ç–≤–µ—Ç:', data);
            return data;
            
          } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ø—ã—Ç–∫–∞ ${attempt}:`, error.message);
            
            if (attempt === this.retryCount) {
              console.error('‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã');
              throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å: ${error.message}`);
            }
            
            console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ${this.retryDelay}–º—Å...`);
            await new Promise(resolve => setTimeout(resolve, this.retryDelay));
          }
        }
      }

      async saveNotificationSettings(userId, notificationEnabled, chatId = null) {
        console.log('üîî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', {
          userId, notificationEnabled, chatId
        });

        const params = {
          user_id: userId,
          notification_enabled: notificationEnabled.toString(),
          timezone: this.userTimezone
        };

        if (chatId) {
          params.chat_id = chatId.toString();
        }

        try {
          const response = await this.makeRequest(NOTIFICATIONS_API, 'save-notification-settings', params);
          console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
          return response;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
          throw error;
        }
      }

      async loadNotificationSettings(userId) {
        console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è:', userId);
        
        try {
          const response = await this.makeRequest(NOTIFICATIONS_API, 'get-notification-settings', { 
            user_id: userId 
          });
          console.log('üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', response);
          return response;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          throw error;
        }
      }
    }

    class ProfileService {
      constructor() {
        this.userId = null;
        this.isInitialized = false;
        this.apiService = new ApiService();
        
        this.userInfo = {
          userType: 'guest',
          telegramId: null,
          telegramData: null,
          verified: false,
          userName: '',
          avatarUrl: null
        };
        
        this.notificationSettings = {
          emotions: true,
          hasUserChanges: false
        };
        
        this.STORAGE_KEYS = {
          USER_ID: 'potok_stable_user_id',
          USER_INFO: 'potok_user_info',
          NOTIFICATIONS: 'potok_notification_settings'
        };
        
        this.initializeWithDelay();
      }

      async initializeWithDelay() {
        if (document.readyState !== 'complete') {
          await new Promise(resolve => {
            window.addEventListener('load', resolve, { once: true });
          });
        }

        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ProfileService...');

        this.initializeUserData();
        this.loadNotificationSettings();
        this.isInitialized = true;

        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
          console.log('üì± Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
          
          setTimeout(() => {
            this.initializeUserData();
            this.updateUserUI();
          }, 1000);
        }

        this.loadServerSettings();
      }

      initializeUserData() {
        console.log('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        const telegramData = this.getTelegramUserData();
        
        if (telegramData) {
          this.userInfo.userType = 'telegram';
          this.userInfo.telegramId = telegramData.id;
          this.userInfo.telegramData = telegramData;
          this.userInfo.verified = true;
          
          let userName = '';
          if (telegramData.first_name) {
            userName = telegramData.first_name;
            if (telegramData.last_name) {
              userName += ' ' + telegramData.last_name;
            }
          } else if (telegramData.username) {
            userName = '@' + telegramData.username;
          } else {
            userName = 'Telegram User';
          }
          
          this.userInfo.userName = userName;
          this.userInfo.avatarUrl = telegramData.photo_url;
          this.userId = `tg_${telegramData.id}`;
          
          console.log('üéØ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', {
            userName: this.userInfo.userName,
            userId: this.userId
          });
          
          this.saveUserInfoToLocalStorage();
        } else {
          console.log('üë§ –ì–æ—Å—Ç–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
          this.loadUserInfoFromLocalStorage();
          
          if (!this.userId) {
            this.userId = this.generateGuestUserId();
          }
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:', {
          userId: this.userId,
          userType: this.userInfo.userType,
          userName: this.userInfo.userName
        });
        
        setTimeout(() => this.updateUserUI(), 100);
      }

      getTelegramUserData() {
        try {
          if (typeof window.Telegram === 'undefined' || 
              !window.Telegram.WebApp || 
              !window.Telegram.WebApp.initDataUnsafe ||
              !window.Telegram.WebApp.initDataUnsafe.user?.id) {
            console.log('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            return null;
          }
          
          const user = window.Telegram.WebApp.initDataUnsafe.user;
          console.log('üì± –î–∞–Ω–Ω—ã–µ Telegram:', {
            id: user.id,
            first_name: user.first_name,
            last_name: user.last_name,
            username: user.username
          });
          
          return {
            id: user.id,
            first_name: user.first_name,
            last_name: user.last_name,
            username: user.username,
            language_code: user.language_code,
            photo_url: user.photo_url,
            is_premium: user.is_premium || false
          };
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ Telegram –¥–∞–Ω–Ω—ã—Ö:', error);
          return null;
        }
      }

      updateUserUI() {
        const userNameElement = document.getElementById('userName');
        const userAvatarElement = document.getElementById('userAvatar');
        
        if (!userNameElement || !userAvatarElement) {
          console.log('‚ö†Ô∏è UI —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –≥–æ—Ç–æ–≤—ã');
          return;
        }
        
        if (this.userInfo.userType === 'telegram') {
          const userName = this.userInfo.userName || 'Telegram User';
          userNameElement.textContent = userName;
          
          if (this.userInfo.avatarUrl) {
            console.log('üì∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä:', this.userInfo.avatarUrl);
            
            userAvatarElement.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = this.userInfo.avatarUrl;
            img.alt = userName;
            img.style.cssText = `
              width: 100%;
              height: 100%;
              object-fit: cover;
              object-position: center center;
              border-radius: 50%;
              position: absolute;
              top: 0;
              left: 0;
              transform: scale(1.1);
            `;
            
            img.onload = () => {
              console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
            };
            
            img.onerror = () => {
              console.log('‚ùå –û—à–∏–±–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã');
              userAvatarElement.innerHTML = `<div class="user-avatar-fallback">${userName.charAt(0).toUpperCase()}</div>`;
            };
            
            userAvatarElement.appendChild(img);
            
          } else {
            console.log('üì∑ –ê–≤–∞—Ç–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            userAvatarElement.innerHTML = `<div class="user-avatar-fallback">${userName.charAt(0).toUpperCase()}</div>`;
          }
        } else {
          const guestText = window.translator ? window.translator.translate('guest_user') : 'Guest User';
          userNameElement.textContent = guestText;
          userAvatarElement.innerHTML = '<div class="user-avatar-fallback">G</div>';
        }
        
        console.log('‚úÖ UI –æ–±–Ω–æ–≤–ª–µ–Ω');
      }

      generateGuestUserId() {
        try {
          const savedId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          if (savedId && !savedId.startsWith('tg_')) {
            return savedId;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ localStorage:', error);
        }

        const newId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        try {
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, newId);
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ID');
        }
        
        return newId;
      }

      saveUserInfoToLocalStorage() {
        try {
          const userInfoToSave = {
            ...this.userInfo,
            lastSeen: new Date().toISOString()
          };
          
          localStorage.setItem(this.STORAGE_KEYS.USER_INFO, JSON.stringify(userInfoToSave));
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, this.userId);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        }
      }

      loadUserInfoFromLocalStorage() {
        try {
          const savedUserInfo = localStorage.getItem(this.STORAGE_KEYS.USER_INFO);
          const savedUserId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          
          if (savedUserInfo) {
            const parsedInfo = JSON.parse(savedUserInfo);
            this.userInfo = { ...this.userInfo, ...parsedInfo };
          }
          
          if (savedUserId) {
            this.userId = savedUserId;
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
      }

      loadNotificationSettings() {
        try {
          const savedSettings = localStorage.getItem(this.STORAGE_KEYS.NOTIFICATIONS);
          if (savedSettings) {
            const parsedSettings = JSON.parse(savedSettings);
            this.notificationSettings = { ...this.notificationSettings, ...parsedSettings };
            console.log('üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage');
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
        }
      }

      async loadServerSettings() {
        if (!this.userId) return;

        try {
          console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞...');
          const response = await this.apiService.loadNotificationSettings(this.userId);
          
          if (response && response.notification_enabled !== undefined) {
            const serverEnabled = response.notification_enabled === 'true' || response.notification_enabled === true;
            
            if (!this.notificationSettings.hasUserChanges) {
              console.log('üì• –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
              this.notificationSettings.emotions = serverEnabled;
              this.saveNotificationSettings();
            }
            
            this.updateNotificationToggles();
          }
          
          setTimeout(() => this.updateUserUI(), 200);
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
        }
      }

      saveNotificationSettings() {
        try {
          const settingsToSave = {
            ...this.notificationSettings,
            hasUserChanges: true,
            lastModified: new Date().toISOString()
          };
          
          localStorage.setItem(this.STORAGE_KEYS.NOTIFICATIONS, JSON.stringify(settingsToSave));
          console.log('üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        }
      }

      async toggleNotification(type) {
        console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:', type);
        
        const oldValue = this.notificationSettings[type];
        const newValue = !oldValue;
        
        this.notificationSettings[type] = newValue;
        this.notificationSettings.hasUserChanges = true;
        this.updateNotificationToggles();
        
        trackNotificationToggle(type, newValue);
        this.saveNotificationSettings();
        
        try {
          const chatId = this.userInfo.telegramData?.id || null;
          await this.apiService.saveNotificationSettings(this.userId, newValue, chatId);
          
          this.showStatusMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
          this.showStatusMessage('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
        }
      }

      updateNotificationToggles() {
        const emotionToggle = document.getElementById('emotionToggle');
        if (emotionToggle) {
          emotionToggle.classList.toggle('active', this.notificationSettings.emotions);
        }
      }

      showStatusMessage(message, type = 'success') {
        const statusElement = document.getElementById('statusMessage');
        if (!statusElement) return;

        statusElement.textContent = message;
        
        let className = 'status-message show';
        if (type === 'error') {
          className += ' error';
        } else if (type === 'warning') {
          className += ' warning';
        }
        
        statusElement.className = className;

        setTimeout(() => {
          statusElement.classList.remove('show');
        }, 3000);
      }
    }

    class PWAInstaller {
      constructor() {
        this.deferredPrompt = null;
        this.setupInstallPrompt();
      }

      setupInstallPrompt() {
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          this.deferredPrompt = e;
          this.showInstallButton();
        });

        window.addEventListener('appinstalled', () => {
          this.hideInstallButton();
        });
      }

      showInstallButton() {
        const installButton = document.getElementById('pwaInstall');
        if (installButton) {
          installButton.classList.add('show');
        }
      }

      hideInstallButton() {
        const installButton = document.getElementById('pwaInstall');
        if (installButton) {
          installButton.classList.remove('show');
        }
      }

      async install() {
        if (!this.deferredPrompt) return;

        this.deferredPrompt.prompt();
        const { outcome } = await this.deferredPrompt.userChoice;
        
        console.log('PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞:', outcome);
        this.deferredPrompt = null;
        this.hideInstallButton();
      }
    }

    const translations = {
      en: {
        page_title: "Potok ‚Äî Profile",
        guest_user: "Guest User",
        support: "Support",
        contact_support: "Contact support",
        notifications: "Notifications",
        notification_settings: "Configure reminders",
        terms_of_use: "Terms of Use",
        read_terms: "Read the rules",
        add_to_homescreen: "Add to Home Screen",
        emotion_calendar: "Emotion Calendar",
        tab_today: "Today",
        tab_practices: "Practices", 
        tab_profile: "Profile",
        donation_title: "Keep the flame alive",
        donation_subtitle: "Sometimes we need a little fuel to keep moving",
        donation_button: "Support",
        choose_payment: "Choose payment method",
        telegram_stars: "Telegram Stars",
        stars_description: "50 Stars ‚Ä¢ Fast & Easy",
        ton_crypto: "TON Cryptocurrency",
        ton_description: "0.1 TON ‚Ä¢ Premium Support"
      },
      ru: {
        page_title: "Potok ‚Äî –ü—Ä–æ—Ñ–∏–ª—å",
        guest_user: "–ì–æ—Å—Ç–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        support: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        contact_support: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
        notifications: "–û–ø–æ–≤–µ—â–µ–Ω–∏—è",
        notification_settings: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
        terms_of_use: "–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
        read_terms: "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞",
        add_to_homescreen: "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω",
        emotion_calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —ç–º–æ—Ü–∏–π",
        tab_today: "–°–µ–≥–æ–¥–Ω—è",
        tab_practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏",
        tab_profile: "–ü—Ä–æ—Ñ–∏–ª—å",
        donation_title: "–ß—Ç–æ–±—ã –Ω–µ –∑–∞–≥–ª–æ—Ö–ª–æ",
        donation_subtitle: "–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ",
        donation_button: "–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å",
        choose_payment: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã",
        telegram_stars: "Telegram Stars",
        stars_description: "50 Stars ‚Ä¢ –ë—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ",
        ton_crypto: "TON –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞",
        ton_description: "0.1 TON ‚Ä¢ –ü—Ä–µ–º–∏—É–º –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
      }
    };

    class Translator {
      constructor() {
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        this.currentLang = this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'en';
        this.init();
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('lang');
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        
        try {
          return localStorage.getItem('potok_language');
        } catch (error) {
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => this.setLanguage('en'));
        document.getElementById('ruBtn')?.addEventListener('click', () => this.setLanguage('ru'));
      }

      setLanguage(lang) {
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
          } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —è–∑—ã–∫');
          }
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
        } catch (error) {
          console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL');
        }
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        document.documentElement.lang = lang;
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        
        links.forEach(link => {
          let href = link.getAttribute('href');
          
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          
          if (href.includes('#')) {
            href = href.split('#')[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
        });
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          element.textContent = translation;
        });
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
          }
        });
      }
    }

    // =====================================================
    // üîó –ù–û–í–ê–Ø –ì–ò–ë–†–ò–î–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ï–ô
    // =====================================================

    // üéØ –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É "Support"
    async function openDonationOptions() {
      console.log('üí∞ –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–ø—Ü–∏–π –¥–æ–Ω–∞—Ç–∞ (–≥–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)');
      
      // –ó–ê–©–ò–¢–ê 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏–¥–µ—Ç –ª–∏ —É–∂–µ –ø–ª–∞—Ç–µ–∂
      if (DONATION_IN_PROGRESS) {
        console.log('üö´ –ü–ª–∞—Ç–µ–∂ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –±–ª–æ–∫–∏—Ä—É–µ–º');
        window.profileService?.showStatusMessage('‚è≥ –ü–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...', 'warning');
        return;
      }

      // –ó–ê–©–ò–¢–ê 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown –º–µ–∂–¥—É –ø–ª–∞—Ç–µ–∂–∞–º–∏
      const now = Date.now();
      if (now - LAST_PAYMENT_TIMESTAMP < PAYMENT_COOLDOWN) {
        console.log('üö´ –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ, –±–ª–æ–∫–∏—Ä—É–µ–º');
        window.profileService?.showStatusMessage('‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –ø–ª–∞—Ç–µ–∂–æ–º', 'warning');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
      if (typeof window.Telegram === 'undefined' || !window.Telegram.WebApp) {
        console.log('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        window.profileService?.showStatusMessage('‚ùå –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Telegram', 'error');
        return;
      }

      // üîó –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê: –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å TON –∫–æ—à–µ–ª–µ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      // –ï—Å–ª–∏ –Ω–µ—Ç - —Å—Ä–∞–∑—É –∏–¥–µ–º –∫ Telegram Stars
      if (window.tonConnectService && window.tonConnectService.isConnected) {
        console.log('üíé TON –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã');
        openPaymentModal();
      } else {
        console.log('‚≠ê TON –∫–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram Stars');
        payWithStars();
      }
    }

    // üíé –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    function openPaymentModal() {
      document.getElementById('paymentModal').classList.add('active');
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').classList.remove('active');
    }

    // ‚≠ê –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ Telegram Stars (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
    async function payWithStars() {
      console.log('‚≠ê –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ Telegram Stars');
      closePaymentModal();
      
      // –ó–ê–©–ò–¢–ê 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –Ω–∞—á–∞—Ç
      DONATION_IN_PROGRESS = true;
      LAST_PAYMENT_TIMESTAMP = Date.now();
      
      const button = document.getElementById('donationButton');
      const originalText = button.innerHTML;
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      button.disabled = true;
      button.innerHTML = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';
      
      try {
        const amount = 50;
        trackDonationClick(amount);
        
        const title = window.translator ? window.translator.translate('donation_title') : 'Support Spokspace';
        const description = window.translator ? window.translator.translate('donation_subtitle') : 'Thank you for your support!';
        const userId = window.profileService?.userId || 'unknown';
        
        console.log('üì§ –°–æ–∑–¥–∞–µ–º Stars invoice...');
        
        window.profileService?.showStatusMessage('üí´ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...', 'info');
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π timestamp –¥–ª—è —ç—Ç–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
        const paymentTimestamp = Date.now();
        
        const params = new URLSearchParams({
          action: 'create-invoice',
          user_id: userId,
          amount: amount.toString(),
          title: title,
          description: description,
          timestamp: paymentTimestamp.toString()
        });
        
        const invoiceResponse = await fetch(`${PAYMENTS_API}?${params.toString()}`, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!invoiceResponse.ok) {
          throw new Error(`HTTP ${invoiceResponse.status}`);
        }
        
        const invoiceData = await invoiceResponse.json();
        
        if (!invoiceData.success || !invoiceData.invoice_url) {
          throw new Error(invoiceData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å invoice');
        }
        
        console.log('‚úÖ Stars Invoice —Å–æ–∑–¥–∞–Ω:', invoiceData.invoice_url);
        
        window.profileService?.showStatusMessage('üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—Ç–µ–∂–∞...', 'info');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API
        window.Telegram.WebApp.openInvoice(invoiceData.invoice_url, (status) => {
          console.log('üí≥ –°—Ç–∞—Ç—É—Å Stars –ø–ª–∞—Ç–µ–∂–∞:', status);
          
          if (status === 'paid') {
            console.log('‚úÖ Stars –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω!');
            trackDonationSuccess(amount);
            showSuccessfulPaymentNotification(amount, 'stars');
            
            if (window.Telegram.WebApp.HapticFeedback) {
              window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
            
          } else if (status === 'cancelled') {
            console.log('‚ùå Stars –ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω');
            window.profileService?.showStatusMessage('üîÑ –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω', 'warning');
            
          } else if (status === 'failed') {
            console.log('‚ùå –û—à–∏–±–∫–∞ Stars –ø–ª–∞—Ç–µ–∂–∞');
            window.profileService?.showStatusMessage('‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞', 'error');
          }

          // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
          setTimeout(() => {
            DONATION_IN_PROGRESS = false;
          }, 2000);
        });
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Stars –ø–ª–∞—Ç–µ–∂–∞:', error);
        window.profileService?.showStatusMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞', 'error');
        DONATION_IN_PROGRESS = false;
        
      } finally {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        }, 2000);
      }
    }

    // üíé –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ TON (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)
    async function payWithTON() {
      console.log('üíé –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ TON');
      closePaymentModal();
      
      if (!window.tonConnectService || !window.tonConnectService.isConnected) {
        console.log('üîó TON –∫–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º...');
        
        try {
          await window.tonConnectService.connectWallet();
          console.log('‚úÖ TON –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è TON –∫–æ—à–µ–ª—å–∫–∞:', error);
          window.profileService?.showStatusMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫', 'error');
          return;
        }
      }

      // –ó–ê–©–ò–¢–ê 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –Ω–∞—á–∞—Ç
      DONATION_IN_PROGRESS = true;
      LAST_PAYMENT_TIMESTAMP = Date.now();
      
      const button = document.getElementById('donationButton');
      const originalText = button.innerHTML;
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      button.disabled = true;
      button.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ TON...';
      
      try {
        const amount = 0.1; // 0.1 TON
        trackTONDonationClick(amount);
        
        console.log('üíé –û—Ç–ø—Ä–∞–≤–ª—è–µ–º TON –ø–ª–∞—Ç–µ–∂...');
        window.profileService?.showStatusMessage('üíé –û—Ç–ø—Ä–∞–≤–∫–∞ TON...', 'info');
        
        const result = await window.tonConnectService.sendTONPayment(amount);
        
        console.log('‚úÖ TON –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω:', result);
        trackTONDonationSuccess(amount);
        showSuccessfulPaymentNotification(amount, 'ton');
        
        if (window.Telegram.WebApp.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ TON –ø–ª–∞—Ç–µ–∂–∞:', error);
        window.profileService?.showStatusMessage('‚ùå –û—à–∏–±–∫–∞ TON –ø–ª–∞—Ç–µ–∂–∞', 'error');
        
      } finally {
        // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        DONATION_IN_PROGRESS = false;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        }, 2000);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ç–∏–ø–∞)
    function showSuccessfulPaymentNotification(amount, type = 'stars') {
      const notification = createSuccessNotification(amount, type);
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
      
      const message = type === 'ton' ? 
        '‚úÖ TON payment successful!' : 
        '‚úÖ Thanks for your support!';
      
      window.profileService?.showStatusMessage(message, 'success');
    }

    function createSuccessNotification(amount, type = 'stars') {
      const notification = document.createElement('div');
      notification.className = 'success-payment-notification';
      
      const icon = type === 'ton' ? 'üíé' : 'üîµ';
      const currency = type === 'ton' ? 'TON' : 'Stars ‚≠ê';
      const title = type === 'ton' ? 
        'TON Payment Successful!' : 
        'Thanks for your support!';
      
      notification.innerHTML = `
        <div class="success-notification-content">
          <div class="success-icon">${icon}</div>
          <div class="success-title">${title}</div>
          <div class="success-subtitle">You've backed Spokspace with ${amount} ${currency}</div>
          <div class="success-description">
            Your support helps us keep developing mindfulness practices and tools for mental wellbeing.
          </div>
          <button class="success-close-btn" onclick="this.parentElement.parentElement.classList.remove('show')">
            ‚úï
          </button>
        </div>
      `;
      
      return notification;
    }

    // Global functions
    function openSupport() {
      trackSupportClick();
      window.open('https://t.me/spoksupport_bot', '_blank');
    }

    function openNotificationsModal() {
      document.getElementById('notificationsModal').classList.add('active');
    }

    function closeNotificationsModal() {
      document.getElementById('notificationsModal').classList.remove('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üì± DOM –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è Profile.html —Å TON Connect');
      console.log('üõ°Ô∏è –ê–Ω—Ç–∏-—Å–ø–∞–º –∑–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞!');
      console.log('üîó TON Connect SDK –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Telegram');
      
      // Initialize Telegram WebApp
      if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
        console.log('üì± Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
        try {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ Telegram WebApp:', error);
        }
      }
      
      // Initialize services
      window.translator = new Translator();
      window.profileService = new ProfileService();
      window.pwaInstaller = new PWAInstaller();
      
      // üîó Initialize TON Connect Service
      window.tonConnectService = new TONConnectService();
      
      // Setup event listeners
      setupEventListeners();
      
      console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å TON Connect SDK');
    });

    function setupEventListeners() {
      // Notification modal
      document.getElementById('closeNotifications')?.addEventListener('click', closeNotificationsModal);
      
      document.getElementById('notificationsModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('notificationsModal')) {
          closeNotificationsModal();
        }
      });
      
      // Payment modal
      document.getElementById('closePaymentModal')?.addEventListener('click', closePaymentModal);
      
      document.getElementById('paymentModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('paymentModal')) {
          closePaymentModal();
        }
      });
      
      // Notification toggles
      document.getElementById('emotionToggle')?.addEventListener('click', async () => {
        await window.profileService.toggleNotification('emotions');
      });
      
      // PWA install
      document.getElementById('pwaInstall')?.addEventListener('click', () => {
        trackInstallPrompt();
        window.pwaInstaller.install();
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      setTimeout(() => {
        if (window.profileService) {
          window.profileService.updateNotificationToggles();
          window.profileService.updateUserUI();
        }
      }, 500);
    }

    function updateUserUI() {
      if (window.profileService) {
        window.profileService.updateUserUI();
      } else {
        console.log('‚ö†Ô∏è ProfileService –Ω–µ –≥–æ—Ç–æ–≤');
        const userNameElement = document.getElementById('userName');
        if (userNameElement && window.translator) {
          userNameElement.textContent = window.translator.translate('guest_user');
        }
      }
    }
  </script>
</body>
</html>