<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title data-translate="page_title">Calm Dots</title>
  
  <!-- Telegram WebApp Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
      
      --color-green: #34A853;
      --color-yellow: #FFD527;
      --color-blue: #4285F4;
      --color-pink: #FF7DB0;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
      overflow-x: hidden;
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      position: relative;
    }

    /* –§–∏–∫—Å –¥–ª—è WebView –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */
    @supports (-webkit-touch-callout: none) {
      html, body {
        height: -webkit-fill-available;
      }
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 163.5px);
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 425px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* Header with back button */
    .header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--main);
      padding: 24px;
      box-sizing: border-box;
    }

    .back-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 32px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: none;
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .back-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-arrow {
      width: 16px;
      height: 16px;
      color: var(--white);
    }

    /* Main container */
    .container {
      max-width: 375px;
      margin: 0 auto;
      padding: 100px 24px 96px 24px;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 196px);
      box-sizing: border-box;
    }

    @supports (-webkit-touch-callout: none) {
      .container {
        min-height: calc(-webkit-fill-available - 196px);
      }
    }

    /* Game header */
    .game-header {
      margin-bottom: 40px;
      text-align: left;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUpFade 0.8s ease-out 0.5s forwards;
    }

    .game-title {
      font-size: 24px;
      line-height: 32px;
      font-weight: 600;
      color: var(--white);
      margin: 0 0 4px 0;
      padding: 0;
    }

    .game-subtitle {
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
      color: var(--text-2);
      margin: 0;
      padding: 0;
    }

    /* Game board */
    .game-board {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 8px 15px;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(30px);
      animation: slideUpFade 0.8s ease-out 0.9s forwards;
      max-height: min(70vh, 500px);
    }

    .dots-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 350px;
      aspect-ratio: 1;
    }

    .dot {
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      border: 3px solid transparent;
      box-sizing: border-box;
      width: 85%;
      height: 85%;
      margin: auto;
    }

    .dot:hover {
      transform: scale(1.05);
    }

    .dot.selected {
      border-color: rgba(255, 255, 255, 0.6);
      transform: scale(1.1);
      z-index: 10;
    }

    .dot.green { background-color: var(--color-green); }
    .dot.yellow { background-color: var(--color-yellow); }
    .dot.blue { background-color: var(--color-blue); }
    .dot.pink { background-color: var(--color-pink); }

    .dot.falling {
      animation: fall 0.5s ease-in-out;
    }

    @keyframes fall {
      from {
        transform: translateY(-100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .dot.removing {
      animation: remove 0.3s ease-in-out forwards;
    }

    @keyframes remove {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }

    /* Game stats */
    .game-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 40px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUpFade 0.8s ease-out 0.7s forwards;
    }

    .stat-item {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px 16px;
      text-align: center;
      flex: 1;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--white);
      margin: 0 0 4px 0;
    }

    .stat-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Game Over Modal */
    .game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .game-over-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .game-over-content {
      background-color: var(--main);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .game-over-modal.show .game-over-content {
      transform: scale(1);
    }

    .game-over-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-2);
      margin: 0 0 8px 0;
    }

    .game-over-score {
      font-size: 32px;
      font-weight: 700;
      color: var(--white);
      margin: 0 0 24px 0;
    }

    .play-again-button {
      background-color: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      color: var(--white);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: "Inter", sans-serif;
      width: 100%;
    }

    .play-again-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .play-again-button:active {
      background-color: rgba(255, 255, 255, 0.15);
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Connection line */
    .connection-line {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }

    .line-segment {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 2px;
      transform-origin: left center;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <!-- Header with back button -->
  <div class="header">
    <button class="back-button" onclick="window.history.back()">
      <svg class="back-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div></div>
  </div>

  <div class="container">
    <!-- Game header -->
    <div class="game-header">
      <h1 class="game-title" data-translate="game_title">Calm Dots</h1>
      <p class="game-subtitle" data-translate="game_subtitle">Connect dots of the same color</p>
    </div>

    <!-- Game board -->
    <div class="game-board">
      <div class="dots-grid" id="dotsGrid"></div>
    </div>

    <!-- Game stats -->
    <div class="game-stats">
      <div class="stat-item">
        <div class="stat-value" id="movesCount">20</div>
        <div class="stat-label" data-translate="moves">MOVES</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="scoreCount">0</div>
        <div class="stat-label" data-translate="score">SCORE</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="lastResult">-</div>
        <div class="stat-label" data-translate="last_result">BEST</div>
      </div>
    </div>

    <!-- Game Over Modal -->
    <div class="game-over-modal" id="gameOverModal">
      <div class="game-over-content">
        <div class="game-over-title" data-translate="result_title">Your score</div>
        <div class="game-over-score" id="finalScore">0</div>
        <button class="play-again-button" id="playAgainButton" data-translate="play_again">Play Again</button>
      </div>
    </div>

  </div>

  <!-- Tab bar -->
  <footer class="tab-bar">
    <a href="index.html" class="tab">
      <img src="img/home.svg" alt="Today">
      <div data-translate="tab_today">Today</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="tab_practices">Practices</div>
    </a>
    <a href="journal.html" class="tab active">
      <img src="img/journal-active.svg" alt="Journal">
      <div data-translate="tab_journal">Calendar</div>
    </a>
  </footer>

  <script>
    // Translations
    const translations = {
      en: {
        page_title: "Calm Dots",
        game_title: "Calm Dots",
        game_subtitle: "Connect dots of the same color",
        moves: "MOVES",
        score: "SCORE",
        last_result: "BEST",
        result_title: "Your score",
        play_again: "Play Again",
        tab_today: "Today",
        tab_practices: "Practices",
        tab_journal: "Calendar"
      },
      ru: {
        page_title: "–°–ø–æ–∫–æ–π–Ω—ã–µ –¢–æ—á–∫–∏",
        game_title: "–°–ø–æ–∫–æ–π–Ω—ã–µ –¢–æ—á–∫–∏", 
        game_subtitle: "–°–æ–µ–¥–∏–Ω—è–π—Ç–µ —Ç–æ—á–∫–∏ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞",
        moves: "–•–û–î–´",
        score: "–°–ß–Å–¢",
        last_result: "–õ–£–ß–®–ò–ô",
        result_title: "–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        play_again: "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
        tab_today: "–°–µ–≥–æ–¥–Ω—è",
        tab_practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏",
        tab_journal: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å"
      }
    };

    // Translator class
    class Translator {
      constructor() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞ JOURNAL.HTML...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        
        const urlLang = this.getLanguageFromURL();
        const storedLang = this.localStorageAvailable ? this.getLanguageFromStorage() : null;
        const telegramLang = this.getTelegramLanguage();
        
        if (urlLang) {
          this.currentLang = urlLang;
          console.log(`üîó –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫ –∏–∑ URL: ${urlLang}`);
        } else if (storedLang) {
          this.currentLang = storedLang;
          console.log(`üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${storedLang}`);
        } else if (telegramLang) {
          this.currentLang = telegramLang;
          console.log(`üì± –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫ –∏–∑ Telegram: ${telegramLang}`);
        } else {
          this.currentLang = 'en';
          console.log(`üåê –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: en`);
        }
        
        console.log(`‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —è–∑—ã–∫ JOURNAL: ${this.currentLang}`);
        this.init();
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          console.log(`‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const langFromUrl = urlParams.get('lang');
        console.log(`üîó –Ø–∑—ã–∫ –∏–∑ URL: ${langFromUrl}`);
        return langFromUrl;
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        
        try {
          const langFromStorage = localStorage.getItem('potok_language');
          console.log(`üíæ –Ø–∑—ã–∫ –∏–∑ localStorage: ${langFromStorage}`);
          return langFromStorage;
        } catch (error) {
          console.log(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage: ${error.message}`);
          return null;
        }
      }

      getTelegramLanguage() {
        try {
          if (window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code) {
            const telegramLang = window.Telegram.WebApp.initDataUnsafe.user.language_code;
            console.log('üì± –Ø–∑—ã–∫ –∏–∑ Telegram:', telegramLang);
            
            if (telegramLang === 'ru' || telegramLang.startsWith('ru')) {
              return 'ru';
            }
            return 'en';
          }
          
          console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∞ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
          return null;
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ Telegram:', error);
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
        document.title = this.translate('page_title');
        
        console.log(`‚úÖ –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ JOURNAL.HTML –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —è–∑—ã–∫–æ–º: ${this.currentLang}`);
      }

      setupLanguageButtons() {
        const enBtn = document.getElementById('enBtn');
        const ruBtn = document.getElementById('ruBtn');
        
        if (enBtn) {
          enBtn.addEventListener('click', () => {
            console.log('üîò –ö–ª–∏–∫ –ø–æ EN –≤ JOURNAL.HTML');
            this.setLanguage('en');
          });
        }
        
        if (ruBtn) {
          ruBtn.addEventListener('click', () => {
            console.log('üîò –ö–ª–∏–∫ –ø–æ RU –≤ JOURNAL.HTML');
            this.setLanguage('ru');
          });
        }
      }

      setLanguage(lang) {
        console.log(`üîÑ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –í–†–£–ß–ù–£–Æ —Å–º–µ–Ω–∏–ª —è–∑—ã–∫ –Ω–∞: ${lang} –≤ JOURNAL.HTML`);
        
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
            console.log(`‚úÖ –Ø–∑—ã–∫ ${lang} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage (–≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)`);
          } catch (error) {
            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage: ${error.message}`);
          }
        } else {
          console.log(`‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ URL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é`);
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
          console.log(`‚úÖ URL –æ–±–Ω–æ–≤–ª–µ–Ω: ${newUrl}`);
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL: ${error.message}`);
        }
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        
        document.documentElement.lang = lang;
        document.title = this.translate('page_title');
        
        console.log(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${lang} –≤ JOURNAL.HTML (–≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω)`);
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        let updateCount = 0;
        
        links.forEach(link => {
          let href = link.getAttribute('href');
          
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          
          if (href.includes('#')) {
            const parts = href.split('#');
            href = parts[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
          updateCount++;
        });
        
        console.log(`üîó –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updateCount} —Å—Å—ã–ª–æ–∫ —Å lang=${this.currentLang} –≤ JOURNAL.HTML`);
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          
          if (element.tagName === 'TITLE') {
            element.textContent = translation;
          } else {
            element.textContent = translation;
          }
        });
        
        console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${document.querySelectorAll('[data-translate]').length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞`);
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
            btn.style.background = 'linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%)';
          } else {
            btn.style.background = '';
          }
        });
      }
    }

    // CloudSync –∫–ª–∞—Å—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Google Sheets (–ë–ï–ó –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú)
    class CloudSync {
      constructor() {
        this.ANALYTICS_URL = 'https://script.google.com/macros/s/AKfycbx3DAPwAq-4GEcGIXtvcgl2B8BSpnJLw5a4gRQKXbSyEn1x9Ha0SciOd1kA_KGtR-k/exec';
        this.isEnabled = true;
        this.retryCount = 0;
        this.maxRetries = 3;
        this.isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        console.log('‚òÅÔ∏è CloudSync –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      }

      getUserData() {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
          if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            const userData = {
              id: user.id,
              username: user.username || '',
              first_name: user.first_name || '',
              language_code: user.language_code || 'en'
            };
            console.log('üë§ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:', userData);
            return userData;
          }
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Telegram
          if (window.Telegram?.WebApp?.initData) {
            console.log('üì± Telegram WebApp detected, –Ω–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            console.log('üì± InitData:', window.Telegram.WebApp.initData);
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ tgWebAppData –≤ URL (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('tgWebAppData') || window.location.href.includes('telegram')) {
            console.log('üì± –û–±–Ω–∞—Ä—É–∂–µ–Ω Telegram –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ URL');
          }
          
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Telegram:', error);
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–Ω–æ–Ω–∏–º–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ fingerprint –±—Ä–∞—É–∑–µ—Ä–∞
        const anonymousId = this.generateStableAnonymousId();
        const anonymousUser = {
          id: anonymousId,
          username: '',
          first_name: 'Anonymous',
          language_code: navigator.language?.split('-')[0] || 'en'
        };
        console.log('üë§ –°–æ–∑–¥–∞–Ω –∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', anonymousUser);
        return anonymousUser;
      }

      generateStableAnonymousId() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage —Å–Ω–∞—á–∞–ª–∞
        try {
          const savedId = localStorage.getItem('calm_dots_anonymous_id');
          if (savedId) {
            console.log('üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–Ω–æ–Ω–∏–º–Ω—ã–π ID:', savedId);
            return savedId;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ ID');
        }

        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –±—Ä–∞—É–∑–µ—Ä–∞
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset(),
          window.location.hostname
        ].join('|');

        // –ü—Ä–æ—Å—Ç–∞—è —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏—è
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        const anonymousId = 'anon_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36).slice(-4);
        
        // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ID
        try {
          localStorage.setItem('calm_dots_anonymous_id', anonymousId);
          console.log('üíæ –ê–Ω–æ–Ω–∏–º–Ω—ã–π ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', anonymousId);
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π ID');
        }

        return anonymousId;
      }

      // –£–ë–ò–†–ê–ï–ú –í–°–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú - —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
      showSyncIndicator(type, message) {
        // –¢–æ–ª—å–∫–æ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        console.log(`‚òÅÔ∏è CloudSync ${type}: ${message}`);
      }

      hideSyncIndicator() {
        // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      }

      async sendAppVisit() {
        console.log('üè† === –û–¢–ü–†–ê–í–ö–ê –°–û–ë–´–¢–ò–Ø –í–•–û–î–ê –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ===');
        
        if (!this.isEnabled) {
          console.log('‚ùå CloudSync –æ—Ç–∫–ª—é—á–µ–Ω');
          return;
        }

        try {
          const userData = this.getUserData();
          const visitData = {
            type: 'app_visit',
            user: userData,
            platform: this.getPlatform(),
            timestamp: new Date().toISOString(),
            page: 'journal'
          };

          console.log('üè† –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—Ö–æ–¥–µ:', {
            user_id: visitData.user.id,
            platform: visitData.platform,
            page: visitData.page
          });

          await fetch(this.ANALYTICS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(visitData),
            mode: 'no-cors'
          });

          console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
          
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏—è –≤—Ö–æ–¥–∞:', error);
        }
        
        console.log('üè† === –ö–û–ù–ï–¶ –û–¢–ü–†–ê–í–ö–ò –°–û–ë–´–¢–ò–Ø –í–•–û–î–ê ===');
      }

      async saveGameState(gameState) {
        console.log('‚òÅÔ∏è === –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ò–ì–†–´ –í –û–ë–õ–ê–ö–û ===');
        
        if (!this.isEnabled) {
          console.log('‚ùå CloudSync –æ—Ç–∫–ª—é—á–µ–Ω');
          return { success: false };
        }

        try {
          const userData = this.getUserData();
          const saveData = {
            type: 'save_game_state',
            user: userData,
            gameState: gameState,
            platform: this.getPlatform(),
            timestamp: new Date().toISOString()
          };

          console.log('‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã:', {
            user_id: saveData.user.id,
            score: gameState.score,
            moves: gameState.moves,
            best: gameState.bestResult
          });

          await fetch(this.ANALYTICS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(saveData),
            mode: 'no-cors'
          });

          console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
          return { success: true };
          
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', error);
          return { success: false, error: error.message };
        }
        
        console.log('‚òÅÔ∏è === –ö–û–ù–ï–¶ –°–û–•–†–ê–ù–ï–ù–ò–Ø ===');
      }

      async loadGameState() {
        console.log('‚òÅÔ∏è === –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ò–ì–†–´ –ò–ó –û–ë–õ–ê–ö–ê ===');
        
        if (!this.isEnabled) {
          console.log('‚ùå CloudSync –æ—Ç–∫–ª—é—á–µ–Ω');
          return { success: false };
        }

        try {
          const userData = this.getUserData();
          console.log('‚òÅÔ∏è –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData.id);

          // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º GET –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          const url = `${this.ANALYTICS_URL}?action=load_game&user_id=${encodeURIComponent(userData.id)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          console.log('‚òÅÔ∏è –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞:', data);

          if (data.success && data.gameState) {
            console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞');
            return { success: true, gameState: data.gameState };
          } else {
            console.log('üì≠ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ –Ω–µ—Ç');
            return { success: false, message: 'No cloud data found' };
          }
          
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', error);
          return { success: false, error: error.message };
        }
        
        console.log('‚òÅÔ∏è === –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò ===');
      }

      async sendGameResult(gameStats) {
        console.log('üìä === –û–¢–ü–†–ê–í–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ò–ì–†–´ ===');
        
        if (!this.isEnabled) {
          console.log('‚ùå CloudSync –æ—Ç–∫–ª—é—á–µ–Ω');
          return;
        }

        try {
          const userData = this.getUserData();
          const resultData = {
            type: 'game_result',
            user: userData,
            gameStats: gameStats,
            platform: this.getPlatform(),
            timestamp: new Date().toISOString()
          };

          console.log('üìä –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã:', {
            user_id: resultData.user.id,
            score: gameStats.score,
            moves: gameStats.moves,
            best: gameStats.bestResult
          });

          await fetch(this.ANALYTICS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(resultData),
            mode: 'no-cors'
          });

          console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
          
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–≥—Ä—ã:', error);
        }
        
        console.log('üìä === –ö–û–ù–ï–¶ –û–¢–ü–†–ê–í–ö–ò –†–ï–ó–£–õ–¨–¢–ê–¢–ê ===');
      }

      getPlatform() {
        if (window.Telegram?.WebApp) return 'telegram';
        if (navigator.userAgent.includes('Mobile')) return 'mobile_web';
        return 'desktop_web';
      }

      // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      async testCloudSync() {
        console.log('üß™ === –¢–ï–°–¢ –û–ë–õ–ê–ß–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===');
        
        // –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏—è –≤—Ö–æ–¥–∞
        await this.sendAppVisit();
        
        // –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        const testGameState = {
          score: 100,
          moves: 15,
          bestResult: 150,
          grid: ['green', 'blue', 'yellow', 'pink'],
          timestamp: Date.now()
        };
        
        const saveResult = await this.saveGameState(testGameState);
        console.log('üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', saveResult);
        
        // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        setTimeout(async () => {
          const loadResult = await this.loadGameState();
          console.log('üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏:', loadResult);
        }, 2000);
        
        console.log('üß™ === –ö–û–ù–ï–¶ –¢–ï–°–¢–ê ===');
      }
    }

    // Game class —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    class CalmDotsGame {
      constructor() {
        this.gridSize = 7;
        this.colors = ['green', 'yellow', 'blue', 'pink'];
        this.grid = [];
        this.moves = 20;
        this.score = 0;
        this.bestResult = 0;
        this.isSelecting = false;
        this.selectedDots = [];
        this.currentPath = [];
        
        this.STORAGE_KEYS = {
          BEST_RESULT: 'calmDotsBestResult',
          GAME_STATE: 'calmDotsGameState'
        };
        
        this.cloudSync = new CloudSync();
        this.gameStartTime = null;
        
        this.initializeElements();
        this.setupEventListeners();
        this.loadGameState();
      }

      async loadGameState() {
        console.log('üéÆ === –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ò–ì–†–´ ===');
        
        try {
          // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
          const cloudResult = await this.cloudSync.loadGameState();
          
          if (cloudResult.success && cloudResult.gameState) {
            console.log('‚òÅÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏–∑ –æ–±–ª–∞–∫–∞');
            const cloudState = cloudResult.gameState;
            
            this.moves = cloudState.moves || 20;
            this.score = cloudState.score || 0;
            this.bestResult = cloudState.bestResult || 0;
            this.grid = cloudState.grid || [];
            
            console.log('‚òÅÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞:', { 
              moves: this.moves, 
              score: this.score,
              bestResult: this.bestResult
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ –∫—ç—à
            this.saveToLocalStorage();
            
            if (this.grid.length > 0) {
              this.renderGrid();
              this.updateStats();
              return;
            }
          } else {
            console.log('‚òÅÔ∏è –û–±–ª–∞—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage');
          }

          // –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
          const savedBestResult = localStorage.getItem(this.STORAGE_KEYS.BEST_RESULT);
          this.bestResult = savedBestResult ? parseInt(savedBestResult) : 0;
          console.log('üíæ –ó–∞–≥—Ä—É–∂–µ–Ω –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ localStorage:', this.bestResult);

          const savedGameState = localStorage.getItem(this.STORAGE_KEYS.GAME_STATE);
          if (savedGameState) {
            const gameState = JSON.parse(savedGameState);
            this.moves = gameState.moves || 20;
            this.score = gameState.score || 0;
            this.grid = gameState.grid || [];
            console.log('üíæ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏–∑ localStorage:', { moves: this.moves, score: this.score });
            
            if (this.grid.length > 0) {
              this.renderGrid();
              this.updateStats();
              
              // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –æ–±–ª–∞–∫–æ–º
              this.syncToCloud();
              return;
            }
          }
          
          // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
          this.initializeGame();
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', error);
          this.bestResult = 0;
          this.initializeGame();
        }
        
        console.log('üéÆ === –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø ===');
      }

      saveToLocalStorage() {
        try {
          const gameState = {
            moves: this.moves,
            score: this.score,
            bestResult: this.bestResult,
            grid: this.grid,
            timestamp: Date.now()
          };
          localStorage.setItem(this.STORAGE_KEYS.GAME_STATE, JSON.stringify(gameState));
          localStorage.setItem(this.STORAGE_KEYS.BEST_RESULT, this.bestResult.toString());
          console.log('üíæ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
        }
      }

      async syncToCloud() {
        const gameState = {
          moves: this.moves,
          score: this.score,
          bestResult: this.bestResult,
          grid: this.grid,
          timestamp: Date.now()
        };
        
        const result = await this.cloudSync.saveGameState(gameState);
        if (result.success) {
          console.log('‚òÅÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–±–ª–∞–∫–æ–º');
        }
      }

      async saveGameState() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        this.saveToLocalStorage();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –æ–±–ª–∞–∫–æ–º
        await this.syncToCloud();
      }

      initializeElements() {
        this.dotsGrid = document.getElementById('dotsGrid');
        this.movesCount = document.getElementById('movesCount');
        this.scoreCount = document.getElementById('scoreCount');
        this.lastResultElement = document.getElementById('lastResult');
        this.gameOverModal = document.getElementById('gameOverModal');
        this.finalScore = document.getElementById('finalScore');
      }

      setupEventListeners() {
        const playAgainButton = document.getElementById('playAgainButton');
        if (playAgainButton) {
          playAgainButton.addEventListener('click', () => {
            this.startNewGame();
          });
        }

        if (this.dotsGrid) {
          this.dotsGrid.addEventListener('mousedown', (e) => this.startConnection(e));
          this.dotsGrid.addEventListener('mousemove', (e) => this.updateConnection(e));
          this.dotsGrid.addEventListener('mouseup', () => this.endConnection());
          
          this.dotsGrid.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.startConnection(e.touches[0]);
          });
          this.dotsGrid.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.updateConnection(e.touches[0]);
          });
          this.dotsGrid.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.endConnection();
          });
        }
      }

      initializeGame() {
        this.generateGrid();
        this.renderGrid();
        this.updateStats();
        this.saveGameState();
        
        this.gameStartTime = Date.now();
        console.log('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å:', new Date(this.gameStartTime).toLocaleTimeString());
      }

      async showGameOver() {
        if (this.score > this.bestResult) {
          this.bestResult = this.score;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã –≤ –æ–±–ª–∞–∫–æ
        await this.cloudSync.sendGameResult({
          score: this.score,
          moves: this.moves,
          bestResult: this.bestResult,
          duration: this.gameStartTime ? Math.round((Date.now() - this.gameStartTime) / 1000) : 0
        });
        
        if (this.finalScore) {
          this.finalScore.textContent = this.score;
        }
        if (this.gameOverModal) {
          this.gameOverModal.classList.add('show');
        }
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–≥—Ä—É
        this.clearSavedGame();
      }

      clearSavedGame() {
        try {
          localStorage.removeItem(this.STORAGE_KEYS.GAME_STATE);
          console.log('üóëÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞ –æ—á–∏—â–µ–Ω–∞');
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∏–≥—Ä—ã:', error);
        }
      }

      hideGameOver() {
        if (this.gameOverModal) {
          this.gameOverModal.classList.remove('show');
        }
      }

      startNewGame() {
        this.moves = 20;
        this.score = 0;
        this.clearSelection();
        this.hideGameOver();
        
        console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É');
        this.initializeGame();
      }

      generateGrid() {
        this.grid = [];
        for (let i = 0; i < this.gridSize * this.gridSize; i++) {
          const randomColor = this.colors[Math.floor(Math.random() * this.colors.length)];
          this.grid.push(randomColor);
        }
      }

      renderGrid() {
        if (!this.dotsGrid) return;
        
        this.dotsGrid.innerHTML = '';
        
        for (let i = 0; i < this.grid.length; i++) {
          const dot = document.createElement('div');
          dot.className = `dot ${this.grid[i]}`;
          dot.dataset.index = i;
          this.dotsGrid.appendChild(dot);
        }
      }

      getRowCol(index) {
        return {
          row: Math.floor(index / this.gridSize),
          col: index % this.gridSize
        };
      }

      getIndex(row, col) {
        return row * this.gridSize + col;
      }

      areAdjacent(index1, index2) {
        const pos1 = this.getRowCol(index1);
        const pos2 = this.getRowCol(index2);
        
        const rowDiff = Math.abs(pos1.row - pos2.row);
        const colDiff = Math.abs(pos1.col - pos2.col);
        
        return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
      }

      startConnection(event) {
        const dot = event.target.closest('.dot');
        if (!dot) return;

        this.isSelecting = true;
        this.selectedDots = [parseInt(dot.dataset.index)];
        this.currentPath = [parseInt(dot.dataset.index)];
        this.updateSelectedVisuals();
      }

      updateConnection(event) {
        if (!this.isSelecting) return;

        const dot = document.elementFromPoint(event.clientX, event.clientY)?.closest('.dot');
        if (!dot) return;

        const dotIndex = parseInt(dot.dataset.index);
        const lastSelected = this.selectedDots[this.selectedDots.length - 1];
        
        if (this.selectedDots.length > 1 && dotIndex === this.selectedDots[this.selectedDots.length - 2]) {
          this.selectedDots.pop();
          this.currentPath.pop();
          this.updateSelectedVisuals();
          return;
        }

        if (dotIndex !== lastSelected && 
            this.areAdjacent(dotIndex, lastSelected) && 
            this.grid[dotIndex] === this.grid[this.selectedDots[0]] &&
            !this.selectedDots.includes(dotIndex)) {
          
          this.selectedDots.push(dotIndex);
          this.currentPath.push(dotIndex);
          this.updateSelectedVisuals();
        }
      }

      endConnection() {
        if (!this.isSelecting || this.selectedDots.length < 2) {
          this.clearSelection();
          return;
        }

        this.removeDots();
        this.clearSelection();
        
        // –£–º–µ–Ω—å—à–∞–µ–º —Ö–æ–¥—ã, –Ω–æ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å
        this.moves = Math.max(0, this.moves - 1);
        
        this.updateStats();
        this.saveGameState();
        
        setTimeout(() => {
          this.dropDots();
          this.fillGrid();
          this.renderGrid();
          this.saveGameState();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
          if (this.moves <= 0) {
            this.showGameOver();
          }
        }, 300);
      }

      updateSelectedVisuals() {
        document.querySelectorAll('.dot').forEach(dot => {
          dot.classList.remove('selected');
        });

        this.selectedDots.forEach(index => {
          const dot = document.querySelector(`[data-index="${index}"]`);
          if (dot) {
            dot.classList.add('selected');
          }
        });
      }

      clearSelection() {
        this.isSelecting = false;
        this.selectedDots = [];
        this.currentPath = [];
        document.querySelectorAll('.dot.selected').forEach(dot => {
          dot.classList.remove('selected');
        });
      }

      removeDots() {
        const scoreGained = this.selectedDots.length;
        this.score += scoreGained;

        this.selectedDots.forEach(index => {
          const dot = document.querySelector(`[data-index="${index}"]`);
          if (dot) {
            dot.classList.add('removing');
          }
        });

        this.selectedDots.forEach(index => {
          this.grid[index] = null;
        });
      }

      dropDots() {
        for (let col = 0; col < this.gridSize; col++) {
          const column = [];
          
          for (let row = this.gridSize - 1; row >= 0; row--) {
            const index = this.getIndex(row, col);
            if (this.grid[index] !== null) {
              column.push(this.grid[index]);
            }
          }
          
          for (let row = this.gridSize - 1; row >= 0; row--) {
            const index = this.getIndex(row, col);
            if (column.length > 0) {
              this.grid[index] = column.shift();
            } else {
              this.grid[index] = null;
            }
          }
        }
      }

      fillGrid() {
        for (let i = 0; i < this.grid.length; i++) {
          if (this.grid[i] === null) {
            const randomColor = this.colors[Math.floor(Math.random() * this.colors.length)];
            this.grid[i] = randomColor;
          }
        }
      }

      updateStats() {
        if (this.movesCount) this.movesCount.textContent = Math.max(0, this.moves);
        if (this.scoreCount) this.scoreCount.textContent = this.score;
        if (this.lastResultElement) this.lastResultElement.textContent = this.bestResult || '-';
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üì± –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Calm Dots Journal...');
      
      // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Telegram WebApp
      if (window.Telegram?.WebApp) {
        console.log('üì± Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º...');
        try {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          console.log('üì± Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
          console.log('üì± User data:', window.Telegram.WebApp.initDataUnsafe?.user);
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
        }
      }
      
      window.translator = new Translator();
      window.cloudSync = new CloudSync();
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      await window.cloudSync.sendAppVisit();
      
      window.game = new CalmDotsGame();

      console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Calm Dots Journal –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    window.testCloudSync = async function() {
      console.log('üß™ === –¢–ï–°–¢ –û–ë–õ–ê–ß–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===');
      
      if (!window.cloudSync) {
        console.log('‚ùå CloudSync –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      await window.cloudSync.testCloudSync();
      
      console.log('üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:');
      console.log('1. Google Sheets - –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏');
      console.log('2. Google Apps Script - View ‚Üí Executions');
      console.log('3. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ - –ª–æ–≥–∏');
    };

    window.forceCloudLoad = async function() {
      console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞...');
      
      if (window.game?.cloudSync) {
        const result = await window.game.cloudSync.loadGameState();
        console.log('üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏:', result);
      } else {
        console.log('‚ùå –ò–≥—Ä–∞ –∏–ª–∏ CloudSync –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Telegram –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    window.diagnoseTelegram = function() {
      console.log('üîç === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM WEBAPP ===');
      
      console.log('üåê URL:', window.location.href);
      console.log('üåê User Agent:', navigator.userAgent);
      
      if (window.Telegram) {
        console.log('‚úÖ –û–±—ä–µ–∫—Ç Telegram –Ω–∞–π–¥–µ–Ω');
        console.log('üì± Telegram object:', window.Telegram);
        
        if (window.Telegram.WebApp) {
          console.log('‚úÖ Telegram.WebApp –Ω–∞–π–¥–µ–Ω');
          console.log('üì± WebApp object:', window.Telegram.WebApp);
          console.log('üì± Platform:', window.Telegram.WebApp.platform);
          console.log('üì± Version:', window.Telegram.WebApp.version);
          console.log('üì± InitData:', window.Telegram.WebApp.initData);
          console.log('üì± InitDataUnsafe:', window.Telegram.WebApp.initDataUnsafe);
          
          if (window.Telegram.WebApp.initDataUnsafe) {
            console.log('üì± User data:', window.Telegram.WebApp.initDataUnsafe.user);
            console.log('üì± Chat data:', window.Telegram.WebApp.initDataUnsafe.chat);
            console.log('üì± Start param:', window.Telegram.WebApp.initDataUnsafe.start_param);
          } else {
            console.log('‚ùå InitDataUnsafe –ø—É—Å—Ç–æ–π - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
          }
        } else {
          console.log('‚ùå Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
      } else {
        console.log('‚ùå –û–±—ä–µ–∫—Ç Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≤ Telegram');
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (window.cloudSync) {
        const userData = window.cloudSync.getUserData();
        console.log('üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', userData);
      }
      
      console.log('üîç === –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');
    };

    window.forceCloudSave = async function() {
      console.log('üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ...');
      
      if (window.game) {
        await window.game.syncToCloud();
        console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
      } else {
        console.log('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      }
    };

    window.checkGameState = function() {
      if (window.game) {
        console.log('üéÆ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã:');
        console.log('–û—á–∫–∏:', window.game.score);
        console.log('–•–æ–¥—ã:', window.game.moves);
        console.log('–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', window.game.bestResult);
        console.log('–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã:', window.game.gameStartTime);
      } else {
        console.log('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      }
    };

    window.clearAllData = function() {
      console.log('üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...');
      
      try {
        localStorage.clear();
        console.log('‚úÖ LocalStorage –æ—á–∏—â–µ–Ω');
        
        if (window.game) {
          window.game.startNewGame();
          console.log('‚úÖ –ò–≥—Ä–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞');
        }
      } catch (error) {
        console.log('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
      }
    };

    console.log('üß™ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:');
    console.log('- testCloudSync() - –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    console.log('- forceCloudLoad() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞');
    console.log('- forceCloudSave() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ');
    console.log('- checkGameState() - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã');
    console.log('- clearAllData() - –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫');
    console.log('- diagnoseTelegram() - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram WebApp');
    console.log('');
    console.log('üí° –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Telegram –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: diagnoseTelegram()');
  </script>
</body>
</html>