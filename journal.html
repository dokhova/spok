<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title data-translate="page_title">Potok ‚Äî Profile</title>
  
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK —á–µ—Ä–µ–∑ CDN (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
  <script>
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º URL –¥–ª—è Google Sheets API (–Ω–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
    const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwm7GCmnIEgB-9KhcDZ4IYzxwhi36Kt16tnRrtBXJZBW6UrttjMQjRydqKR3uVjM2rf/exec';

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4834XVE45Z', {
      enhanced_measurement: true
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ—Ñ–∏–ª—è
    function trackNotificationToggle(type, enabled) {
      console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', type, enabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ');
      gtag('event', 'notification_toggle', {
        event_category: 'profile',
        event_label: type,
        value: enabled ? 1 : 0
      });
    }

    function trackSupportClick() {
      console.log('–ö–ª–∏–∫ –ø–æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ');
      gtag('event', 'support_click', {
        event_category: 'profile',
        event_label: 'telegram_support',
        value: 1
      });
    }

    function trackInstallPrompt() {
      console.log('–ö–ª–∏–∫ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ PWA');
      gtag('event', 'pwa_install_prompt', {
        event_category: 'profile',
        event_label: 'add_to_homescreen',
        value: 1
      });
    }

    function trackNavigation(navItem) {
      console.log('–ö–ª–∏–∫ –ø–æ —Ç–∞–±—É:', navItem);
      gtag('event', 'navigation', {
        event_category: 'tab_bar',
        event_label: navItem,
        value: 1
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Google Analytics –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ü—Ä–æ—Ñ–∏–ª—å...');
      
      if (typeof gtag !== 'undefined') {
        console.log('‚úÖ Google Analytics —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü—Ä–æ—Ñ–∏–ª–µ!');
        gtag('event', 'profile_page_loaded', {
          event_category: 'page',
          event_label: 'profile'
        });
      } else {
        console.log('‚ùå Google Analytics –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      setTimeout(() => {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(function(tab) {
          tab.addEventListener('click', function() {
            const tabName = tab.querySelector('div')?.textContent || 'Unknown';
            trackNavigation(tabName);
          });
        });
      }, 1000);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      setTimeout(function() {
        gtag('event', 'profile_time_spent', {
          event_category: 'engagement',
          event_label: 'stayed_15_seconds',
          value: 15
        });
      }, 15000);
    });
  </script>

  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
      --card-bg: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.15);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 163.5px);
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 425px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* Header with back button */
    .header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--main);
      padding: 24px 24px 24px 24px;
      box-sizing: border-box;
    }

    .back-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 32px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: none;
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .back-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-arrow {
      width: 16px;
      height: 16px;
      color: var(--white);
    }

    /* Main container */
    .container {
      max-width: 375px;
      margin: 0 auto;
      padding: 105px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      padding-bottom: 72px;
      box-sizing: border-box;
    }

    /* User Profile Section */
    .user-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 48px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-avatar-fallback {
      font-size: 32px;
      font-weight: 600;
      color: white;
    }

    .user-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
      text-align: center;
    }

    /* Navigation Items */
    .nav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      height: 80px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .nav-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-item-content {
      display: flex;
      flex-direction: column;
      gap: 0px;
    }

    .nav-item-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      color: var(--white);
      margin: 0;
    }

    .nav-item-subtitle {
      font-size: 12px;
      color: var(--text-2);
      line-height: 16px;
      margin: 0;
    }

    .nav-arrow {
      width: 12px;
      height: 12px;
      color: var(--text-2);
      transition: transform 0.2s;
    }

    .nav-item:hover .nav-arrow {
      transform: translateX(2px);
    }

    /* PWA Install Button */
    .pwa-install {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
      border: none;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 12px;
      display: none;
    }

    .pwa-install:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
    }

    .pwa-install:active {
      transform: translateY(0);
    }

    .pwa-install.show {
      display: block;
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      padding-bottom: calc(12px + 20px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }

    /* Loading state */
    .loading {
      text-align: center;
      color: var(--text-2);
      font-size: 14px;
      margin: 24px 0;
      display: none;
    }

    /* Modal for notifications */
    .notifications-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .notifications-modal.active {
      display: flex;
    }

    .notifications-content {
      background-color: var(--main);
      border-radius: 16px;
      padding: 24px 20px 20px 20px;
      max-width: 320px;
      width: 85%;
      border: 1px solid var(--border);
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .notifications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .notifications-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 8px;
      margin: -8px -8px -8px 8px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 18px;
      line-height: 1;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }

    .notification-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-label {
      font-size: 14px;
      color: var(--white);
      font-weight: 500;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .toggle-switch.active {
      background: var(--green);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--white);
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Bottom spacer */
    .bottom-spacer {
      height: 32px;
    }

    /* Status messages */
    .status-message {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--green);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .status-message.show {
      opacity: 1;
    }

    .status-message.error {
      background: #EA4335;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <!-- Header with back button -->
  <div class="header">
    <button class="back-button" onclick="window.location.href='index.html'">
      <svg class="back-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div></div>
  </div>

  <!-- Status message -->
  <div class="status-message" id="statusMessage"></div>

  <div class="container">
    <!-- User Profile Section -->
    <div class="user-profile">
      <div class="user-avatar" id="userAvatar">
        <div class="user-avatar-fallback" id="userAvatarFallback">U</div>
      </div>
      <h1 class="user-name" id="userName" data-translate="guest_user">Guest User</h1>
    </div>

    <!-- Support Section -->
    <div class="nav-item" onclick="openSupport()">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
        <p class="nav-item-subtitle" data-translate="contact_support">–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <!-- Notifications Section -->
    <div class="nav-item" onclick="openNotificationsModal()">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="notifications">–û–ø–æ–≤–µ—â–µ–Ω–∏—è</h3>
        <p class="nav-item-subtitle" data-translate="notification_settings">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <!-- PWA Install Button -->
    <button class="pwa-install" id="pwaInstall" data-translate="add_to_homescreen">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>

    <!-- Terms of Use Section -->
    <div class="nav-item" onclick="window.location.href='privacy.html'">
      <div class="nav-item-content">
        <h3 class="nav-item-title" data-translate="terms_of_use">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
        <p class="nav-item-subtitle" data-translate="read_terms">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞</p>
      </div>
      <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <div class="bottom-spacer"></div>
  </div>

  <!-- Notifications Modal -->
  <div class="notifications-modal" id="notificationsModal">
    <div class="notifications-content">
      <div class="notifications-header">
        <h3 class="notifications-title" data-translate="notifications">–û–ø–æ–≤–µ—â–µ–Ω–∏—è</h3>
        <button class="close-button" id="closeNotifications">‚úï</button>
      </div>
      
      <div class="notification-item">
        <div class="notification-label" data-translate="emotion_calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —ç–º–æ—Ü–∏–π</div>
        <div class="toggle-switch" id="emotionToggle"></div>
      </div>
    </div>
  </div>

  <!-- Tab bar -->
  <footer class="tab-bar">
    <a href="index.html" class="tab">
      <img src="img/home.svg" alt="Today">
      <div data-translate="tab_today">Today</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="tab_practices">Practices</div>
    </a>
    <a href="journal.html" class="tab active">
      <img src="img/journal-active.svg" alt="Profile">
      <div data-translate="tab_profile">Profile</div>
    </a>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtmTRKNwiOUoqqzzgsWGwNhoRK4a38hls",
      authDomain: "spokspace-calendar.firebaseapp.com",
      projectId: "spokspace-calendar",
      storageBucket: "spokspace-calendar.firebasestorage.app",
      messagingSenderId: "285027675276",
      appId: "1:285027675276:web:9bf7ff69a74b9eecca5fa9",
      measurementId: "G-QS4304BN1X"
    };

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: GoogleSheetsService —Å —Ä–µ—à–µ–Ω–∏–µ–º CORS –ø—Ä–æ–±–ª–µ–º
    class GoogleSheetsService {
      constructor() {
        this.isOnline = navigator.onLine;
        this.userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        this.retryCount = 3;
        this.retryDelay = 1000;
        console.log('üåç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ:', this.userTimezone);
        
        // Monitor online status
        window.addEventListener('online', () => {
          this.isOnline = true;
          console.log('üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        });
        
        window.addEventListener('offline', () => {
          this.isOnline = false;
          console.log('üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
        });
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º GET –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ POST –¥–ª—è CORS
      async makeRequest(action, params = {}) {
        console.log('üì§ –ù–∞—á–∏–Ω–∞–µ–º GET –∑–∞–ø—Ä–æ—Å:', action, params);
        
        for (let attempt = 1; attempt <= this.retryCount; attempt++) {
          try {
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/${this.retryCount} –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è: ${action}`);
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º GET URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const url = new URL(GOOGLE_SHEETS_API);
            url.searchParams.append('action', action);
            
            Object.keys(params).forEach(key => {
              if (params[key] !== null && params[key] !== undefined) {
                url.searchParams.append(key, params[key].toString());
              }
            });

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å –∫:', url.toString());
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º GET –≤–º–µ—Å—Ç–æ POST
            const response = await fetch(url.toString(), {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache'
            });

            console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status, response.statusText);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            const responseText = await response.text();
            console.log('üìÑ –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);

            // –ü—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å JSON
            let data;
            try {
              data = JSON.parse(responseText);
            } catch (parseError) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);
              console.log('üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞:', responseText);
              
              // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç SUCCESS
              if (responseText.includes('SUCCESS') || responseText.includes('success')) {
                data = { success: true, message: 'Operation completed successfully' };
              } else {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON');
              }
            }

            console.log('üì• –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:', data);
            return data;
            
          } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ ${attempt}:`, error);
            
            if (attempt === this.retryCount) {
              throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ ${this.retryCount} –ø–æ–ø—ã—Ç–æ–∫: ${error.message}`);
            }
            
            console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ${this.retryDelay}–º—Å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...`);
            await new Promise(resolve => setTimeout(resolve, this.retryDelay));
            this.retryDelay *= 2;
          }
        }
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      async saveNotificationSettings(userId, notificationEnabled, chatId = null) {
        console.log('üîî –û–¢–õ–ê–î–ö–ê: –ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
        console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', {
          userId: userId,
          notificationEnabled: notificationEnabled,
          chatId: chatId,
          timezone: this.userTimezone
        });

        const params = {
          user_id: userId,
          notification_enabled: notificationEnabled.toString(), // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
          timezone: this.userTimezone
        };

        if (chatId) {
          params.chat_id = chatId.toString(); // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
        }

        try {
          console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å –∫ Google Sheets...');
          console.log('üîó URL:', GOOGLE_SHEETS_API);
          console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:', params);

          const response = await this.makeRequest('save-notification-settings', params);
          
          console.log('üì• –û—Ç–≤–µ—Ç –æ—Ç Google Sheets:', response);
          
          if (response && (response.success || response.success === undefined)) {
            console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
            return response;
          } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', response);
            throw new Error(response?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
          }
          
        } catch (error) {
          console.error('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          throw error;
        }
      }

      async loadNotificationSettings(userId) {
        console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è:', userId);
        
        try {
          const response = await this.makeRequest('get-notification-settings', { user_id: userId });
          console.log('üìã –û—Ç–≤–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', response);
          return response;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          throw error;
        }
      }

      async registerChatId(userId, chatId) {
        console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è chat_id:', userId, '->', chatId);
        
        try {
          const response = await this.makeRequest('register-chat-id', { 
            user_id: userId, 
            chat_id: chatId.toString(),
            timezone: this.userTimezone
          });
          console.log('üìã –û—Ç–≤–µ—Ç –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ chat_id:', response);
          return response;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ chat_id:', error);
          throw error;
        }
      }
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: ProfileService —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π GoogleSheetsService
    class ProfileService {
      constructor() {
        this.app = null;
        this.db = null;
        this.auth = null;
        this.isOnline = false;
        this.userId = null;
        this.isInitialized = false;
        this.isFirebaseReady = false;
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º GoogleSheetsService
        this.sheetsService = new GoogleSheetsService();
        
        // User data
        this.userInfo = {
          userType: 'guest',
          telegramId: null,
          telegramData: null,
          verified: false,
          userName: '',
          avatarUrl: null
        };
        
        // Notification settings
        this.notificationSettings = {
          emotions: false    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ
        };
        
        // Storage keys
        this.STORAGE_KEYS = {
          USER_ID: 'potok_stable_user_id',
          USER_INFO: 'potok_user_info',
          NOTIFICATIONS: 'potok_notification_settings'
        };
        
        this.initializeUserData();
        this.loadNotificationSettings();
        this.isInitialized = true;
        
        this.initFirebaseInBackground();
        this.loadNotificationSettingsFromServer();
      }

      initializeUserData() {
        console.log('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        const telegramData = this.getTelegramUserData();
        
        if (telegramData) {
          this.userInfo.userType = 'telegram';
          this.userInfo.telegramId = telegramData.id;
          this.userInfo.telegramData = telegramData;
          this.userInfo.verified = true;
          this.userInfo.userName = `${telegramData.first_name || ''} ${telegramData.last_name || ''}`.trim();
          this.userInfo.avatarUrl = telegramData.photo_url;
          this.userId = `tg_${telegramData.id}`;
          
          console.log('üéØ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', this.userInfo.userName, 'ID:', this.userId);
          this.saveUserInfoToLocalStorage();
        } else {
          console.log('üë§ –ì–æ—Å—Ç–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
          this.loadUserInfoFromLocalStorage();
          
          if (!this.userId) {
            this.userId = this.generateGuestUserId();
          }
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:', {
          userId: this.userId,
          userType: this.userInfo.userType,
          verified: this.userInfo.verified
        });
      }

      getTelegramUserData() {
        try {
          if (typeof window.Telegram !== 'undefined' && 
              window.Telegram.WebApp?.initDataUnsafe?.user?.id) {
            
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            console.log('üì± –î–∞–Ω–Ω—ã–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user);
            
            return {
              id: user.id,
              first_name: user.first_name,
              last_name: user.last_name,
              username: user.username,
              language_code: user.language_code,
              photo_url: user.photo_url,
              is_premium: user.is_premium || false
            };
          }
          
          console.log('‚ö†Ô∏è Telegram WebApp –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
          return null;
        } catch (error) {
          console.log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Telegram –¥–∞–Ω–Ω—ã—Ö:', error);
          return null;
        }
      }

      generateGuestUserId() {
        try {
          const savedId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          if (savedId && !savedId.startsWith('tg_')) {
            console.log('üíæ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–æ—Å—Ç–µ–≤–æ–π ID:', savedId);
            return savedId;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', error);
        }

        const newId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        try {
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, newId);
          console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –≥–æ—Å—Ç–µ–≤–æ–π ID:', newId);
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –≤ localStorage');
        }
        
        return newId;
      }

      saveUserInfoToLocalStorage() {
        try {
          const userInfoToSave = {
            ...this.userInfo,
            lastSeen: new Date().toISOString()
          };
          
          localStorage.setItem(this.STORAGE_KEYS.USER_INFO, JSON.stringify(userInfoToSave));
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, this.userId);
          
          console.log('üíæ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
        }
      }

      loadUserInfoFromLocalStorage() {
        try {
          const savedUserInfo = localStorage.getItem(this.STORAGE_KEYS.USER_INFO);
          const savedUserId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          
          if (savedUserInfo) {
            const parsedInfo = JSON.parse(savedUserInfo);
            this.userInfo = { ...this.userInfo, ...parsedInfo };
            console.log('üíæ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ localStorage');
          }
          
          if (savedUserId) {
            this.userId = savedUserId;
            console.log('üíæ User ID –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage:', this.userId);
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
        }
      }

      loadNotificationSettings() {
        try {
          const savedSettings = localStorage.getItem(this.STORAGE_KEYS.NOTIFICATIONS);
          if (savedSettings) {
            this.notificationSettings = { ...this.notificationSettings, ...JSON.parse(savedSettings) };
            console.log('üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.notificationSettings);
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
        }
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞
      async loadNotificationSettingsFromServer() {
        if (!this.userId || !this.sheetsService) return;

        try {
          console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
          const response = await this.sheetsService.loadNotificationSettings(this.userId);
          
          if (response && response.notification_enabled !== undefined) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ boolean
            const isEnabled = response.notification_enabled === 'true' || response.notification_enabled === true;
            this.notificationSettings.emotions = isEnabled;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            this.saveNotificationSettings();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            this.updateNotificationToggles();
            
            console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:', this.notificationSettings);
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
        }
      }

      saveNotificationSettings() {
        try {
          localStorage.setItem(this.STORAGE_KEYS.NOTIFICATIONS, JSON.stringify(this.notificationSettings));
          console.log('üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', this.notificationSettings);
          
          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å Firebase
          if (this.isFirebaseReady && this.db) {
            this.syncNotificationSettingsToFirebase();
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
        }
      }

      async initFirebaseInBackground() {
        try {
          console.log('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –≤ —Ñ–æ–Ω–µ...');
          
          this.app = firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          
          await this.signInAnonymously();
          this.isOnline = true;
          this.isFirebaseReady = true;
          
          console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
          
          await this.verifyUserInFirebase();
          await this.syncNotificationSettingsFromFirebase();
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
          this.isOnline = false;
          this.isFirebaseReady = false;
        }
      }

      async signInAnonymously() {
        try {
          const userCredential = await this.auth.signInAnonymously();
          console.log('üë§ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', userCredential.user.uid);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
        }
      }

      async verifyUserInFirebase() {
        if (!this.isFirebaseReady || !this.isOnline || !this.db) {
          console.log('üö´ Firebase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
          return;
        }

        try {
          console.log('üîê –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase...');
          
          const userDocRef = this.db.collection('users').doc(this.userId);
          const userDoc = await userDocRef.get();
          
          const currentTime = new Date();
          const userData = {
            userId: this.userId,
            userType: this.userInfo.userType,
            verified: this.userInfo.verified,
            lastSeen: currentTime,
            updatedAt: currentTime
          };

          if (this.userInfo.userType === 'telegram' && this.userInfo.telegramData) {
            userData.telegramId = this.userInfo.telegramId;
            userData.telegramData = {
              first_name: this.userInfo.telegramData.first_name,
              last_name: this.userInfo.telegramData.last_name,
              username: this.userInfo.telegramData.username,
              language_code: this.userInfo.telegramData.language_code
            };
            userData.userName = this.userInfo.userName;
            userData.avatarUrl = this.userInfo.avatarUrl;
          }

          if (userDoc.exists) {
            await userDocRef.update(userData);
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ Firebase');
          } else {
            userData.createdAt = currentTime;
            await userDocRef.set(userData);
            console.log('‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ Firebase');
          }
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase:', error);
        }
      }

      async syncNotificationSettingsToFirebase() {
        if (!this.isFirebaseReady || !this.db) return;

        try {
          const settingsDocRef = this.db.collection('notification_settings').doc(this.userId);
          await settingsDocRef.set({
            ...this.notificationSettings,
            userId: this.userId,
            updatedAt: new Date()
          });
          console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å Firebase');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å Firebase:', error);
        }
      }

      async syncNotificationSettingsFromFirebase() {
        if (!this.isFirebaseReady || !this.db) return;

        try {
          const settingsDocRef = this.db.collection('notification_settings').doc(this.userId);
          const doc = await settingsDocRef.get();
          
          if (doc.exists) {
            const firebaseSettings = doc.data();
            this.notificationSettings = {
              emotions: firebaseSettings.emotions !== undefined ? firebaseSettings.emotions : false
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem(this.STORAGE_KEYS.NOTIFICATIONS, JSON.stringify(this.notificationSettings));
            console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase:', this.notificationSettings);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            this.updateNotificationToggles();
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ Firebase:', error);
        }
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      async toggleNotification(type) {
        console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', type);
        
        const oldValue = this.notificationSettings[type];
        const newValue = !oldValue;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        this.notificationSettings[type] = newValue;
        this.saveNotificationSettings();
        
        // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º UI
        this.updateNotificationToggles();
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
        trackNotificationToggle(type, newValue);
        
        console.log(`üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ${type} ${newValue ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        try {
          const chatId = this.userInfo.telegramData?.id || null;
          await this.sheetsService.saveNotificationSettings(this.userId, newValue, chatId);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          this.showStatusMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
          
          // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          this.notificationSettings[type] = oldValue;
          this.saveNotificationSettings();
          this.updateNotificationToggles();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          this.showStatusMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
      }

      updateNotificationToggles() {
        const emotionToggle = document.getElementById('emotionToggle');

        if (emotionToggle) {
          emotionToggle.classList.toggle('active', this.notificationSettings.emotions);
        }
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      showStatusMessage(message, type = 'success') {
        const statusElement = document.getElementById('statusMessage');
        if (!statusElement) return;

        statusElement.textContent = message;
        statusElement.className = `status-message ${type} show`;

        setTimeout(() => {
          statusElement.classList.remove('show');
        }, 3000);
      }
    }

    // PWA Installation
    class PWAInstaller {
      constructor() {
        this.deferredPrompt = null;
        this.setupInstallPrompt();
      }

      setupInstallPrompt() {
        window.addEventListener('beforeinstallprompt', (e) => {
          console.log('üéØ PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞');
          e.preventDefault();
          this.deferredPrompt = e;
          this.showInstallButton();
        });

        window.addEventListener('appinstalled', () => {
          console.log('‚úÖ PWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          this.hideInstallButton();
        });
      }

      showInstallButton() {
        const installButton = document.getElementById('pwaInstall');
        if (installButton) {
          installButton.classList.add('show');
        }
      }

      hideInstallButton() {
        const installButton = document.getElementById('pwaInstall');
        if (installButton) {
          installButton.classList.remove('show');
        }
      }

      async install() {
        if (!this.deferredPrompt) {
          console.log('‚ö†Ô∏è PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
          return;
        }

        this.deferredPrompt.prompt();
        const { outcome } = await this.deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
        } else {
          console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
        }
        
        this.deferredPrompt = null;
        this.hideInstallButton();
      }
    }

    // Translations
    const translations = {
      en: {
        page_title: "Potok ‚Äî Profile",
        guest_user: "Guest User",
        support: "Support",
        contact_support: "Contact support",
        notifications: "Notifications",
        notification_settings: "Configure reminders",
        terms_of_use: "Terms of Use",
        read_terms: "Read the rules",
        add_to_homescreen: "Add to Home Screen",
        emotion_calendar: "Emotion Calendar",
        tab_today: "Today",
        tab_practices: "Practices", 
        tab_profile: "Profile"
      },
      ru: {
        page_title: "Potok ‚Äî –ü—Ä–æ—Ñ–∏–ª—å",
        guest_user: "–ì–æ—Å—Ç–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        support: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        contact_support: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
        notifications: "–û–ø–æ–≤–µ—â–µ–Ω–∏—è",
        notification_settings: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
        terms_of_use: "–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
        read_terms: "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞",
        add_to_homescreen: "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω",
        emotion_calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —ç–º–æ—Ü–∏–π",
        tab_today: "–°–µ–≥–æ–¥–Ω—è",
        tab_practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏",
        tab_profile: "–ü—Ä–æ—Ñ–∏–ª—å"
      }
    };

    // Translator class
    class Translator {
      constructor() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞ PROFILE.HTML...');
        
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        this.currentLang = this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'en';
        
        console.log(`üåê –í—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: ${this.currentLang}`);
        this.init();
      }

      checkLocalStorageAvailability() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const langFromUrl = urlParams.get('lang');
        console.log(`üîó –Ø–∑—ã–∫ –∏–∑ URL: ${langFromUrl}`);
        return langFromUrl;
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        
        try {
          const langFromStorage = localStorage.getItem('potok_language');
          console.log(`üíæ –Ø–∑—ã–∫ –∏–∑ localStorage: ${langFromStorage}`);
          return langFromStorage;
        } catch (error) {
          console.log(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage: ${error.message}`);
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
        
        console.log(`‚úÖ –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ PROFILE.HTML –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —è–∑—ã–∫–æ–º: ${this.currentLang}`);
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ EN –≤ PROFILE.HTML');
          this.setLanguage('en');
        });
        
        document.getElementById('ruBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ RU –≤ PROFILE.HTML');
          this.setLanguage('ru');
        });
      }

      setLanguage(lang) {
        console.log(`üîÑ –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ –Ω–∞: ${lang} –≤ PROFILE.HTML`);
        
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
            console.log(`‚úÖ –Ø–∑—ã–∫ ${lang} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage`);
          } catch (error) {
            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage: ${error.message}`);
          }
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
          console.log(`‚úÖ URL –æ–±–Ω–æ–≤–ª–µ–Ω: ${newUrl}`);
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL: ${error.message}`);
        }
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        
        document.documentElement.lang = lang;
        
        console.log(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${lang} –≤ PROFILE.HTML`);
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        let updateCount = 0;
        
        links.forEach(link => {
          let href = link.getAttribute('href');
          
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          
          if (href.includes('#')) {
            const parts = href.split('#');
            href = parts[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
          updateCount++;
        });
        
        console.log(`üîó –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updateCount} —Å—Å—ã–ª–æ–∫ —Å lang=${this.currentLang}`);
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          
          if (element.tagName === 'TITLE') {
            element.textContent = translation;
          } else {
            element.textContent = translation;
          }
        });
        
        console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${document.querySelectorAll('[data-translate]').length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞`);
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
            btn.style.background = 'linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%)';
          } else {
            btn.style.background = '';
          }
        });
      }
    }

    // Global functions
    function openSupport() {
      trackSupportClick();
      window.open('https://t.me/spoksupport_bot', '_blank');
    }

    function openNotificationsModal() {
      document.getElementById('notificationsModal').classList.add('active');
    }

    function closeNotificationsModal() {
      document.getElementById('notificationsModal').classList.remove('active');
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üì± DOM –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è Profile.html');
      
      // Initialize Telegram WebApp if available
      if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
        console.log('üì± Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      // Initialize translator
      window.translator = new Translator();
      
      // Initialize profile service
      window.profileService = new ProfileService();
      
      // Initialize PWA installer
      window.pwaInstaller = new PWAInstaller();
      
      // Update user UI
      updateUserUI();
      
      // Setup event listeners
      setupEventListeners();
      
      console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    });

    function updateUserUI() {
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      const userAvatarFallback = document.getElementById('userAvatarFallback');
      
      if (window.profileService.userInfo.userType === 'telegram') {
        // Telegram user
        const userName = window.profileService.userInfo.userName || 'Telegram User';
        userNameElement.textContent = userName;
        
        if (window.profileService.userInfo.avatarUrl) {
          const img = document.createElement('img');
          img.src = window.profileService.userInfo.avatarUrl;
          img.alt = userName;
          img.onerror = () => {
            // Fallback if image fails to load
            userAvatarFallback.textContent = userName.charAt(0).toUpperCase();
          };
          userAvatarElement.appendChild(img);
          userAvatarFallback.style.display = 'none';
        } else {
          userAvatarFallback.textContent = userName.charAt(0).toUpperCase();
        }
      } else {
        // Guest user
        userNameElement.textContent = window.translator.translate('guest_user');
        userAvatarFallback.textContent = 'G';
      }
    }

    function setupEventListeners() {
      // Notification modal
      document.getElementById('closeNotifications').addEventListener('click', closeNotificationsModal);
      
      document.getElementById('notificationsModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('notificationsModal')) {
          closeNotificationsModal();
        }
      });
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: Notification toggles - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      document.getElementById('emotionToggle').addEventListener('click', async () => {
        await window.profileService.toggleNotification('emotions');
      });
      
      // PWA install
      document.getElementById('pwaInstall').addEventListener('click', () => {
        trackInstallPrompt();
        window.pwaInstaller.install();
      });
      
      // Update notification toggles UI
      window.profileService.updateNotificationToggles();
    }
  </script>
</body>
</html>