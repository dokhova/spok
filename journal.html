<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title data-translate="page_title">Potok ‚Äî Mood Calendar</title>
  
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK —á–µ—Ä–µ–∑ CDN (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4834XVE45Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4834XVE45Z', {
      enhanced_measurement: true
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function trackEmotionSet(emotion, date) {
      console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —ç–º–æ—Ü–∏—è:', emotion, '–Ω–∞ –¥–∞—Ç—É:', date);
      gtag('event', 'emotion_set', {
        event_category: 'calendar',
        event_label: emotion,
        value: 1
      });
    }

    function trackEmotionRemove(emotion, date) {
      console.log('–£–¥–∞–ª–µ–Ω–∞ —ç–º–æ—Ü–∏—è:', emotion, '—Å –¥–∞—Ç—ã:', date);
      gtag('event', 'emotion_remove', {
        event_category: 'calendar',
        event_label: emotion,
        value: 1
      });
    }

    function trackMonthNavigation(direction) {
      console.log('–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º:', direction);
      gtag('event', 'month_navigation', {
        event_category: 'calendar',
        event_label: direction,
        value: 1
      });
    }

    function trackModalOpen(date) {
      console.log('–û—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∞—Ç—ã:', date);
      gtag('event', 'emotion_modal_open', {
        event_category: 'calendar',
        event_label: date,
        value: 1
      });
    }

    function trackNavigation(navItem) {
      console.log('–ö–ª–∏–∫ –ø–æ —Ç–∞–±—É:', navItem);
      gtag('event', 'navigation', {
        event_category: 'tab_bar',
        event_label: navItem,
        value: 1
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Google Analytics –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ö–∞–ª–µ–Ω–¥–∞—Ä—å...');
      
      if (typeof gtag !== 'undefined') {
        console.log('‚úÖ Google Analytics —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ö–∞–ª–µ–Ω–¥–∞—Ä–µ!');
        gtag('event', 'calendar_page_loaded', {
          event_category: 'page',
          event_label: 'calendar'
        });
      } else {
        console.log('‚ùå Google Analytics –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      setTimeout(() => {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(function(tab) {
          tab.addEventListener('click', function() {
            const tabName = tab.querySelector('div')?.textContent || 'Unknown';
            trackNavigation(tabName);
          });
        });
      }, 1000);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      setTimeout(function() {
        gtag('event', 'calendar_time_spent', {
          event_category: 'engagement',
          event_label: 'stayed_15_seconds',
          value: 15
        });
      }, 15000);
    });
  </script>

  <style>
    :root {
      --main: #19191B;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
      
      --emotion-joyful: #34A853;
      --emotion-good: #5CDE6D;
      --emotion-so-so: #FFD527;
      --emotion-anxious: #FF7DB0;
      --emotion-sad: #4285F4;
      --emotion-bad: #E74639;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Language Switcher - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é */
    .language-switcher {
      position: fixed;
      top: 24px;
      right: calc(50vw - 202.5px); /* –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è —à–∏—Ä–∏–Ω—ã 430px: 430/2 - 12.5px = 202.5px */
      z-index: 200;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 450px) {
      .language-switcher {
        right: 24px;
      }
    }

    .lang-btn {
      background: none;
      border: none;
      color: var(--text-2);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: "Inter", sans-serif;
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
      color: white;
    }

    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .lang-btn.active:hover {
      background: linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%);
    }

    /* Header with back button - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —à–∏—Ä–∏–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    .header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 430px; /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--main);
      padding: 24px 12px 24px 12px; /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å—Ç—É–ø—ã */
      box-sizing: border-box;
    }

    .back-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 32px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: none;
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .back-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-arrow {
      width: 16px;
      height: 16px;
      color: var(--white);
    }

    /* Sync indicator - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é */
    .sync-indicator {
      position: fixed;
      top: 80px;
      right: calc(50vw - 202.5px); /* –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è —à–∏—Ä–∏–Ω—ã 430px */
      z-index: 150;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      color: var(--text-2);
      backdrop-filter: blur(10px);
      transition: all 0.3s;
      opacity: 0;
      transform: translateY(-10px);
      display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }

    @media (max-width: 450px) {
      .sync-indicator {
        right: 24px;
      }
    }

    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ debug —Ä–µ–∂–∏–º–µ */
    .debug-mode .sync-indicator {
      display: block;
    }

    .sync-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .sync-indicator.syncing {
      color: var(--emotion-so-so);
    }

    .sync-indicator.synced {
      color: var(--emotion-joyful);
    }

    .sync-indicator.offline {
      color: var(--text-2);
    }

    /* Main container - –µ—â–µ –±–æ–ª—å—à–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
    .container {
      max-width: 430px; /* –ë—ã–ª–æ 400px, —Ç–µ–ø–µ—Ä—å 430px */
      margin: 0 auto;
      padding: 105px 12px 24px 12px; /* –ï—â–µ —É–º–µ–Ω—å—à–∞–µ–º –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã —Å 16px –¥–æ 12px */
      display: flex;
      flex-direction: column;
      padding-bottom: 72px;
      box-sizing: border-box;
    }

    /* Calendar header */
    .calendar-header {
      margin-bottom: 48px;
      text-align: left;
    }

    .calendar-title {
      font-size: 24px;
      line-height: 32px;
      font-weight: 600;
      color: var(--white);
      margin: 0 0 4px 0;
      padding: 0;
    }

    .calendar-subtitle {
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
      color: var(--text-2);
      margin: 0;
      padding: 0;
    }

    /* Calendar grid - –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    .calendar {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px; /* –£–º–µ–Ω—å—à–∞–µ–º —Å 20px –¥–æ 16px */
      margin-bottom: 48px;
    }

    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .nav-button {
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .nav-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-arrow {
      width: 12px;
      height: 12px;
      color: var(--white);
    }

    .current-month {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px; /* –£–º–µ–Ω—å—à–∞–µ–º —Å 6px –¥–æ 4px */
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      padding: 8px 0;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px; /* –£–º–µ–Ω—å—à–∞–µ–º —Å 6px –¥–æ 4px */
    }

    .day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 400;
      color: var(--white);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      padding: 4px;
    }

    .day:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .day.other-month {
      color: var(--text-2);
      opacity: 0.5;
      cursor: default; /* –£–±–∏—Ä–∞–µ–º cursor pointer */
    }

    .day.other-month:hover {
      background-color: transparent; /* –£–±–∏—Ä–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç */
    }

    .day.today {
      border-radius: 8px;
    }

    .day.today.has-emotion {
      border-radius: 8px;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —ç–º–æ—Ü–∏–∏ –≤ –¥–Ω–µ "—Å–µ–≥–æ–¥–Ω—è" –ë–ï–ó —ç–º–æ—Ü–∏–∏ */
    .day.today:not(.has-emotion) .day-emotion {
      animation: emotionPulse 2s ease-in-out infinite;
    }

    /* –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-open .day.today:not(.has-emotion) .day-emotion {
      animation: none;
    }

    @keyframes emotionPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.4);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 0 3px rgba(52, 168, 83, 0.2);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(52, 168, 83, 0);
      }
    }

    .day.future-date {
      opacity: 0.3;
      cursor: not-allowed;
      border-radius: 8px;
    }

    .day.future-date:hover {
      background-color: transparent;
      border-radius: 8px;
    }

    /* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–Ω—è: —ç–º–æ—Ü–∏—è —Å–≤–µ—Ä—Ö—É, –¥–∞—Ç–∞ —Å–Ω–∏–∑—É */
    .day-emotion {
      width: 24px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å 20px –¥–æ 24px */
      height: 24px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å 20px –¥–æ 24px */
      border-radius: 50%;
      margin-bottom: 2px;
      flex-shrink: 0;
      align-self: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —ç–º–æ—Ü–∏—é */
    }

    .day-number {
      font-size: 12px;
      font-weight: 400;
      color: var(--white);
      line-height: 1;
    }

    .day.other-month .day-number {
      color: var(--text-2);
    }

    .day.other-month .day-emotion {
      opacity: 0.5; /* –ó–∞—Ç–µ–º–Ω—è–µ–º —ç–º–æ—Ü–∏—é –¥–ª—è –¥–Ω–µ–π –¥—Ä—É–≥–∏—Ö –º–µ—Å—è—Ü–µ–≤ */
    }

    /* –°–µ—Ä–∞—è —ç–º–æ—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è */
    .day-emotion {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23666666'/%3E%3Cpath d='M 15 25 L 25 25' stroke='%23333333' stroke-width='1.5' stroke-linecap='round'/%3E%3Ccircle cx='15' cy='17' r='1.5' fill='%23333333'/%3E%3Ccircle cx='25' cy='17' r='1.5' fill='%23333333'/%3E%3C/svg%3E");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* –¶–≤–µ—Ç–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ */
    .day.emotion-joyful .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%2334A853'/%3E%3Cpath d='M 12 15 Q 15 18 18 15' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 22 15 Q 25 18 28 15' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 12 25 Q 20 32 28 25' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='30' cy='15' r='1' fill='%23FFD527'/%3E%3C/svg%3E");
    }
    
    .day.emotion-good .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%235CDE6D'/%3E%3Ccircle cx='15' cy='17' r='2' fill='%2319191B'/%3E%3Ccircle cx='25' cy='17' r='2' fill='%2319191B'/%3E%3Cpath d='M 15 25 Q 20 28 25 25' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='10' cy='23' r='3' fill='%23FFB3D1' opacity='0.4'/%3E%3Ccircle cx='30' cy='23' r='3' fill='%23FFB3D1' opacity='0.4'/%3E%3C/svg%3E");
    }
    
    .day.emotion-so-so .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23FFD527'/%3E%3Cpath d='M 13 17 L 17 17' stroke='%2319191B' stroke-width='1.7' stroke-linecap='round'/%3E%3Cpath d='M 23 17 L 27 17' stroke='%2319191B' stroke-width='1.7' stroke-linecap='round'/%3E%3Cpath d='M 15 25 Q 20 23 25 25' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    }
    
    .day.emotion-anxious .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23FF7DB0'/%3E%3Cellipse cx='15' cy='17' rx='1.5' ry='3' fill='%2319191B'/%3E%3Cellipse cx='25' cy='17' rx='1.5' ry='3' fill='%2319191B'/%3E%3Cellipse cx='20' cy='25' rx='4' ry='2' fill='%2319191B'/%3E%3C/svg%3E");
    }
    
    .day.emotion-sad .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%234285F4'/%3E%3Cpath d='M 12 15 Q 15 18 18 15' stroke='%2319191B' stroke-width='1.3' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 22 15 Q 25 18 28 15' stroke='%2319191B' stroke-width='1.3' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 15 28 Q 20 23 25 28' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3Cellipse cx='12' cy='22' rx='1' ry='3' fill='%234285F4'/%3E%3Cellipse cx='28' cy='22' rx='1' ry='3' fill='%234285F4'/%3E%3C/svg%3E");
    }
    
    .day.emotion-bad .day-emotion { 
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23E74639'/%3E%3Cpath d='M 10 13 L 16 16' stroke='%2319191B' stroke-width='1.7' stroke-linecap='round'/%3E%3Cpath d='M 24 16 L 30 13' stroke='%2319191B' stroke-width='1.7' stroke-linecap='round'/%3E%3Ccircle cx='15' cy='18' r='1.5' fill='%2319191B'/%3E%3Ccircle cx='25' cy='18' r='1.5' fill='%2319191B'/%3E%3Cpath d='M 15 28 Q 20 23 25 28' stroke='%2319191B' stroke-width='1.7' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞ –¥–Ω—è—Ö - —Ç–æ–ª—å–∫–æ –¥–ª—è debug —Ä–µ–∂–∏–º–∞ */
    .debug-mode .day.syncing::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background-color: var(--emotion-so-so);
      animation: pulse 1s infinite;
      opacity: 0.7;
    }

    .debug-mode .day.synced::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background-color: var(--emotion-joyful);
      opacity: 0.7;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Emotion picker modal */
    .emotion-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .emotion-modal.active {
      display: flex;
    }

    .emotion-picker {
      background-color: var(--main);
      border-radius: 16px;
      padding: 24px 20px 20px 20px;
      max-width: 280px;
      width: 85%;
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .emotion-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .emotion-picker-date {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .emotion-picker-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
      line-height: 1.2;
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 8px;
      margin: -8px -8px -8px 8px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 18px;
      line-height: 1;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }

    .emotions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 0;
    }

    .emotion-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 16px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      background-color: rgba(255, 255, 255, 0.03);
    }

    .emotion-option:hover {
      background-color: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .emotion-option:active {
      transform: translateY(0);
    }

    /* Emotion faces in modal */
    .emotion-color {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .emotion-option[data-emotion="joyful"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%2334A853'/%3E%3Cpath d='M 12 15 Q 15 18 18 15' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 22 15 Q 25 18 28 15' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 12 25 Q 20 32 28 25' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='30' cy='15' r='1' fill='%23FFD527'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option[data-emotion="good"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%235CDE6D'/%3E%3Ccircle cx='15' cy='17' r='2' fill='%2319191B'/%3E%3Ccircle cx='25' cy='17' r='2' fill='%2319191B'/%3E%3Cpath d='M 15 25 Q 20 28 25 25' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='10' cy='23' r='3' fill='%23FFB3D1' opacity='0.4'/%3E%3Ccircle cx='30' cy='23' r='3' fill='%23FFB3D1' opacity='0.4'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option[data-emotion="so-so"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23FFD527'/%3E%3Cpath d='M 13 17 L 17 17' stroke='%2319191B' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M 23 17 L 27 17' stroke='%2319191B' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M 15 25 Q 20 23 25 25' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option[data-emotion="anxious"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23FF7DB0'/%3E%3Cellipse cx='15' cy='17' rx='1.5' ry='3' fill='%2319191B'/%3E%3Cellipse cx='25' cy='17' rx='1.5' ry='3' fill='%2319191B'/%3E%3Cellipse cx='20' cy='25' rx='4' ry='2' fill='%2319191B'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option[data-emotion="sad"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%234285F4'/%3E%3Cpath d='M 12 15 Q 15 18 18 15' stroke='%2319191B' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 22 15 Q 25 18 28 15' stroke='%2319191B' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 15 28 Q 20 23 25 28' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cellipse cx='12' cy='22' rx='1' ry='3' fill='%234285F4'/%3E%3Cellipse cx='28' cy='22' rx='1' ry='3' fill='%234285F4'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option[data-emotion="bad"] .emotion-color {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23E74639'/%3E%3Cpath d='M 10 13 L 16 16' stroke='%2319191B' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M 24 16 L 30 13' stroke='%2319191B' stroke-width='2' stroke-linecap='round'/%3E%3Ccircle cx='15' cy='18' r='1.5' fill='%2319191B'/%3E%3Ccircle cx='25' cy='18' r='1.5' fill='%2319191B'/%3E%3Cpath d='M 15 28 Q 20 23 25 28' stroke='%2319191B' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-size: cover;
    }

    .emotion-option:hover .emotion-color {
      transform: scale(1.1);
    }

    .emotion-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--white);
      text-align: center;
    }

    /* Tab bar - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px; /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
      
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      padding-bottom: calc(12px + 20px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }

    /* Loading state */
    .loading {
      text-align: center;
      color: var(--text-2);
      font-size: 14px;
      margin: 24px 0;
      display: none;
    }

    /* Debug panel */
    .debug-panel {
      position: fixed;
      bottom: 100px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 11px;
      max-width: 200px;
      display: none;
    }

    .debug-panel.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" id="enBtn">EN</button>
    <button class="lang-btn" id="ruBtn">RU</button>
  </div>

  <!-- Sync Indicator -->
  <div class="sync-indicator" id="syncIndicator">
    <span id="syncText">Syncing...</span>
  </div>

  <!-- Header with back button -->
  <div class="header">
    <button class="back-button" onclick="window.history.back()">
      <svg class="back-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div></div>
  </div>

  <div class="container">
    <!-- Calendar header -->
    <div class="calendar-header">
      <h1 class="calendar-title" id="calendarTitle">Mood Calendar</h1>
      <p class="calendar-subtitle" id="calendarSubtitle">That doesn't ask why</p>
    </div>

    <!-- Calendar -->
    <div class="calendar">
      <div class="calendar-nav">
        <button class="nav-button" id="prevMonth">
          <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="current-month" id="currentMonth"></div>
        <button class="nav-button" id="nextMonth">
          <svg class="nav-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      
      <div class="weekdays">
        <div class="weekday" data-translate="monday">Mon</div>
        <div class="weekday" data-translate="tuesday">Tue</div>
        <div class="weekday" data-translate="wednesday">Wed</div>
        <div class="weekday" data-translate="thursday">Thu</div>
        <div class="weekday" data-translate="friday">Fri</div>
        <div class="weekday" data-translate="saturday">Sat</div>
        <div class="weekday" data-translate="sunday">Sun</div>
      </div>
      
      <div class="days-grid" id="daysGrid"></div>
    </div>

    <div class="loading" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  </div>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div>User ID: <span id="debugUserId">-</span></div>
    <div>Storage: <span id="debugStorage">-</span></div>
    <div>Firebase: <span id="debugFirebase">-</span></div>
    <div>Emotions: <span id="debugEmotions">-</span></div>
    <div>Last Load: <span id="debugLastLoad">-</span></div>
    <div>Timezone: <span id="debugTimezone">-</span></div>
  </div>

  <!-- Emotion picker modal -->
  <div class="emotion-modal" id="emotionModal">
    <div class="emotion-picker">
      <div class="emotion-picker-header">
        <div>
          <div class="emotion-picker-date" id="selectedDateText">–í–¢–û–†–ù–ò–ö, 3 –ò–Æ–ù–Ø 2025 –ì.</div>
          <h3 class="emotion-picker-title" data-translate="how_feeling">–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</h3>
        </div>
        <button class="close-button" id="closeModal">‚úï</button>
      </div>
      
      <div class="emotions-grid">
        <div class="emotion-option" data-emotion="joyful">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_joyful">–†–∞–¥–æ—Å—Ç–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="good">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_good">–•–æ—Ä–æ—à–æ</div>
        </div>
        <div class="emotion-option" data-emotion="so-so">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_so_so">–¢–∞–∫ —Å–µ–±–µ</div>
        </div>
        <div class="emotion-option" data-emotion="anxious">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_anxious">–¢—Ä–µ–≤–æ–∂–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="sad">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_sad">–ì—Ä—É—Å—Ç–Ω–æ</div>
        </div>
        <div class="emotion-option" data-emotion="bad">
          <div class="emotion-color"></div>
          <div class="emotion-name" data-translate="emotion_bad">–ü–ª–æ—Ö–æ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab bar -->
  <footer class="tab-bar">
    <a href="index.html" class="tab">
      <img src="img/home.svg" alt="Today">
      <div data-translate="tab_today">Today</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Practices">
      <div data-translate="tab_practices">Practices</div>
    </a>
    <a href="journal.html" class="tab active">
      <img src="img/journal-active.svg" alt="Journal">
      <div data-translate="tab_journal">Journal</div>
    </a>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtmTRKNwiOUoqqzzgsWGwNhoRK4a38hls",
      authDomain: "spokspace-calendar.firebaseapp.com",
      projectId: "spokspace-calendar",
      storageBucket: "spokspace-calendar.firebasestorage.app",
      messagingSenderId: "285027675276",
      appId: "1:285027675276:web:9bf7ff69a74b9eecca5fa9",
      measurementId: "G-QS4304BN1X"
    };

    // Instant UI class for immediate feedback
    class InstantUI {
      static showSyncIndicator(text, type = 'syncing') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º sync indicator —Ç–æ–ª—å–∫–æ –≤ debug —Ä–µ–∂–∏–º–µ
        if (!this.isDebugMode()) {
          return;
        }
        
        const indicator = document.getElementById('syncIndicator');
        const syncText = document.getElementById('syncText');
        
        if (indicator && syncText) {
          syncText.textContent = text;
          indicator.className = `sync-indicator show ${type}`;
          
          // Auto hide after 3 seconds for success states
          if (type === 'synced') {
            setTimeout(() => {
              indicator.classList.remove('show');
            }, 3000);
          }
        }
      }

      static hideSyncIndicator() {
        // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ debug —Ä–µ–∂–∏–º–µ
        if (!this.isDebugMode()) {
          return;
        }
        
        const indicator = document.getElementById('syncIndicator');
        if (indicator) {
          indicator.classList.remove('show');
        }
      }

      static isDebugMode() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('debug') === '1';
      }

      static updateDebugInfo(userId, emotionCount, lastAction = '') {
        if (document.getElementById('debugUserId')) {
          document.getElementById('debugUserId').textContent = userId || 'not set';
          document.getElementById('debugStorage').textContent = InstantUI.isLocalStorageAvailable() ? 'OK' : 'NO';
          document.getElementById('debugEmotions').textContent = emotionCount;
          document.getElementById('debugLastLoad').textContent = lastAction || new Date().toLocaleTimeString();
          document.getElementById('debugTimezone').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Unknown';
        }
      }

      static isLocalStorageAvailable() {
        try {
          const testKey = 'test_storage_' + Date.now();
          localStorage.setItem(testKey, 'test');
          localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          return false;
        }
      }
    }

    // Timezone-aware date utilities
    class DateUtils {
      static getUserTimezone() {
        try {
          return Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:', error);
          return 'UTC';
        }
      }

      static getCurrentDateInUserTimezone() {
        const timezone = this.getUserTimezone();
        console.log(`üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${timezone}`);
        
        try {
          // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const now = new Date();
          const userDate = new Date(now.toLocaleString("en-US", {timeZone: timezone}));
          console.log(`üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userDate.toDateString()}`);
          return userDate;
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è:', error);
          return new Date();
        }
      }

      static isTodayInUserTimezone(date) {
        const today = this.getCurrentDateInUserTimezone();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
      }

      static formatDateInUserTimezone(date) {
        const timezone = this.getUserTimezone();
        try {
          return date.toLocaleDateString("en-US", {
            timeZone: timezone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', error);
          return date.toLocaleDateString();
        }
      }
    }

    // Firebase service with same functionality
    class FirebaseService {
      constructor() {
        this.app = null;
        this.db = null;
        this.auth = null;
        this.isOnline = false;
        this.userId = null;
        this.retryCount = 0;
        this.maxRetries = 3;
        this.isInitialized = false;
        this.isFirebaseReady = false;
        
        this.STORAGE_KEYS = {
          USER_ID: 'potok_stable_user_id',
          EMOTIONS: 'potok_emotions_data',
          LAST_SYNC: 'potok_last_sync'
        };
        
        this.userId = this.generateStableUserId();
        this.isInitialized = true;
        this.initFirebaseInBackground();
      }

      generateStableUserId() {
        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp?.initDataUnsafe?.user?.id) {
          const telegramId = `tg_${window.Telegram.WebApp.initDataUnsafe.user.id}`;
          console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID:', telegramId);
          return telegramId;
        }

        try {
          const savedId = localStorage.getItem(this.STORAGE_KEYS.USER_ID);
          if (savedId) {
            console.log('üíæ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID:', savedId);
            return savedId;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', error);
        }

        const newId = `stable_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        try {
          localStorage.setItem(this.STORAGE_KEYS.USER_ID, newId);
          console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID:', newId);
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –≤ localStorage');
        }
        
        return newId;
      }

      async initFirebaseInBackground() {
        try {
          console.log('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –≤ —Ñ–æ–Ω–µ...');
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Connecting...', 'syncing');
          }
          
          this.app = firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          
          try {
            await this.db.enablePersistence({ synchronizeTabs: true });
            console.log('üíæ Offline persistence –≤–∫–ª—é—á–µ–Ω');
          } catch (err) {
            if (err.code == 'failed-precondition') {
              console.log('‚ö†Ô∏è Persistence: –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ');
            } else if (err.code == 'unimplemented') {
              console.log('‚ö†Ô∏è Persistence: –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç');
            }
          }
          
          await this.signInAnonymously();
          this.setupConnectionListener();
          
          this.isOnline = true;
          this.isFirebaseReady = true;
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Synced', 'synced');
          }
          InstantUI.updateDebugInfo(this.userId, 0, 'Firebase ready');
          console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ–Ω–µ');
          
          if (window.calendar) {
            await window.calendar.syncWithFirebase();
          }
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
          this.isOnline = false;
          this.isFirebaseReady = false;
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Offline', 'offline');
          }
          InstantUI.updateDebugInfo(this.userId, 0, 'Firebase failed');
        }
      }

      async signInAnonymously() {
        try {
          const userCredential = await this.auth.signInAnonymously();
          console.log('üë§ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', userCredential.user.uid);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
        }
      }

      setupConnectionListener() {
        this.auth.onAuthStateChanged((user) => {
          if (user) {
            console.log('üü¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:', user.uid);
            this.isOnline = true;
            if (InstantUI.isDebugMode() && !document.getElementById('syncIndicator').classList.contains('show')) {
              InstantUI.showSyncIndicator('Online', 'synced');
            }
          } else {
            console.log('üî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            this.isOnline = false;
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Offline', 'offline');
            }
          }
          
          const debugFirebase = document.getElementById('debugFirebase');
          if (debugFirebase) {
            debugFirebase.textContent = this.isOnline ? 'ONLINE' : 'OFFLINE';
          }
        });

        window.addEventListener('online', () => {
          console.log('üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω');
          this.isOnline = true;
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Back online', 'synced');
          }
        });

        window.addEventListener('offline', () => {
          console.log('üìµ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω');
          this.isOnline = false;
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Offline', 'offline');
          }
        });
      }

      loadEmotionsInstantly() {
        console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage...');
        let emotions = {};
        
        try {
          const localData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          if (localData) {
            emotions = JSON.parse(localData);
            const count = Object.keys(emotions).length;
            console.log(`üíæ –≠–º–æ—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage: ${count}`);
            InstantUI.updateDebugInfo(this.userId, count, 'Instant load');
          } else {
            console.log('üíæ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ localStorage');
            InstantUI.updateDebugInfo(this.userId, 0, 'No local data');
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
          InstantUI.updateDebugInfo(this.userId, 0, 'Local error');
        }

        return emotions;
      }

      async syncWithFirebase() {
        if (!this.isFirebaseReady || !this.isOnline || !this.db) {
          console.log('üö´ Firebase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
          return {};
        }

        console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase...');
        if (InstantUI.isDebugMode()) {
          InstantUI.showSyncIndicator('Syncing...', 'syncing');
        }
        
        try {
          const snapshot = await this.db.collection('emotions')
            .where('userId', '==', this.userId)
            .get();
          
          let firebaseEmotions = {};
          
          if (!snapshot.empty) {
            snapshot.forEach(doc => {
              const data = doc.data();
              firebaseEmotions[data.date] = data.emotion;
            });
            
            console.log('üî• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', snapshot.size);
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Synced', 'synced');
            }
            
            this.saveAllToLocalStorage(firebaseEmotions);
            
            try {
              localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
            } catch (e) {}
            
            InstantUI.updateDebugInfo(this.userId, Object.keys(firebaseEmotions).length, 'Firebase sync');
            
            return firebaseEmotions;
          } else {
            console.log('üî• –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Firebase –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', this.userId);
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('No data', 'synced');
            }
            return {};
          }
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Firebase:', error);
          if (InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Sync failed', 'offline');
          }
          return {};
        }
      }

      async saveEmotion(dateKey, emotion) {
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏: ${emotion} –¥–ª—è –¥–∞—Ç—ã: ${dateKey}`);
        
        const emotionData = {
          emotion: emotion,
          date: dateKey,
          timestamp: new Date(),
          userId: this.userId
        };

        this.saveToLocalStorage(dateKey, emotion);
        console.log('‚úÖ –≠–º–æ—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');

        if (this.isOnline && this.db && this.isFirebaseReady) {
          try {
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Saving...', 'syncing');
            }
            const docRef = this.db.collection('emotions').doc(`${this.userId}_${dateKey}`);
            await docRef.set(emotionData);
            console.log('‚úÖ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Firebase:', dateKey, emotion);
            
            if (InstantUI.isDebugMode()) {
              this.markDaySynced(dateKey);
              InstantUI.showSyncIndicator('Saved', 'synced');
            }
            
            try {
              localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
            } catch (e) {}
            
            return true;
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
            if (InstantUI.isDebugMode()) {
              this.markDaySyncing(dateKey);
              InstantUI.showSyncIndicator('Save failed', 'offline');
            }
            
            if (this.retryCount < this.maxRetries) {
              this.retryCount++;
              setTimeout(() => this.saveEmotion(dateKey, emotion), 5000);
            }
            
            return false;
          }
        } else {
          console.log('üíæ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ localStorage (–æ—Ñ–ª–∞–π–Ω):', dateKey, emotion);
          if (!this.isFirebaseReady && InstantUI.isDebugMode()) {
            InstantUI.showSyncIndicator('Saved locally', 'offline');
          }
          return true;
        }
      }

      async deleteEmotion(dateKey) {
        console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏ –¥–ª—è –¥–∞—Ç—ã: ${dateKey}`);
        
        this.removeFromLocalStorage(dateKey);
        console.log('‚úÖ –≠–º–æ—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ localStorage');

        if (this.isOnline && this.db && this.isFirebaseReady) {
          try {
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Deleting...', 'syncing');
            }
            const docRef = this.db.collection('emotions').doc(`${this.userId}_${dateKey}`);
            await docRef.delete();
            console.log('‚úÖ –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ Firebase:', dateKey);
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Deleted', 'synced');
            }
            return true;
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:', error);
            if (InstantUI.isDebugMode()) {
              InstantUI.showSyncIndicator('Delete failed', 'offline');
            }
            return false;
          }
        } else {
          console.log('üíæ –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ localStorage (–æ—Ñ–ª–∞–π–Ω):', dateKey);
          return true;
        }
      }

      isLocalStorageAvailable() {
        return InstantUI.isLocalStorageAvailable();
      }

      saveToLocalStorage(dateKey, emotion) {
        if (!this.isLocalStorageAvailable()) {
          console.log('‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }
        
        try {
          const currentData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          const emotions = currentData ? JSON.parse(currentData) : {};
          emotions[dateKey] = emotion;
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üíæ –≠–º–æ—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
          
          InstantUI.updateDebugInfo(this.userId, Object.keys(emotions).length, 'Local save');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
        }
      }

      removeFromLocalStorage(dateKey) {
        if (!this.isLocalStorageAvailable()) {
          console.log('‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
          return;
        }
        
        try {
          const currentData = localStorage.getItem(this.STORAGE_KEYS.EMOTIONS);
          const emotions = currentData ? JSON.parse(currentData) : {};
          delete emotions[dateKey];
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üóëÔ∏è –≠–º–æ—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ localStorage');
          
          InstantUI.updateDebugInfo(this.userId, Object.keys(emotions).length, 'Local delete');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ localStorage:', error);
        }
      }

      saveAllToLocalStorage(emotions) {
        if (!this.isLocalStorageAvailable()) {
          console.log('‚ö†Ô∏è localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }
        
        try {
          localStorage.setItem(this.STORAGE_KEYS.EMOTIONS, JSON.stringify(emotions));
          console.log('üíæ –í—Å–µ —ç–º–æ—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage:', Object.keys(emotions).length);
          InstantUI.updateDebugInfo(this.userId, Object.keys(emotions).length, 'Bulk save');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —ç–º–æ—Ü–∏–π –≤ localStorage:', error);
        }
      }

      markDaySyncing(dateKey) {
        if (!InstantUI.isDebugMode()) {
          return;
        }
        
        const dayElement = document.querySelector(`[data-date="${dateKey}"]`);
        if (dayElement) {
          dayElement.classList.remove('synced');
          dayElement.classList.add('syncing');
        }
      }

      markDaySynced(dateKey) {
        if (!InstantUI.isDebugMode()) {
          return;
        }
        
        const dayElement = document.querySelector(`[data-date="${dateKey}"]`);
        if (dayElement) {
          dayElement.classList.remove('syncing');
          dayElement.classList.add('synced');
          setTimeout(() => {
            dayElement.classList.remove('synced');
          }, 3000);
        }
      }
    }

    // Translations
    const translations = {
      en: {
        page_title: "Potok ‚Äî Mood Calendar",
        monday: "Mon",
        tuesday: "Tue", 
        wednesday: "Wed",
        thursday: "Thu",
        friday: "Fri",
        saturday: "Sat",
        sunday: "Sun",
        how_feeling: "How are you feeling?",
        emotion_joyful: "Joyful",
        emotion_good: "Good",
        emotion_so_so: "So-so",
        emotion_anxious: "Anxious", 
        emotion_sad: "Sad",
        emotion_bad: "Bad",
        tab_today: "Today",
        tab_practices: "Practices",
        tab_journal: "Calendar",
        january: "January",
        february: "February", 
        march: "March",
        april: "April",
        may: "May",
        june: "June",
        july: "July",
        august: "August",
        september: "September",
        october: "October",
        november: "November",
        december: "December",
        sunday_full: "SUNDAY",
        monday_full: "MONDAY",
        tuesday_full: "TUESDAY", 
        wednesday_full: "WEDNESDAY",
        thursday_full: "THURSDAY",
        friday_full: "FRIDAY",
        saturday_full: "SATURDAY"
      },
      ru: {
        page_title: "Potok ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è",
        monday: "–ü–Ω",
        tuesday: "–í—Ç",
        wednesday: "–°—Ä", 
        thursday: "–ß—Ç",
        friday: "–ü—Ç",
        saturday: "–°–±",
        sunday: "–í—Å",
        how_feeling: "–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?",
        emotion_joyful: "–†–∞–¥–æ—Å—Ç–Ω–æ",
        emotion_good: "–•–æ—Ä–æ—à–æ", 
        emotion_so_so: "–¢–∞–∫ —Å–µ–±–µ",
        emotion_anxious: "–¢—Ä–µ–≤–æ–∂–Ω–æ",
        emotion_sad: "–ì—Ä—É—Å—Ç–Ω–æ",
        emotion_bad: "–ü–ª–æ—Ö–æ",
        tab_today: "–°–µ–≥–æ–¥–Ω—è",
        tab_practices: "–ü—Ä–∞–∫—Ç–∏–∫–∏", 
        tab_journal: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å",
        january: "–Ø–Ω–≤–∞—Ä—å",
        february: "–§–µ–≤—Ä–∞–ª—å",
        march: "–ú–∞—Ä—Ç", 
        april: "–ê–ø—Ä–µ–ª—å",
        may: "–ú–∞–π",
        june: "–ò—é–Ω—å",
        july: "–ò—é–ª—å",
        august: "–ê–≤–≥—É—Å—Ç",
        september: "–°–µ–Ω—Ç—è–±—Ä—å",
        october: "–û–∫—Ç—è–±—Ä—å",
        november: "–ù–æ—è–±—Ä—å",
        december: "–î–µ–∫–∞–±—Ä—å",
        sunday_full: "–í–û–°–ö–†–ï–°–ï–ù–¨–ï",
        monday_full: "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", 
        tuesday_full: "–í–¢–û–†–ù–ò–ö",
        wednesday_full: "–°–†–ï–î–ê",
        thursday_full: "–ß–ï–¢–í–ï–†–ì",
        friday_full: "–ü–Ø–¢–ù–ò–¶–ê",
        saturday_full: "–°–£–ë–ë–û–¢–ê"
      }
    };

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (English)
    const calendarHeadersEn = [
      { title: "Mood Calendar", subtitle: "That doesn't ask why" },
      { title: "Mood Calendar", subtitle: "That sometimes gets tired too" },
      { title: "Mood Calendar", subtitle: "That's not resourceful but works" },
      { title: "Mood Calendar", subtitle: "That doesn't believe it works itself" },
      { title: "Mood Calendar", subtitle: "That pretends everything's going to plan" },
      { title: "Mood Calendar", subtitle: "That doesn't wait for explanations" },
      { title: "Mood Calendar", subtitle: "That doesn't demand honesty" },
      { title: "Mood Calendar", subtitle: "That doesn't judge" },
      { title: "Mood Calendar", subtitle: "That accepts any 'so-so'" },
      { title: "Mood Calendar", subtitle: "That's not afraid of silence" },
      { title: "Mood Calendar", subtitle: "That doesn't ask unnecessary questions" }
    ];

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (Russian)
    const calendarHeadersRu = [
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç, –ø–æ—á–µ–º—É" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –∏–Ω–æ–≥–¥–∞ —Ç–æ–∂–µ —É—Å—Ç–∞–µ—Ç" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –≤ —Ä–µ—Å—É—Ä—Å–µ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π —Å–∞–º –Ω–µ –≤–µ—Ä–∏—Ç, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –≤–∏–¥, —á—Ç–æ –≤—Å—ë –ø–æ –ø–ª–∞–Ω—É" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –∂–¥—ë—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–π" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —á–µ—Å—Ç–Ω–æ—Å—Ç–∏" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±–æ–µ ¬´so-so¬ª" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—É–≥–∞–µ—Ç—Å—è —Ç–∏—à–∏–Ω—ã" },
      { title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", subtitle: "–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–¥–∞—ë—Ç –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤" }
    ];

    // Calendar functionality with instant loading and timezone support
    class EmotionCalendar {
      constructor() {
        this.currentDate = DateUtils.getCurrentDateInUserTimezone();
        this.selectedDate = null;
        this.emotions = {};
        this.firebaseService = new FirebaseService();
        this.isLoading = false;
        
        this.initializeElements();
        this.setupEventListeners();
        this.updateCalendarHeader();
        
        this.loadEmotionsInstantly();
        this.renderCalendar();
      }

      initializeElements() {
        this.currentMonthElement = document.getElementById('currentMonth');
        this.daysGridElement = document.getElementById('daysGrid');
        this.emotionModal = document.getElementById('emotionModal');
        this.calendarTitle = document.getElementById('calendarTitle');
        this.calendarSubtitle = document.getElementById('calendarSubtitle');
        this.loadingText = document.getElementById('loadingText');
      }

      setupEventListeners() {
        document.getElementById('prevMonth').addEventListener('click', () => {
          this.currentDate.setMonth(this.currentDate.getMonth() - 1);
          this.renderCalendar();
          this.updateCalendarHeader();
          trackMonthNavigation('previous');
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
          this.currentDate.setMonth(this.currentDate.getMonth() + 1);
          this.renderCalendar();
          this.updateCalendarHeader();
          trackMonthNavigation('next');
        });

        this.emotionModal.addEventListener('click', (e) => {
          if (e.target === this.emotionModal) {
            this.closeModal();
          }
        });

        document.getElementById('closeModal').addEventListener('click', () => {
          this.closeModal();
        });

        document.querySelectorAll('.emotion-option').forEach(option => {
          option.addEventListener('click', () => {
            const emotion = option.dataset.emotion;
            this.setEmotion(emotion);
          });
        });
      }

      loadEmotionsInstantly() {
        console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ —ç–º–æ—Ü–∏–π...');
        this.emotions = this.firebaseService.loadEmotionsInstantly();
        const count = Object.keys(this.emotions).length;
        console.log(`‚úÖ –≠–º–æ—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é: ${count}`);
        return this.emotions;
      }

      async syncWithFirebase() {
        console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase –≤ —Ñ–æ–Ω–µ...');
        const firebaseEmotions = await this.firebaseService.syncWithFirebase();
        
        if (firebaseEmotions && Object.keys(firebaseEmotions).length > 0) {
          const newEmotions = { ...this.emotions, ...firebaseEmotions };
          
          const hasChanges = JSON.stringify(this.emotions) !== JSON.stringify(newEmotions);
          
          if (hasChanges) {
            console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
            this.emotions = newEmotions;
            this.renderCalendar();
            
            const count = Object.keys(this.emotions).length;
            InstantUI.updateDebugInfo(this.firebaseService.userId, count, 'Synced & updated');
          } else {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
          }
        }
      }

      getLocalizedMonthNames() {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        if (currentLang === 'en') {
          return [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
          ];
        } else {
          return [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
          ];
        }
      }

      getLocalizedDayNames() {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        if (currentLang === 'en') {
          return ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        } else {
          return ['–í–û–°–ö–†–ï–°–ï–ù–¨–ï', '–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö', '–í–¢–û–†–ù–ò–ö', '–°–†–ï–î–ê', '–ß–ï–¢–í–ï–†–ì', '–ü–Ø–¢–ù–ò–¶–ê', '–°–£–ë–ë–û–¢–ê'];
        }
      }

      getLocalizedMonthGenitiveNames() {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        if (currentLang === 'en') {
          return [
            'JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
            'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'
          ];
        } else {
          return [
            '–Ø–ù–í–ê–†–Ø', '–§–ï–í–†–ê–õ–Ø', '–ú–ê–†–¢–ê', '–ê–ü–†–ï–õ–Ø', '–ú–ê–Ø', '–ò–Æ–ù–Ø',
            '–ò–Æ–õ–Ø', '–ê–í–ì–£–°–¢–ê', '–°–ï–ù–¢–Ø–ë–†–Ø', '–û–ö–¢–Ø–ë–†–Ø', '–ù–û–Ø–ë–†–Ø', '–î–ï–ö–ê–ë–†–Ø'
          ];
        }
      }

      updateCalendarHeader() {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        const headers = currentLang === 'en' ? calendarHeadersEn : calendarHeadersRu;
        
        const headerIndex = Math.floor(Math.random() * headers.length);
        const header = headers[headerIndex];
        
        this.calendarTitle.textContent = header.title;
        this.calendarSubtitle.textContent = header.subtitle;
      }

      updateWeekdays() {
        const weekdayElements = document.querySelectorAll('.weekday[data-translate]');
        weekdayElements.forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = window.translator.translate(key);
          element.textContent = translation;
        });
      }

      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        const monthNames = this.getLocalizedMonthNames();
        this.currentMonthElement.textContent = `${monthNames[month]} ${year}`;

        this.daysGridElement.innerHTML = '';

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        let startOfWeek = firstDay.getDay();
        startOfWeek = startOfWeek === 0 ? 6 : startOfWeek - 1;

        // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ other-month)
        const prevMonth = new Date(year, month - 1, 0);
        for (let i = startOfWeek - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          const dayElement = this.createDayElement(day, true); // true = isOtherMonth
          this.daysGridElement.appendChild(dayElement);
        }

        // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = this.createDayElement(day, false); // false = —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
          this.daysGridElement.appendChild(dayElement);
        }

        // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ other-month)
        const totalCells = this.daysGridElement.children.length;
        const cellsNeeded = Math.ceil(totalCells / 7) * 7;
        for (let day = 1; totalCells + day - 1 < cellsNeeded; day++) {
          const dayElement = this.createDayElement(day, true); // true = isOtherMonth
          this.daysGridElement.appendChild(dayElement);
        }
      }

      createDayElement(day, isOtherMonth) {
        const dayElement = document.createElement('div');
        dayElement.className = 'day';
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: —ç–º–æ—Ü–∏—è —Å–≤–µ—Ä—Ö—É, –¥–∞—Ç–∞ —Å–Ω–∏–∑—É
        const emotionElement = document.createElement('div');
        emotionElement.className = 'day-emotion';
        
        const numberElement = document.createElement('div');
        numberElement.className = 'day-number';
        numberElement.textContent = day;
        
        dayElement.appendChild(emotionElement);
        dayElement.appendChild(numberElement);

        if (isOtherMonth) {
          dayElement.classList.add('other-month');
          return dayElement; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É –¥–ª—è –¥–Ω–µ–π –¥—Ä—É–≥–∏—Ö –º–µ—Å—è—Ü–µ–≤
        }

        const currentYear = this.currentDate.getFullYear();
        const currentMonth = this.currentDate.getMonth();
        const dayDate = new Date(currentYear, currentMonth, day);
        
        if (DateUtils.isTodayInUserTimezone(dayDate)) {
          dayElement.classList.add('today');
        }

        const today = DateUtils.getCurrentDateInUserTimezone();
        today.setHours(23, 59, 59, 999);
        dayDate.setHours(0, 0, 0, 0);
        
        const isFutureDate = dayDate > today;

        if (isFutureDate) {
          dayElement.classList.add('future-date');
          return dayElement;
        }

        const dateKey = `${currentYear}-${currentMonth}-${day}`;
        dayElement.setAttribute('data-date', dateKey);
        
        if (this.emotions[dateKey]) {
          dayElement.classList.add('has-emotion', `emotion-${this.emotions[dateKey]}`);
        }

        dayElement.addEventListener('click', () => {
          this.openModal(dateKey);
          trackModalOpen(dateKey);
        });

        return dayElement;
      }

      openModal(dateKey) {
        this.selectedDate = dateKey;
        
        const [year, month, day] = dateKey.split('-').map(Number);
        const date = new Date(year, month, day);
        const dateText = this.formatSelectedDate(date);
        document.getElementById('selectedDateText').textContent = dateText;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
        document.body.classList.add('modal-open');
        
        this.emotionModal.classList.add('active');
      }

      formatSelectedDate(date) {
        const currentLang = window.translator ? window.translator.currentLang : 'en';
        
        const dayNames = this.getLocalizedDayNames();
        const monthNames = this.getLocalizedMonthGenitiveNames();
        
        const dayName = dayNames[date.getDay()];
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        
        if (currentLang === 'en') {
          return `${dayName}, ${month} ${day}, ${year}`;
        } else {
          return `${dayName}, ${day} ${month} ${year} –ì.`;
        }
      }

      closeModal() {
        this.emotionModal.classList.remove('active');
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        document.body.classList.remove('modal-open');
        
        this.selectedDate = null;
      }

      async setEmotion(emotion) {
        if (!this.selectedDate || this.isLoading) return;
        
        this.isLoading = true;
        console.log(`üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç–º–æ—Ü–∏–∏: ${emotion} –¥–ª—è –¥–∞—Ç—ã: ${this.selectedDate}`);
        
        const isRemoving = this.emotions[this.selectedDate] === emotion;
        
        try {
          if (isRemoving) {
            delete this.emotions[this.selectedDate];
            await this.firebaseService.deleteEmotion(this.selectedDate);
            trackEmotionRemove(emotion, this.selectedDate);
            console.log(`üóëÔ∏è –≠–º–æ—Ü–∏—è ${emotion} —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è ${this.selectedDate}`);
          } else {
            this.emotions[this.selectedDate] = emotion;
            await this.firebaseService.saveEmotion(this.selectedDate, emotion);
            trackEmotionSet(emotion, this.selectedDate);
            console.log(`‚úÖ –≠–º–æ—Ü–∏—è ${emotion} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è ${this.selectedDate}`);
          }
          
          this.renderCalendar();
          this.closeModal();
          this.updateCalendarHeader();
          
          const count = Object.keys(this.emotions).length;
          InstantUI.updateDebugInfo(this.firebaseService.userId, count, 'Emotion set');
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —ç–º–æ—Ü–∏–∏:', error);
        } finally {
          this.isLoading = false;
        }
      }
    }

    // Translator class
    class Translator {
      constructor() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞ CALENDAR.HTML...');
        
        this.localStorageAvailable = this.checkLocalStorageAvailability();
        
        this.currentLang = this.getLanguageFromURL() || 
                          (this.localStorageAvailable ? this.getLanguageFromStorage() : null) || 
                          'en';
        
        console.log(`üåê –í—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: ${this.currentLang}`);
        
        this.init();
      }

      checkLocalStorageAvailability() {
        return InstantUI.isLocalStorageAvailable();
      }

      getLanguageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const langFromUrl = urlParams.get('lang');
        console.log(`üîó –Ø–∑—ã–∫ –∏–∑ URL: ${langFromUrl}`);
        return langFromUrl;
      }

      getLanguageFromStorage() {
        if (!this.localStorageAvailable) return null;
        
        try {
          const langFromStorage = localStorage.getItem('potok_language');
          console.log(`üíæ –Ø–∑—ã–∫ –∏–∑ localStorage: ${langFromStorage}`);
          return langFromStorage;
        } catch (error) {
          console.log(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage: ${error.message}`);
          return null;
        }
      }

      init() {
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        this.setupLanguageButtons();
        document.documentElement.lang = this.currentLang;
        
        console.log(`‚úÖ –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ CALENDAR.HTML –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —è–∑—ã–∫–æ–º: ${this.currentLang}`);
      }

      setupLanguageButtons() {
        document.getElementById('enBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ EN –≤ CALENDAR.HTML');
          this.setLanguage('en');
        });
        
        document.getElementById('ruBtn')?.addEventListener('click', () => {
          console.log('üîò –ö–ª–∏–∫ –ø–æ RU –≤ CALENDAR.HTML');
          this.setLanguage('ru');
        });
      }

      setLanguage(lang) {
        console.log(`üîÑ –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ –Ω–∞: ${lang} –≤ CALENDAR.HTML`);
        
        this.currentLang = lang;
        
        if (this.localStorageAvailable) {
          try {
            localStorage.setItem('potok_language', lang);
            console.log(`‚úÖ –Ø–∑—ã–∫ ${lang} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage`);
          } catch (error) {
            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage: ${error.message}`);
          }
        }
        
        try {
          const newUrl = `${window.location.pathname}?lang=${lang}`;
          window.history.replaceState({}, '', newUrl);
          console.log(`‚úÖ URL –æ–±–Ω–æ–≤–ª–µ–Ω: ${newUrl}`);
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL: ${error.message}`);
        }
        
        this.updatePage();
        this.updateLanguageButtons();
        this.updatePageLinks();
        
        if (window.calendar) {
          window.calendar.updateCalendarHeader();
          window.calendar.renderCalendar();
          window.calendar.updateWeekdays();
        }
        
        document.documentElement.lang = lang;
        
        console.log(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${lang} –≤ CALENDAR.HTML`);
      }

      updatePageLinks() {
        const links = document.querySelectorAll('a[href$=".html"], a[href*=".html"]');
        let updateCount = 0;
        
        links.forEach(link => {
          let href = link.getAttribute('href');
          
          if (href.startsWith('http') || href.startsWith('//')) return;
          
          if (href.includes('?lang=')) {
            href = href.split('?')[0];
          }
          
          if (href.includes('#')) {
            const parts = href.split('#');
            href = parts[0];
          }
          
          const separator = href.includes('?') ? '&' : '?';
          const newHref = `${href}${separator}lang=${this.currentLang}`;
          link.setAttribute('href', newHref);
          updateCount++;
        });
        
        console.log(`üîó –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updateCount} —Å—Å—ã–ª–æ–∫ —Å lang=${this.currentLang} –≤ CALENDAR.HTML`);
      }

      translate(key) {
        return translations[this.currentLang]?.[key] || translations.en[key] || key;
      }

      updatePage() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          const translation = this.translate(key);
          
          if (element.tagName === 'TITLE') {
            element.textContent = translation;
          } else {
            element.textContent = translation;
          }
        });
        
        console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${document.querySelectorAll('[data-translate]').length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞`);
      }

      updateLanguageButtons() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase() === this.currentLang) {
            btn.classList.add('active');
            btn.style.background = 'linear-gradient(135deg, #FFD527 8%, #34A853 85%, #4285F4 98%)';
          } else {
            btn.style.background = '';
          }
        });
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è Calendar.html');
      
      if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
        console.log('üì± Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const isDebugMode = urlParams.get('debug') === '1';
      
      if (isDebugMode) {
        console.log('üêõ Debug —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω');
        document.body.classList.add('debug-mode');
        
        const debugPanel = document.getElementById('debugPanel');
        if (debugPanel) {
          debugPanel.classList.add('show');
        }
      } else {
        console.log('üë§ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º');
      }
      
      window.translator = new Translator();
      window.calendar = new EmotionCalendar();
      
      console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —ç–º–æ—Ü–∏—è–º–∏');
    });
  </script>
</body>
</html>